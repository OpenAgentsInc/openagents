#!/bin/bash
# Pre-commit hook for OpenAgents
# Runs fast unit tests and checks for uncommitted snapshot changes

echo "ğŸ” Running pre-commit checks..."

# Check if commit message references issues
COMMIT_MSG_FILE="$1"
if [ -f "$COMMIT_MSG_FILE" ]; then
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

    # Extract issue numbers (#NNN pattern)
    ISSUE_NUMS=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | sed 's/#//')

    if [ -n "$ISSUE_NUMS" ]; then
        echo "ğŸ“ Checking referenced issues..."
        for ISSUE_NUM in $ISSUE_NUMS; do
            # Try to get issue status
            if command -v cargo autopilot &> /dev/null; then
                ISSUE_INFO=$(cargo autopilot issue get "$ISSUE_NUM" 2>&1)

                if echo "$ISSUE_INFO" | grep -q "not found"; then
                    echo "âš ï¸  Warning: Issue #$ISSUE_NUM not found"
                elif echo "$ISSUE_INFO" | grep -q "status.*done"; then
                    echo "âš ï¸  Warning: Issue #$ISSUE_NUM is already complete"
                elif echo "$ISSUE_INFO" | grep -q "claimed_by.*null"; then
                    echo "ğŸ’¡ Tip: Consider claiming issue #$ISSUE_NUM before committing"
                fi
            fi
        done
    fi
fi

# Run fast unit tests
echo "Running unit tests..."
if ! cargo test --workspace --lib -- --test-threads=4; then
    echo "âŒ Unit tests failed. Fix the failures before committing."
    exit 1
fi

# Check for snapshot changes
echo "Checking for snapshot changes..."
if cargo insta test --review=fail 2>&1 | grep -q "pending"; then
    echo "âŒ ERROR: Uncommitted snapshot changes detected."
    echo "   Run 'cargo insta review' to review and accept/reject changes."
    exit 1
fi

echo "âœ… All pre-commit checks passed!"
exit 0
