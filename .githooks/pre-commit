#!/bin/bash
# Pre-commit hook for OpenAgents
# Runs fast unit tests and checks for uncommitted snapshot changes

echo "üîç Running pre-commit checks..."

# Check for stub patterns (d-012)
echo "Checking for stub patterns..."
if ! scripts/check-stubs.sh --staged; then
    echo "‚ùå Stub patterns detected. Fix before committing."
    exit 1
fi

# Check if commit message references issues
COMMIT_MSG_FILE="$1"
if [ -f "$COMMIT_MSG_FILE" ]; then
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

    # Extract issue numbers (#NNN pattern)
    ISSUE_NUMS=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | sed 's/#//')

    if [ -n "$ISSUE_NUMS" ]; then
        echo "üìù Checking referenced issues..."
        for ISSUE_NUM in $ISSUE_NUMS; do
            # Try to get issue status
            if command -v cargo autopilot &> /dev/null; then
                ISSUE_INFO=$(cargo autopilot issue get "$ISSUE_NUM" 2>&1)

                if echo "$ISSUE_INFO" | grep -q "not found"; then
                    echo "‚ö†Ô∏è  Warning: Issue #$ISSUE_NUM not found"
                elif echo "$ISSUE_INFO" | grep -q "status.*done"; then
                    echo "‚ö†Ô∏è  Warning: Issue #$ISSUE_NUM is already complete"
                elif echo "$ISSUE_INFO" | grep -q "claimed_by.*null"; then
                    echo "üí° Tip: Consider claiming issue #$ISSUE_NUM before committing"
                fi
            fi
        done
    fi
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0
