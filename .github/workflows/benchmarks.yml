name: Autopilot Benchmarks

on:
  pull_request:
    branches: [main]
    paths:
      - 'crates/autopilot/**'
      - '.github/workflows/benchmarks.yml'
  push:
    branches: [main]
    paths:
      - 'crates/autopilot/**'
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git comparisons

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Build autopilot
        run: cargo build --release -p autopilot

      - name: Run benchmark suite
        id: benchmarks
        run: |
          # Run benchmarks and save results
          cargo run --release -p autopilot -- benchmark \
            --save-baseline ci-${{ github.sha }} \
            --db benchmarks/ci-results.db

      - name: Compare with baseline (PR only)
        if: github.event_name == 'pull_request'
        run: |
          # Checkout main branch to get baseline
          git fetch origin main:main
          git checkout main
          cargo build --release -p autopilot

          # Run benchmarks on main
          cargo run --release -p autopilot -- benchmark \
            --save-baseline ci-main \
            --db benchmarks/main-results.db

          # Switch back to PR branch
          git checkout -

          # Compare results
          echo "## Benchmark Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # TODO: Implement comparison logic and fail if regression > 10%
          # For now, just show that benchmarks ran
          echo "âœ… Benchmark suite completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Detailed comparison coming soon - tracking in issue #753" >> $GITHUB_STEP_SUMMARY

      - name: Update baseline (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Store baseline results
          mkdir -p benchmarks/baselines
          cp benchmarks/ci-results.db benchmarks/baselines/main-$(git rev-parse --short HEAD).db

          echo "Baseline updated for commit $(git rev-parse --short HEAD)" >> $GITHUB_STEP_SUMMARY

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: |
            benchmarks/*.db
            benchmarks/baselines/
          retention-days: 30
