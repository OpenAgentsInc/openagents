name: Release oa-bridge binaries

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  macos:
    name: macOS ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-13, macos-14]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build (release)
        run: cargo build --release -p oa-bridge
      - name: Package artifact
        run: |
          set -euxo pipefail
          cd target/release
          BIN=oa-bridge
          if [ '${{ matrix.os }}' = 'macos-14' ]; then
            NAME=oa-bridge-aarch64-apple-darwin.zip
          else
            NAME=oa-bridge-x86_64-apple-darwin.zip
          fi
          zip -9 ${NAME} ${BIN}
          echo "ASSET_PATH=$(pwd)/${NAME}" >> $GITHUB_ENV
      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_PATH }}

  linux-amd64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build (release)
        run: cargo build --release -p oa-bridge
      - name: Package artifact
        run: |
          set -euxo pipefail
          cd target/release
          BIN=oa-bridge
          NAME=oa-bridge-x86_64-unknown-linux-gnu.zip
          zip -9 ${NAME} ${BIN}
          echo "ASSET_PATH=$(pwd)/${NAME}" >> $GITHUB_ENV
      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_PATH }}

  linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross
      - name: Build (aarch64-unknown-linux-gnu)
        run: cross build --release -p oa-bridge --target aarch64-unknown-linux-gnu
      - name: Package artifact
        run: |
          set -euxo pipefail
          cd target/aarch64-unknown-linux-gnu/release
          BIN=oa-bridge
          NAME=oa-bridge-aarch64-unknown-linux-gnu.zip
          zip -9 ${NAME} ${BIN}
          echo "ASSET_PATH=$(pwd)/${NAME}" >> $GITHUB_ENV
      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_PATH }}

  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build (release)
        run: cargo build --release -p oa-bridge
      - name: Package artifact
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $Bin = Join-Path target\release oa-bridge.exe
          $Name = 'oa-bridge-x86_64-pc-windows-msvc.zip'
          Compress-Archive -Path $Bin -DestinationPath $Name -Force
          echo "ASSET_PATH=$PWD\$Name" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_PATH }}
