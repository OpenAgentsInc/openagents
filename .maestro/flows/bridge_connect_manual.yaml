appId: com.openagents.app
name: Bridge Connect (Manual Host/Token)
---
- launchApp
- openLink: "${EXP_URL}"
# Try to land on a screen that shows the header
- openLink: "${EXP_URL}/--/thread/new"
# Try drawer first if header is visible
- runFlow:
    when:
      visible:
        id: header-menu-button
    commands:
      - tapOn:
          id: header-menu-button
      - extendedWaitUntil:
          visible:
            id: drawer-settings
          timeout: 30000
      - tapOn:
          id: drawer-settings
# If header wasn't visible, try direct route to Settings then drawer
- runFlow:
    when:
      notVisible:
        id: header-menu-button
    commands:
      - openLink: "${EXP_URL}/--/settings"
      - runFlow:
          when:
            notVisible:
              id: settings-root
          commands:
            - openLink: "${EXP_URL}"
            - openLink: "${EXP_URL}/--/thread/new"
            - extendedWaitUntil:
                visible:
                  id: header-menu-button
                timeout: 60000
            - tapOn:
                id: header-menu-button
            - extendedWaitUntil:
                visible:
                  id: drawer-settings
                timeout: 30000
            - tapOn:
                id: drawer-settings
# If pill still not visible, deep-link to settings
- runFlow:
    when:
      notVisible:
        id: settings-root
    commands:
      - openLink: "${EXP_URL}/--/settings"
# Wait for pill (after whichever path succeeded)
- extendedWaitUntil:
    visible:
      id: settings-root
    timeout: 90000
# If somehow still not visible, try drawer again
- runFlow:
    when:
      notVisible:
        id: settings-root
    commands:
      - runFlow:
          when:
            visible:
              id: header-menu-button
          commands:
            - tapOn:
                id: header-menu-button
            - extendedWaitUntil:
                visible:
                  id: drawer-settings
                timeout: 30000
            - tapOn:
                id: drawer-settings
      - extendedWaitUntil:
          visible:
            id: settings-root
          timeout: 90000
# Fill host and token (from user-provided bridge)
- tapOn:
    id: settings-host-input
- inputText:
    id: settings-host-input
    text: "${BRIDGE_HOST}"
- tapOn:
    id: settings-token-input
- inputText:
    id: settings-token-input
    text: "${BRIDGE_TOKEN}"
- tapOn:
    id: settings-apply
- runFlow:
    when:
      visible:
        id: settings-connect
    commands:
      - tapOn:
          id: settings-connect
# Accept either Connected pill or header indicator as success
- extendedWaitUntil:
    visible:
      id: header-connection-indicator
    timeout: 120000
