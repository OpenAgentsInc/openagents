appId: com.openagents.app
name: Bridge â†’ Disconnect via Settings
---
- launchApp
- openLink: "exp://localhost:8081"
# Warm header-visible route and try drawer path first
- openLink: "exp://localhost:8081/--/thread/new"
- runFlow:
    when:
      visible:
        id: header-menu-button
    commands:
      - tapOn:
          id: header-menu-button
      - extendedWaitUntil:
          visible:
            id: drawer-settings
          timeout: 30000
      - tapOn:
          id: drawer-settings
# If Dev Quick Connect is available, use it to quickly connect
- runFlow:
    when:
      visible:
        id: settings-dev-quick
    commands:
      - tapOn:
          id: settings-dev-quick
      - extendedWaitUntil:
          visible:
            id: header-connection-indicator
          timeout: 120000
# Otherwise, deep-link to Settings and manually enter using Maestro env
- runFlow:
    when:
      notVisible:
        id: header-connection-indicator
    commands:
      - runFlow:
          when:
            notVisible:
              id: settings-host-input
          commands:
            - openLink: "exp://localhost:8081/--/settings"
            - extendedWaitUntil:
                visible:
                  id: settings-host-input
                timeout: 90000
      - runFlow:
          when:
            visible:
              id: settings-host-input
          commands:
            - tapOn:
                id: settings-host-input
            - inputText:
                id: settings-host-input
                text: "${BRIDGE_HOST}"
            - tapOn:
                id: settings-token-input
            - inputText:
                id: settings-token-input
                text: "${BRIDGE_TOKEN}"
            - tapOn:
                id: settings-apply
            - runFlow:
                when:
                  visible:
                    id: settings-connect
                commands:
                  - tapOn:
                      id: settings-connect
      - extendedWaitUntil:
          visible:
            id: header-connection-indicator
          timeout: 120000
# Disconnect and assert pill text
- tapOn:
    id: settings-disconnect
- extendedWaitUntil:
    visible:
      text: Disconnected
    timeout: 60000
