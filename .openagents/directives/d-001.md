---
id: d-001
title: Integrate Breez Spark SDK for Bitcoin Payments
status: active
priority: high
created: 2025-12-20
updated: 2025-12-20
---

## Goal

Fully integrate the Breez Spark SDK from `~/code/spark-sdk/` into OpenAgents as `crates/spark/`. This provides self-custodial Bitcoin payments via Lightning, Spark Layer 2, and on-chain with a unified identity system sharing the BIP32 seed phrase with Nostr via NIP-06.

## Background

The Spark SDK is a nodeless, self-custodial solution for Bitcoin/Lightning payments. It uses:
- **FROST threshold signatures** for security
- **Spark operators** for Layer 2 transfers
- **BIP32/39** for key derivation (compatible with NIP-06 unified identity)
- **LNURL** for Lightning interoperability

Source: `~/code/spark-sdk/` (workspace with breez-sdk, spark, spark-wallet crates)

## Architecture

```
                    BIP39 Mnemonic (12/24 words)
                              |
        +---------------------+---------------------+
        |                                           |
   m/44'/1237'/0'/0/0                        m/44'/0'/0'/0/0
   (NIP-06 Nostr)                            (BIP44 Bitcoin)
        |                                           |
   Nostr Keypair                             Spark Signer
   (crates/nostr/core)                       (crates/spark)
        |                                           |
        +---------------------+---------------------+
                              |
                      UnifiedIdentity
                   (crates/compute/domain)
```

## Success Criteria

### Phase 1: Core Integration
- [ ] Create `crates/spark/` as a thin wrapper around spark-sdk
- [ ] Add Breez spark-wallet dependency from crates.io or GitHub
- [ ] Implement `SparkSigner` trait using mnemonic from UnifiedIdentity
- [ ] Add `spark_signer` and `spark_wallet` fields to UnifiedIdentity
- [ ] Fill in TODO placeholders in `crates/compute/src/domain/identity.rs`

### Phase 2: Wallet Operations
- [ ] `get_balance()` - Spark + Lightning + on-chain balances
- [ ] `get_spark_address()` - Generate SparkAddress for receiving
- [ ] `sync_wallet()` - Force sync with operators
- [ ] `get_info()` - Wallet status and configuration

### Phase 3: Payment Methods
- [ ] **Lightning**: Send/receive BOLT-11 invoices
- [ ] **Spark**: Send/receive via SparkAddress
- [ ] **On-chain**: Deposit and withdrawal (cooperative exit)
- [ ] **LNURL**: Pay and withdraw support
- [ ] Payment history with filters

### Phase 4: Token Support (BTKN)
- [ ] Issue Spark tokens
- [ ] Send/receive tokens
- [ ] Token metadata and balance queries

### Phase 5: Multi-Network
- [ ] Mainnet support (production)
- [ ] Testnet support (testing)
- [ ] Signet support (staging)
- [ ] Regtest support (local dev)

### Phase 6: Agent Integration
- [ ] Expose payment tools via MCP (like issue tools)
- [ ] Add payment commands to autopilot CLI
- [ ] Event streaming for real-time payment updates
- [ ] Desktop UI payment components

## Key Files to Create/Modify

| File | Purpose |
|------|---------|
| `crates/spark/Cargo.toml` | **NEW** - Workspace crate with spark-wallet dependency |
| `crates/spark/src/lib.rs` | **NEW** - Public API exports |
| `crates/spark/src/wallet.rs` | **NEW** - SparkWallet wrapper |
| `crates/spark/src/signer.rs` | **NEW** - Mnemonic-based signer |
| `crates/spark/src/config.rs` | **NEW** - Network and API configuration |
| `crates/spark/src/error.rs` | **NEW** - Error types |
| `crates/compute/src/domain/identity.rs` | Add spark_signer integration |
| `crates/compute/src/state.rs` | Wire up spark_address signal |
| `Cargo.toml` | Add spark to workspace members |

## Dependencies

External (from Breez via crates.io/GitHub):
- `spark-wallet` - High-level wallet abstraction
- `spark` - Core protocol implementation
- `breez-sdk-core` - Breez SDK wrapper (optional, for LNURL)

Internal:
- `nostr` (crates/nostr/core) - NIP-06 key derivation
- `bip39` - Mnemonic parsing
- `bitcoin` - secp256k1 operations

## Configuration

```rust
pub struct SparkConfig {
    pub network: Network,           // Mainnet, Testnet, Signet, Regtest
    pub api_key: Option<String>,    // For Breez services (optional)
    pub storage_dir: PathBuf,       // Wallet persistence
    pub sync_interval: Duration,    // Auto-sync frequency
    pub spark_mode: SparkMode,      // Private or public addresses
}
```

## Testing Strategy

1. **Unit tests** in `crates/spark/src/` for each module
2. **Integration tests** using regtest network
3. **Verify NIP-06 + Spark derivation** produces expected keys from same mnemonic
4. **Payment flow tests** - send/receive on regtest
5. **Multi-device sync** verification

## Security Considerations

- Mnemonic stored in memory only (not persisted by spark crate)
- All signing operations use FROST threshold signatures
- Private keys never leave the device
- Cooperative exit allows on-chain recovery anytime
- Same security model as NIP-06 (user controls seed phrase)

## Notes

The Spark SDK at `~/code/spark-sdk/` is a clone of Breez's official repo, used purely as a reference for understanding their implementation. We do NOT fork it.

For integration:
1. Use their published crates from crates.io or GitHub as remote dependencies
2. Write our own wrapper code in `crates/spark/` that interfaces with their SDK
3. Any custom functionality we need should be implemented in our own crate

This follows the same pattern as other SDK integrations in the codebase.

## IMPORTANT: Verification Required

Do NOT mark this directive or its issues as complete unless:

1. `breez-sdk-spark` is added as a dependency in `crates/spark/Cargo.toml`
2. `SparkWallet` actually calls the SDK's `BreezSdk::connect()`
3. Balance, send, receive functions return REAL data from the SDK
4. Integration tests pass with a regtest/testnet connection
5. CLI commands actually work (not just return error messages)

**Reference SDK location**: `~/code/spark-sdk/`
- See `crates/breez-sdk/core/src/sdk.rs` for the public API
- See `docs/breez-sdk/snippets/rust/src/` for usage examples

The current implementation is PHASE 1 ONLY (signer created).
Phase 2-6 are NOT implemented - do not claim they are.
