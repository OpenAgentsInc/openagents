---
id: d-002
title: Implement 100% of Nostr Protocol
status: active
priority: high
created: 2025-12-20
updated: 2025-12-20
---

## Goal

Fully implement the Nostr protocol in Rust for both client and relay functionality, covering all 94 NIPs. Build from scratch using our own implementation in `crates/nostr/` rather than depending on external libraries.

## Background

Nostr (Notes and Other Stuff Transmitted by Relays) is a simple, open protocol for decentralized social networking. The protocol is defined by NIPs (Nostr Implementation Possibilities) located at `~/code/nips/`.

Current state:
- `crates/nostr/core` has 5 NIPs implemented (NIP-01, NIP-04, NIP-06, NIP-19, NIP-44)
- No relay implementation exists
- Client functionality is partial

Reference implementations (for study, not dependency):
- `~/code/nostr` - rust-nostr library
- `~/code/nostr-rs-relay` - Rust relay implementation

## Architecture

```
crates/nostr/
├── core/           → Protocol types, events, signing (existing)
├── client/         → NEW - Full Nostr client
├── relay/          → NEW - Complete relay implementation
└── sdk/            → NEW - High-level SDK for apps
```

### Relay Architecture (inspired by nostr-rs-relay)

```
┌─────────────────────────────────────────────────────────┐
│                    WebSocket Server                      │
│                    (warp + tokio-tungstenite)           │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────┐
│                  Connection Manager                      │
│            Per-client state, subscription tracking       │
└────────────────────────┬────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         ▼               ▼               ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   Writer    │  │   Reader    │  │  Metadata   │
│    Pool     │  │    Pool     │  │    Pool     │
│  (SQLite)   │  │  (SQLite)   │  │  (SQLite)   │
└─────────────┘  └─────────────┘  └─────────────┘
         │               │               │
         └───────────────┼───────────────┘
                         ▼
              ┌─────────────────┐
              │  Broadcast Bus  │
              │   (channels)    │
              └─────────────────┘
```

## Success Criteria

### Phase 1: Core Protocol (Foundation)
- [ ] NIP-01: Basic protocol flow - events, subscriptions, filters
- [ ] NIP-02: Contact List and Petnames
- [ ] NIP-05: Mapping Nostr keys to DNS identifiers
- [ ] NIP-10: Text note conventions (replies, mentions, threads)
- [ ] NIP-11: Relay information document
- [ ] NIP-13: Proof of Work
- [ ] NIP-15: Nostr Marketplace
- [ ] NIP-18: Reposts
- [ ] NIP-19: bech32-encoded entities (npub, nsec, note, etc.)
- [ ] NIP-21: nostr: URI scheme
- [ ] NIP-23: Long-form Content
- [ ] NIP-25: Reactions
- [ ] NIP-27: Text Note References
- [ ] NIP-36: Sensitive Content
- [ ] NIP-40: Expiration Timestamp

### Phase 2: Identity & Encryption
- [ ] NIP-04: Encrypted Direct Messages (legacy)
- [ ] NIP-06: Basic key derivation from mnemonic (BIP39 → NIP-06)
- [ ] NIP-07: window.nostr capability for web clients
- [ ] NIP-17: Private Direct Messages
- [ ] NIP-26: Delegated Event Signing
- [ ] NIP-44: Versioned Encryption
- [ ] NIP-46: Nostr Remote Signing (Nostr Connect)
- [ ] NIP-49: Private Key Encryption

### Phase 3: Media & Files
- [ ] NIP-94: File Metadata
- [ ] NIP-95: Storage on Relays (deprecated but reference)
- [ ] NIP-96: HTTP File Storage Integration
- [ ] NIP-98: HTTP Auth

### Phase 4: Relay Features
- [ ] NIP-09: Event Deletion
- [ ] NIP-12: Generic Tag Queries
- [ ] NIP-16: Event Treatment (ephemeral, replaceable)
- [ ] NIP-20: Command Results
- [ ] NIP-22: Event created_at Limits
- [ ] NIP-28: Public Chat
- [ ] NIP-33: Parameterized Replaceable Events
- [ ] NIP-42: Authentication of clients to relays
- [ ] NIP-45: Counting results
- [ ] NIP-50: Search Capability
- [ ] NIP-56: Reporting
- [ ] NIP-65: Relay List Metadata
- [ ] NIP-70: Protected Events

### Phase 5: Applications
- [ ] NIP-38: User Statuses
- [ ] NIP-47: Nostr Wallet Connect (NWC)
- [ ] NIP-51: Lists
- [ ] NIP-52: Calendar Events
- [ ] NIP-53: Live Activities
- [ ] NIP-54: Wiki
- [ ] NIP-55: Android Signer Application
- [ ] NIP-57: Lightning Zaps
- [ ] NIP-58: Badges
- [ ] NIP-59: Gift Wrap
- [ ] NIP-60: Cashu Wallet
- [ ] NIP-61: Nutzaps
- [ ] NIP-64: Chess (PGN)
- [ ] NIP-68: Picture-first feeds
- [ ] NIP-69: Peer-to-peer Order events
- [ ] NIP-71: Video Events
- [ ] NIP-72: Moderated Communities
- [ ] NIP-73: External Content IDs
- [ ] NIP-75: Zap Goals
- [ ] NIP-78: Application-specific data
- [ ] NIP-84: Highlights
- [ ] NIP-89: Recommended Application Handlers
- [ ] NIP-90: Data Vending Machines (DVMs)
- [ ] NIP-92: Media Attachments
- [ ] NIP-99: Classified Listings

### Phase 6: Advanced Features
- [ ] NIP-24: Extra metadata fields
- [ ] NIP-29: Relay-based Groups
- [ ] NIP-30: Custom Emoji
- [ ] NIP-31: Alt tag for unknown events
- [ ] NIP-32: Labeling
- [ ] NIP-34: git stuff
- [ ] NIP-35: Torrents
- [ ] NIP-37: Drafts
- [ ] NIP-39: External Identities
- [ ] NIP-48: Proxy Tags
- [ ] NIP-C7: Chats

### Phase 7: Relay Implementation
- [ ] SQLite storage with connection pooling (writer/reader/metadata pools)
- [ ] WebSocket server with proper connection handling
- [ ] Subscription management with efficient filtering
- [ ] Event validation and signature verification
- [ ] Rate limiting and spam protection
- [ ] Broadcast system for real-time updates
- [ ] NIP-11 relay information endpoint
- [ ] Admin interface and metrics

### Phase 8: Client Implementation
- [ ] Relay connection management (connect, reconnect, health)
- [ ] Event publishing with confirmation
- [ ] Subscription management (subscribe, unsubscribe, filter)
- [ ] Local event cache
- [ ] Outbox model for relay selection
- [ ] Contact list sync
- [ ] Message queue for offline support

## Key Files to Create/Modify

| File | Purpose |
|------|---------|
| `crates/nostr/client/Cargo.toml` | NEW - Client crate manifest |
| `crates/nostr/client/src/lib.rs` | NEW - Client public API |
| `crates/nostr/client/src/relay.rs` | NEW - Single relay connection |
| `crates/nostr/client/src/pool.rs` | NEW - Multi-relay management |
| `crates/nostr/client/src/subscription.rs` | NEW - Subscription handling |
| `crates/nostr/relay/Cargo.toml` | NEW - Relay crate manifest |
| `crates/nostr/relay/src/lib.rs` | NEW - Relay public API |
| `crates/nostr/relay/src/server.rs` | NEW - WebSocket server |
| `crates/nostr/relay/src/db.rs` | NEW - SQLite storage |
| `crates/nostr/relay/src/subscription.rs` | NEW - Subscription engine |
| `crates/nostr/relay/src/broadcast.rs` | NEW - Event broadcast system |
| `crates/nostr/core/src/nips/` | Expand with all NIP implementations |
| `Cargo.toml` | Add workspace members |

## Dependencies

```toml
# Core
tokio = { version = "1", features = ["full"] }
tokio-tungstenite = "0.21"  # WebSocket
warp = "0.3"                 # HTTP server
rusqlite = { version = "0.31", features = ["bundled"] }

# Crypto
secp256k1 = { version = "0.29", features = ["global-context"] }
chacha20poly1305 = "0.10"    # NIP-44
sha2 = "0.10"

# Serialization
serde = { version = "1", features = ["derive"] }
serde_json = "1"
```

## Testing Strategy

1. **Protocol tests** - Parse and validate all example events from NIPs
2. **Integration tests** - Client-relay communication
3. **Compatibility tests** - Connect to public relays, verify behavior
4. **Stress tests** - High connection count, event throughput
5. **Fuzz tests** - Invalid events, malformed messages

## Notes

Reference `~/code/nips/` for official NIP specifications. Use `~/code/nostr` and `~/code/nostr-rs-relay` as implementation references but build our own from scratch for:

1. Full control over implementation details
2. Optimized for our specific use cases (DVM, agent communication)
3. Tight integration with UnifiedIdentity and Spark
4. No external library version constraints

Priority NIPs for OpenAgents:
- NIP-90 (DVMs) - Core to our agent architecture
- NIP-47 (NWC) - Wallet integration
- NIP-57 (Zaps) - Payment integration
- NIP-46 (Nostr Connect) - Remote signing
