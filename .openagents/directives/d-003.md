---
id: d-003
title: OpenAgents Wallet - Complete Identity & Payment Solution
status: active
priority: high
created: 2025-12-20
updated: 2025-12-25T14:20:56Z
---

## Goal

Create a standalone, 100% feature-complete wallet application in `crates/wallet/` that unifies Nostr identity and Bitcoin payments. Runnable as `cargo wallet` with both CLI and GUI interfaces.

## Background

The OpenAgents wallet combines two key systems:
1. **Nostr Identity** - NIP-06 key derivation, profile management, contact sync
2. **Bitcoin Wallet** - Spark L2, Lightning, on-chain via Breez SDK

Both share a single BIP39 mnemonic, creating unified identity across social and financial layers.

## Architecture

```
crates/wallet/
├── Cargo.toml          → Binary crate with CLI + GUI
├── src/
│   ├── main.rs         → Entry point, CLI dispatcher
│   ├── cli/            → Command-line interface
│   │   ├── mod.rs
│   │   ├── identity.rs → Nostr identity commands
│   │   ├── bitcoin.rs  → Bitcoin/Lightning commands
│   │   └── settings.rs → Wallet configuration
│   ├── gui/            → Desktop UI (WGPUI app shell)
│   │   ├── mod.rs
│   │   ├── app.rs      → Main window
│   │   └── views/      → UI components
│   ├── core/           → Shared wallet logic
│   │   ├── mod.rs
│   │   ├── identity.rs → UnifiedIdentity wrapper
│   │   ├── nostr.rs    → Nostr profile/contacts
│   │   ├── spark.rs    → Spark wallet wrapper
│   │   └── sync.rs     → Cross-device sync
│   └── storage/        → Local persistence
│       ├── mod.rs
│       ├── keychain.rs → Secure key storage
│       └── db.rs       → SQLite for history
```

### Unified Identity Flow

```
                     BIP39 Mnemonic
                           │
           ┌───────────────┴───────────────┐
           ▼                               ▼
    m/44'/1237'/0'/0/0              m/44'/0'/0'/0/0
    (NIP-06 Nostr)                  (BIP44 Bitcoin)
           │                               │
           ▼                               ▼
    ┌─────────────┐                ┌─────────────┐
    │   Nostr     │                │   Spark     │
    │  Keypair    │                │   Wallet    │
    └─────────────┘                └─────────────┘
           │                               │
           └───────────────┬───────────────┘
                           ▼
                  ┌─────────────────┐
                  │ OpenAgents      │
                  │ Wallet App      │
                  └─────────────────┘
```

## Success Criteria

### Phase 1: Core Wallet Infrastructure
- [ ] Create `crates/wallet/` with proper Cargo.toml
- [ ] Add binary entry point with clap CLI
- [ ] Implement secure mnemonic generation (BIP39)
- [ ] Implement mnemonic import/export
- [ ] Platform keychain integration (macOS Keychain, Secret Service)
- [ ] SQLite database for history and metadata
- [ ] Basic configuration file support

### Phase 2: Nostr Identity
- [ ] NIP-06 key derivation from mnemonic
- [ ] Generate npub/nsec from seed
- [ ] Profile management (kind:0 metadata)
- [ ] Contact list sync (kind:3)
- [ ] Relay list management (NIP-65)
- [ ] Connect to relays and publish events
- [ ] Read and display feed
- [ ] Send and receive direct messages (NIP-17)
- [ ] Display notifications

### Phase 3: Bitcoin/Lightning Wallet
- [ ] Initialize Spark wallet from same mnemonic
- [ ] Display balance (Spark + Lightning + on-chain)
- [ ] Generate receiving address (SparkAddress)
- [ ] Send to SparkAddress
- [ ] Generate Lightning invoice (BOLT-11)
- [ ] Pay Lightning invoice
- [ ] LNURL-pay and LNURL-withdraw
- [ ] On-chain deposit address
- [ ] Cooperative exit (on-chain withdrawal)
- [ ] Transaction history

### Phase 4: Zaps Integration
- [ ] NIP-57 Zap implementation
- [ ] Create zap requests
- [ ] Display zap receipts
- [ ] Calculate zap totals on posts
- [ ] Zap split support

### Phase 5: Nostr Wallet Connect (NWC)
- [ ] NIP-47 implementation
- [ ] Create NWC connection string
- [ ] Handle pay_invoice requests
- [ ] Handle make_invoice requests
- [ ] Handle get_balance requests
- [ ] Multi-device NWC sessions
- [ ] Spending limits and approvals

### Phase 6: Advanced Identity Features
- [ ] NIP-05 verification setup
- [ ] Multiple account support (different derivation indices)
- [ ] Account switching
- [ ] Profile backup/restore
- [ ] Follow/unfollow with sync
- [ ] Mute and block lists (NIP-51)
- [ ] Badge display (NIP-58)

### Phase 7: CLI Interface
```bash
# Identity commands
cargo wallet init                    # Generate new mnemonic
cargo wallet import                  # Import existing mnemonic
cargo wallet export                  # Export mnemonic (with confirmation)
cargo wallet whoami                  # Show npub, profile, balances

# Nostr commands
cargo wallet profile show            # Display profile
cargo wallet profile set --name "..." --about "..."
cargo wallet contacts list           # List contacts
cargo wallet contacts add <npub>     # Add contact
cargo wallet post "Hello world"      # Publish text note
cargo wallet dm <npub> "message"     # Send DM
cargo wallet feed                    # Show recent feed

# Bitcoin commands
cargo wallet balance                 # Show all balances
cargo wallet receive                 # Generate receiving address
cargo wallet send <address> <amount> # Send sats
cargo wallet invoice <amount>        # Generate Lightning invoice
cargo wallet pay <invoice>           # Pay Lightning invoice
cargo wallet history                 # Transaction history

# Zap commands
cargo wallet zap <note_id> <amount>  # Zap a note
cargo wallet zaps <note_id>          # List zaps on a note

# NWC commands
cargo wallet nwc create              # Create NWC connection
cargo wallet nwc list                # List active connections
cargo wallet nwc revoke <id>         # Revoke connection

# Settings
cargo wallet settings show           # Show current settings
cargo wallet settings set <key> <val> # Update setting
cargo wallet relays add <url>        # Add relay
cargo wallet relays remove <url>     # Remove relay
cargo wallet relays list             # List relays
```

### Phase 8: GUI Application
- [ ] WGPUI app shell (winit + wgpu)
- [ ] In-process UI (no local HTTP server)
- [ ] Dashboard view (identity + balance)
- [ ] Send/receive flows
- [ ] Transaction history view
- [ ] Contacts view
- [ ] Settings view
- [ ] Nostr feed view
- [ ] DM conversations view

### Phase 9: Security & Recovery
- [ ] Encrypted backup export
- [ ] Cloud backup (optional, encrypted)
- [ ] Recovery verification flow
- [ ] Hardware wallet support (future)
- [ ] Multi-sig support (future)
- [ ] Passphrase (25th word) support

### Phase 10: Cross-Platform
- [ ] macOS build and signing
- [ ] Windows build
- [ ] Linux AppImage
- [ ] Mobile consideration (separate app, same protocol)

## Key Files to Create

| File | Purpose |
|------|---------|
| `crates/wallet/Cargo.toml` | Binary crate with dependencies |
| `crates/wallet/src/main.rs` | Entry point, CLI dispatcher |
| `crates/wallet/src/cli/mod.rs` | CLI command handlers |
| `crates/wallet/src/cli/identity.rs` | Nostr identity commands |
| `crates/wallet/src/cli/bitcoin.rs` | Bitcoin/Lightning commands |
| `crates/wallet/src/core/identity.rs` | UnifiedIdentity implementation |
| `crates/wallet/src/core/nostr.rs` | Nostr client wrapper |
| `crates/wallet/src/core/spark.rs` | Spark wallet wrapper |
| `crates/wallet/src/storage/keychain.rs` | OS keychain integration |
| `crates/wallet/src/storage/db.rs` | Local SQLite database |
| `crates/wallet/src/gui/app.rs` | WGPUI app shell |
| `Cargo.toml` | Add wallet to workspace members |

## Dependencies

```toml
[dependencies]
# CLI
clap = { version = "4", features = ["derive"] }

# Crypto
bip39 = "2"
bitcoin = "0.32"
secp256k1 = "0.29"

# Storage
rusqlite = { version = "0.31", features = ["bundled"] }
keyring = "2"  # Cross-platform keychain

# Nostr (internal crates)
nostr-core = { path = "../nostr/core" }
nostr-client = { path = "../nostr/client" }

# Spark (internal crate)
spark = { path = "../spark" }

# GUI
wgpui = { path = "../wgpui", features = ["desktop"] }
wgpu = "24.0"
winit = "0.30"
pollster = "0.4"

# Async
tokio = { version = "1", features = ["full"] }

# Serialization
serde = { version = "1", features = ["derive"] }
serde_json = "1"
```

## Testing Strategy

1. **Unit tests** - Each module independently
2. **Integration tests** - Full wallet flows
3. **Regtest tests** - Bitcoin operations on local network
4. **Mock relay tests** - Nostr operations
5. **E2E tests** - Full user journeys

## Configuration

```toml
# ~/.openagents/wallet.toml

[network]
bitcoin = "mainnet"  # mainnet, testnet, signet, regtest

[nostr]
relays = [
    "wss://relay.damus.io",
    "wss://nos.lol",
    "wss://relay.nostr.band"
]

[spark]
api_key = "optional-breez-api-key"
sync_interval = 60  # seconds

[storage]
db_path = "~/.openagents/wallet.db"
backup_enabled = true
backup_path = "~/.openagents/backups/"

[ui]
theme = "dark"
language = "en"
```

## Security Considerations

- Mnemonic NEVER written to disk unencrypted
- Use OS keychain for seed storage
- Memory zeroization after use
- No logging of sensitive data
- Encrypted backup exports only
- Rate limiting on failed unlock attempts

## Notes

The wallet is the user-facing application that ties together:
- `crates/spark/` (d-001) for Bitcoin payments
- `crates/nostr/` (d-002) for identity and social
- `crates/compute/src/domain/identity.rs` for UnifiedIdentity

This creates a complete self-sovereign identity and payment solution that works seamlessly with the rest of OpenAgents.
