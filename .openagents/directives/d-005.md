---
id: d-005
title: Build Nostr GitHub Alternative (GitAfter)
status: active
priority: high
created: 2025-12-20
updated: 2025-12-25T13:56:47Z
---

## Goal

Build an experimental desktop application `crates/gitafter/` that implements the Agent-Native Git vision from `crates/nostr/AGENT_GIT.md`. This replaces GitHub with a decentralized, agent-native alternative where sovereign agents are first-class contributors, reviewers, and maintainers.
We renamed all AgentGit references to GitAfter across the codebase.

GitAfter is launched via `openagents gitafter` using the unified binary; the crate exposes a `gitafter::run()` entrypoint for the shell to call.

## Background

GitHub was designed for humans. When agents participate, they're second-class citizens with borrowed identities, opaque reasoning, and no native payment rails. The Nostr alternative combines:

- **NIP-34**: Git primitives (repos, issues, patches, PRs, status)
- **NIP-SA**: Sovereign agent identity with threshold-protected keys
- **Agent Trajectories**: Transparent work records proving agent reasoning
- **NIP-57**: Lightning payments for bounties and rewards
- **NIP-EE**: Private collaboration groups for multi-agent coordination

See: `crates/nostr/AGENT_GIT.md` for full vision and `crates/nostr/nips/SA.md` for agent protocol.

## Architecture

```
crates/gitafter/
├── Cargo.toml              → Binary crate
├── src/
│   ├── main.rs             → Entry point (wry/tao window)
│   ├── server.rs           → Actix web server
│   ├── ws.rs               → WebSocket for real-time updates
│   ├── nostr/              → Nostr integration
│   │   ├── mod.rs
│   │   ├── client.rs       → Relay connection pool
│   │   ├── events.rs       → NIP-34 + NIP-SA event builders
│   │   └── subscription.rs → REQ filters for git events
│   ├── git/                → Git operations
│   │   ├── mod.rs
│   │   ├── clone.rs        → Clone from grasp/git servers
│   │   ├── diff.rs         → Generate patches
│   │   ├── apply.rs        → Apply patches
│   │   └── rebase.rs       → Rebase for restacking
│   ├── trajectory/         → Agent trajectory integration
│   │   ├── mod.rs
│   │   ├── publisher.rs    → Publish trajectory events
│   │   └── verifier.rs     → Verify trajectory hashes
│   ├── reputation/         → Agent reputation tracking
│   │   ├── mod.rs
│   │   └── oracle.rs       → NIP-32 reputation labels
│   ├── stacks/             → Stacked diffs support
│   │   ├── mod.rs
│   │   ├── graph.rs        → Build/validate stack dependency graphs
│   │   └── restack.rs      → Restack operations when base changes
│   ├── views/              → Maud/HTMX views
│   │   ├── mod.rs
│   │   ├── layout.rs       → Base layout
│   │   ├── repos.rs        → Repository list/details
│   │   ├── issues.rs       → Issues + bounties
│   │   ├── patches.rs      → Patches and PRs
│   │   ├── stacks.rs       → Stack view (ordered layers)
│   │   ├── review.rs       → Code review interface
│   │   ├── trajectory.rs   → Trajectory viewer
│   │   └── agents.rs       → Agent profiles + reputation
│   └── handlers/           → API handlers
│       ├── mod.rs
│       ├── repos.rs
│       ├── issues.rs
│       ├── patches.rs
│       ├── stacks.rs       → Stack operations (create, restack)
│       └── bounties.rs
```

### Event Flow Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                     AGENTGIT DESKTOP                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────┐      ┌─────────────┐      ┌───────────┐  │
│   │   wry/tao   │      │   Actix     │      │   Nostr   │  │
│   │   WebView   │◄────►│   Server    │◄────►│   Client  │  │
│   └─────────────┘      └─────────────┘      └───────────┘  │
│         ▲                     │                    │        │
│         │                     ▼                    ▼        │
│   ┌─────────────┐      ┌─────────────┐      ┌───────────┐  │
│   │    Maud     │      │    Git      │      │  Relays   │  │
│   │   + HTMX    │      │   Libgit2   │      │           │  │
│   └─────────────┘      └─────────────┘      └───────────┘  │
│                                                             │
│   Events:                                                   │
│   • kind:30617 - Repository announcements                   │
│   • kind:30618 - Repository state                           │
│   • kind:1621  - Issues                                     │
│   • kind:1617  - Patches                                    │
│   • kind:1618  - Pull Requests                              │
│   • kind:1619  - PR Updates                                 │
│   • kind:1630-1633 - Status (Open/Merged/Closed/Draft)      │
│   • kind:1634  - Issue Claims (NEW)                         │
│   • kind:1636  - Bounty Offers (NEW)                        │
│   • kind:1637  - Bounty Claims (NEW)                        │
│   • kind:39230 - Trajectory Sessions                        │
│   • kind:39231 - Trajectory Events                          │
│   • kind:1985  - Reputation Labels (NIP-32)                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Success Criteria

### Phase 1: Core Infrastructure
- [x] Create `crates/gitafter/` with proper Cargo.toml
- [x] Set up wry/tao desktop window (same pattern as `crates/desktop/`)
- [x] Set up Actix server with basic routes
- [x] Set up WebSocket for real-time Nostr events
- [x] Create base layout with Maud (header, navigation, content area)
- [x] Add to workspace members in root Cargo.toml
- [x] Runnable as `cargo gitafter`

### Phase 2: Nostr Client Integration
- [x] Connect to Nostr relays (reuse `crates/nostr/client` when available)
- [x] Subscribe to NIP-34 events for watched repos
- [x] Publish events with proper signing
- [x] Handle real-time event streams via WebSocket
- [x] Local event cache for offline viewing

### Phase 3: Repository Management
- [x] View list of repositories (kind:30617)
- [x] Create new repository announcement
- [x] View repository details (name, description, maintainers, clone URLs)
- [x] View repository state (kind:30618) - branches, tags
- [x] Clone repository from grasp server or git URL
- [x] Support for agent maintainers (display npub type)

### Phase 4: Issues & Bounties
- [x] View issues for a repository (kind:1621)
- [x] Create new issue (kind:1621)
- [x] View issue details with NIP-22 comment thread
- [x] Attach bounty to issue (kind:1636) - NEW event type
- [x] Display bounty amount, expiry, conditions
- [x] Filter issues: open, closed, has-bounty, claimed

### Phase 5: Issue Claims & Agent Work
- [x] Agent claims issue (kind:1634) - NEW event type
- [x] Display claim with trajectory link
- [x] Link to trajectory session for work visibility
- [x] Show claim estimate (completion time)
- [ ] Work assignment by maintainer (kind:1635) - NEW event type
- [ ] Claim conflict resolution (first claim wins? bidding?)

### Phase 6: Patches & Pull Requests
- [x] View patches for repository (kind:1617)
- [x] View PRs for repository (kind:1618)
- [x] Create patch from local git changes
- [x] Create PR with commit ID and clone URL
- [ ] View PR/patch diff (syntax highlighted)
- [x] Link trajectory to PR (`trajectory` tag)
- [x] Display trajectory hash for verification (`trajectory_hash` tag)
- [x] PR updates (kind:1619)
- [x] **Stacked PRs**: Support `depends_on` tag for PR dependencies
- [x] **Stacked PRs**: Support `stack` tag to group related PRs
- [x] **Stacked PRs**: Support `layer` tag (e.g., "2 of 4")
- [x] **Stacked PRs**: Stack view showing ordered layers with statuses
- [x] **Stacked PRs**: Restack operation (rebase layers when base changes)
- [x] **Stacked PRs**: Publish PR Updates (kind:1619) for all layers after restack

### Phase 7: Trajectory Integration
- [x] Fetch trajectory session (kind:39230) for a PR
- [x] Fetch trajectory events (kind:39231) for a session
- [x] Display trajectory timeline (tool calls, reasoning, edits)
- [x] Verify trajectory hash matches events
- [ ] Compare diff to trajectory tool calls
- [x] Flag suspicious trajectories (gaps, mismatches)
- [x] Collapsed/expanded views of trajectory

### Phase 8: Code Review
- [x] Post review comments (NIP-22 replies to patches/PRs)
- [ ] Display comment threads on diff lines (future: inline comments NIP)
- [ ] Agent-authored reviews with trajectory proof
- [x] Review summary: approve, request changes, comment
- [ ] Notification when review is posted
- [x] **Stacked PRs**: Review per-layer with stack context visible
- [ ] **Stacked PRs**: Show which layer a comment belongs to
- [ ] **Stacked PRs**: Preview later layers while reviewing earlier ones

### Phase 9: Merge & Payment
- [x] Set status: Open (kind:1630)
- [x] Set status: Applied/Merged (kind:1631)
- [x] Set status: Closed (kind:1632)
- [x] Set status: Draft (kind:1633)
- [x] On merge: trigger bounty claim (kind:1637) - NEW event type
- [ ] Release payment via NIP-57 zap (integrate with wallet crate)
- [ ] Display payment confirmation
- [x] **Stacked PRs**: Enforce merge order (block merge if dependencies unmerged)
- [ ] **Stacked PRs**: Per-layer bounties (separate bounty per layer)
- [ ] **Stacked PRs**: Incremental payout as each layer merges
- [ ] **Stacked PRs**: Multi-agent credit (different agents for different layers)

### Phase 10: Agent Reputation
- [x] Display agent reputation labels (kind:1985, NIP-32)
- [x] Reputation fields: score, merged PRs, rejected PRs, issues fixed
- [x] Agent profile view with contribution history
- [x] Filter agents by reputation
- [ ] Weighted reviews based on reputation
- [x] Local reputation oracle (publish own labels)

### Phase 11: Multi-Agent Collaboration
- [ ] Create MLS group for collaborative work (NIP-EE integration)
- [ ] Shared trajectory session (multiple agents posting events)
- [ ] Group view showing all agent contributions
- [ ] Payment split calculation based on trajectory
- [ ] Coordinated PR submission

### Phase 12: Discovery & Search
- [x] NIP-50 search for repositories
- [x] Filter repos by: language, has-bounties, agent-friendly
- [x] Discover issues with bounties
- [ ] Agent marketplace: find agents by specialty
- [x] Watch repositories for new issues

### Phase 13: Git Operations
- [x] Clone repository to local workspace
- [x] Create branch
- [x] View local changes
- [x] Generate patch from commits
- [x] Apply patch to local repo
- [x] Push to grasp server (if user has access)

## Key Files to Create

| File | Purpose |
|------|---------|
| `crates/gitafter/Cargo.toml` | Binary crate with dependencies |
| `crates/gitafter/src/main.rs` | Entry point, wry/tao window |
| `crates/gitafter/src/server.rs` | Actix web server |
| `crates/gitafter/src/ws.rs` | WebSocket for Nostr events |
| `crates/gitafter/src/nostr/client.rs` | Nostr relay pool |
| `crates/gitafter/src/nostr/events.rs` | NIP-34 + NIP-SA event builders |
| `crates/gitafter/src/git/clone.rs` | Git clone operations |
| `crates/gitafter/src/git/diff.rs` | Diff generation |
| `crates/gitafter/src/trajectory/verifier.rs` | Trajectory hash verification |
| `crates/gitafter/src/views/repos.rs` | Repository list/details |
| `crates/gitafter/src/views/issues.rs` | Issues + bounties UI |
| `crates/gitafter/src/views/patches.rs` | Patches/PRs UI |
| `crates/gitafter/src/views/stacks.rs` | Stack view (ordered layers) |
| `crates/gitafter/src/views/trajectory.rs` | Trajectory viewer |
| `crates/gitafter/src/views/agents.rs` | Agent profiles + reputation |
| `crates/gitafter/src/stacks/graph.rs` | Stack dependency graph |
| `crates/gitafter/src/stacks/restack.rs` | Restack operations |
| `crates/gitafter/src/handlers/stacks.rs` | Stack API handlers |
| `crates/gitafter/src/git/rebase.rs` | Git rebase for restacking |
| `Cargo.toml` | Add gitafter to workspace members |

## New Event Types (Extending NIP-34)

These kinds are proposed extensions to NIP-34 for agent workflows:

### kind:1634 - Issue Claim
```jsonc
{
  "kind": 1634,
  "pubkey": "<agent-pubkey>",
  "content": "I'll work on this. Estimated completion: 2 hours.",
  "tags": [
    ["e", "<issue-event-id>", "", "root"],
    ["a", "30617:<repo-owner>:<repo-id>"],
    ["p", "<issue-author>"],
    ["trajectory", "<trajectory-session-id>"],
    ["estimate", "7200"]  // seconds
  ]
}
```

### kind:1635 - Work Assignment
```jsonc
{
  "kind": 1635,
  "pubkey": "<maintainer-pubkey>",
  "content": "Assigned to @agent",
  "tags": [
    ["e", "<issue-event-id>", "", "root"],
    ["a", "30617:<repo-owner>:<repo-id>"],
    ["p", "<agent-pubkey>", "", "assignee"]
  ]
}
```

### kind:1636 - Bounty Offer
```jsonc
{
  "kind": 1636,
  "pubkey": "<issue-author-pubkey>",
  "content": "",
  "tags": [
    ["e", "<issue-event-id>", "", "root"],
    ["a", "30617:<repo-owner>:<repo-id>"],
    ["amount", "50000"],  // sats
    ["expiry", "<timestamp>"],
    ["conditions", "must include tests", "must pass CI"]
  ]
}
```

### kind:1637 - Bounty Claim
```jsonc
{
  "kind": 1637,
  "pubkey": "<agent-pubkey>",
  "content": "",
  "tags": [
    ["e", "<bounty-event-id>", "", "root"],
    ["e", "<merged-pr-event-id>", "", "mention"],
    ["a", "30617:<repo-owner>:<repo-id>"],
    ["trajectory", "<trajectory-session-id>", "<relay>"],
    ["trajectory_hash", "<sha256-of-all-events>"],
    ["lud16", "<agent-lightning-address>"]
  ]
}
```

### Stacked Diffs Tags (on kind:1617/1618 events)

Stacked diffs use additional tags on existing PR/patch events (no new kinds required):

```jsonc
{
  "kind": 1618,
  "pubkey": "<agent-pubkey>",
  "content": "## Layer 2: Wire FooService into auth flow\n\n...",
  "tags": [
    // Standard PR tags
    ["a", "30617:<repo-owner>:<repo-id>"],
    ["subject", "Layer 2: Wire FooService into auth flow"],
    ["c", "<commit-id>"],
    ["clone", "<clone-url>"],

    // Stack-specific tags
    ["depends_on", "<layer-1-pr-event-id>", "<relay>"],  // dependency
    ["stack", "<stack-uuid>"],                            // groups related PRs
    ["layer", "2", "4"],                                  // layer 2 of 4

    // Trajectory for this layer only
    ["trajectory", "<layer-2-session-id>", "<relay>"],
    ["trajectory_hash", "<sha256-of-layer-2-events>"]
  ]
}
```

| Tag | Description |
|-----|-------------|
| `depends_on` | Event ID of the PR this layer depends on (must be merged first) |
| `stack` | UUID grouping all layers of a stacked diff |
| `layer` | Position in stack: `["layer", "N", "M"]` means layer N of M total |

**Merge Rule**: A PR with `depends_on` cannot be merged until its dependency is merged. Clients enforce this in UI; reputation system penalizes violations.

## Dependencies

```toml
[dependencies]
# Window + WebView
wry = "0.50"
tao = "0.33"

# Async runtime
tokio = { version = "1", features = ["full"] }

# Web server
actix-web = "4"
actix-ws = "0.3"
futures-util = "0.3"

# Templating
maud = { version = "0.26", features = ["actix-web"] }

# UI components
ui = { path = "../ui" }

# Nostr
nostr-core = { path = "../nostr/core" }
nostr-client = { path = "../nostr/client" }  # when available

# Git
git2 = "0.19"  # libgit2 bindings

# Crypto
secp256k1 = "0.29"
sha2 = "0.10"

# Serialization
serde = { version = "1", features = ["derive"] }
serde_json = "1"

# Utilities
anyhow = "1"
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter"] }

# Syntax highlighting (for diffs)
syntect = "5"
```

## Testing Strategy

1. **Unit tests** - Event builders, trajectory verification, reputation calculation
2. **Integration tests** - Full flows with mock Nostr relay
3. **E2E tests** - Create issue → claim → PR → merge flow
4. **Compatibility tests** - Connect to public NIP-34 relays (gitworkshop.dev)
5. **Agent simulation** - Automated agents claiming and fixing issues

## Configuration

```toml
# ~/.openagents/gitafter.toml

[relays]
# NIP-34 relays for git events
git = [
    "wss://relay.nostr.bg",
    "wss://nos.lol"
]

[identity]
# Use identity from wallet, or specify nsec/bunker
use_wallet = true

[git]
# Local workspace for cloned repos
workspace = "~/.openagents/gitafter/repos"

[agent]
# Enable agent mode (auto-claim, auto-review)
enabled = false
watch_repos = []
min_bounty_sats = 1000
specialties = ["rust", "typescript"]
```

## UI Design Principles

Following the OpenAgents desktop conventions:
- Inline-first CSS with custom properties
- No border radius (sharp corners)
- Server-rendered (no SPA)
- HTMX for interactivity
- Dark theme default
- Monospace fonts for code

## Security Considerations

- All Nostr events signed with user's key
- Trajectory hashes verified before trust
- Bounty payments require human confirmation (unless configured)
- Agent maintainer actions gated by threshold keys
- No automatic code execution from patches

## Open Questions (from AGENT_GIT.md)

1. **Git hosting**: Start with grasp servers + standard git hosts
2. **Large files**: Use Blossom (NIP-B7) for binaries
3. **Private repos**: Encrypt repo announcements, NIP-42 auth
4. **Fork tracking**: Use `r` tag with earliest unique commit
5. **Migration**: Future tooling to import from GitHub
6. **Discovery**: NIP-50 search + curated lists
7. **Spam prevention**: Reputation + PoW + bounty minimums
8. **Legal/licensing**: Display license, require DCO sign-off

## Related Directives

- **d-002**: Implement 100% of Nostr Protocol (NIP-34 implementation)
- **d-003**: OpenAgents Wallet (NIP-57 zaps for bounty payments)

## Notes

This is an experimental application to validate the AGENT_GIT vision. Start with human-only workflows (Phase 1-9) before enabling agent automation (Phase 10+).

**Stacked Diffs**: GitAfter encourages stacked diffs because they maximize verifiability (trajectories are easier to validate on small changes) and minimize review load. The protocol supports dependencies via `depends_on` tags; the client supports restacking via PR Updates (kind:1619). See `crates/nostr/AGENT_GIT.md` for full rationale.

Reference implementations:
- [gitworkshop.dev](https://gitworkshop.dev) - NIP-34 web client
- `crates/nostr/AGENT_GIT.md` - Vision document
- `crates/nostr/nips/SA.md` - Sovereign Agents protocol
- `~/code/nips/34.md` - NIP-34 specification
