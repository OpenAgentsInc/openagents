---
id: d-006
title: Operationalize NIP-SA (Sovereign Agents Protocol)
status: active
priority: urgent
created: 2025-12-21
updated: 2025-12-21
---

## Goal

Implement NIP-SA (Sovereign Agents) across the OpenAgents stack, enabling agents to operate autonomously with their own Nostr identity, threshold-protected keys, encrypted state, and published trajectories. This is the final building block for viable autonomous agents on permissionless open protocols.

## Background

NIP-SA defines a protocol for autonomous agents that:
1. **Own their identity** - Nostr keypair with threshold protection (operator cannot extract)
2. **Own assets** - Skills, data, and funds cryptographically bound to the agent
3. **Act autonomously** - Take initiative via scheduled ticks, not just human prompts
4. **Participate in markets** - Buy compute, sell services, transact with other agents

The protocol builds on:
- NIP-01 (identity), NIP-28 (channels), NIP-44 (encryption), NIP-57 (zaps)
- NIP-59 (gift wrap), NIP-78 (app data), NIP-90 (DVMs), NIP-EE (MLS groups)
- FROSTR for threshold signatures

See: `crates/nostr/nips/SA.md` for the complete specification (943 lines).

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SOVEREIGN AGENT STACK                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │     WALLET      │    │    AUTOPILOT    │    │    AGENTGIT     │         │
│  │   (Identity)    │    │   (Execution)   │    │  (Collaboration)│         │
│  └────────┬────────┘    └────────┬────────┘    └────────┬────────┘         │
│           │                      │                      │                   │
│           └──────────────────────┼──────────────────────┘                   │
│                                  │                                          │
│                    ┌─────────────▼─────────────┐                           │
│                    │      NIP-SA LAYER         │                           │
│                    │                           │                           │
│                    │  • Agent Profile (39200)  │                           │
│                    │  • Agent State (39201)    │                           │
│                    │  • Agent Schedule (39202) │                           │
│                    │  • Tick Events (39210/11) │                           │
│                    │  • Trajectories (39230/31)│                           │
│                    │  • Skill License (39220)  │                           │
│                    └─────────────┬─────────────┘                           │
│                                  │                                          │
│                    ┌─────────────▼─────────────┐                           │
│                    │      NOSTR RELAYS         │                           │
│                    └───────────────────────────┘                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Threshold Key Architecture

```
Agent Private Key (never exists as single value)
         │
         ├── Share 1: Secure Enclave (operator device - iOS/Android/SGX)
         │
         ├── Share 2: Marketplace Signer (license enforcement)
         │
         └── Share 3: Guardian/Backup (optional, for recovery)
```

2-of-3 threshold: Agent + Marketplace can sign/decrypt without Guardian.
Marketplace enforces policies before participating in threshold operations.

## Success Criteria

### Phase 1: Core NIP-SA Types
- [x] Create `crates/nostr/core/src/nip_sa/` module structure
- [x] Implement AgentProfile event (kind:39200)
- [x] Implement AgentState event (kind:39201) with NIP-44 encryption
- [x] Implement AgentSchedule event (kind:39202)
- [x] Implement AgentGoals event (kind:39203)
- [x] Implement TickRequest/TickResult events (kinds:39210, 39211)
- [x] Implement TrajectorySession/TrajectoryEvent (kinds:39230, 39231)
- [x] Implement SkillLicense/SkillDelivery events (kinds:39220, 39221)
- [x] Add NIP-SA to crates/nostr/core/src/lib.rs exports

### Phase 2: Agent Identity (Wallet Integration)
> **Blocked by**: d-007 Phase 4 (FROSTR Wallet Integration)

- [ ] Create `crates/wallet/src/core/sovereign.rs` - SovereignAgentIdentity
- [ ] Integrate `crates/frostr/` for threshold key generation (see d-007)
- [ ] Implement key share distribution (local enclave + marketplace)
- [ ] Add agent profile publishing (kind:39200) to wallet CLI
- [ ] Extend `cargo wallet whoami` to show agent identity info
- [ ] Add `cargo wallet agent create` command
- [ ] Add `cargo wallet agent profile` command

### Phase 3: Agent State Management
- [x] Implement state encryption using NIP-44 to agent pubkey
- [x] Create state fetch/update helpers in autopilot
- [x] Track goals with progress updates
- [ ] Integrate wallet balance from Spark (d-001) into agent state
- [x] Implement state versioning for migration
- [ ] Add budget constraints enforcement

### Phase 4: Tick Mechanism (Autopilot Integration)
- [ ] Create `crates/autopilot/src/nostr_agent.rs` - Nostr-integrated agent
- [ ] Publish TickRequest (39210) at run start
- [ ] Publish TickResult (39211) at run end with metrics
- [ ] Implement heartbeat trigger from schedule (kind:39202)
- [ ] Implement event triggers (mentions, DMs, zaps)
- [ ] Modify daemon supervisor to watch for Nostr triggers
- [ ] Add `cargo autopilot run --nostr-agent` mode

### Phase 5: Trajectory Publishing
- [ ] Create `crates/autopilot/src/nip_sa_trajectory.rs`
- [ ] Map TrajectoryCollector step types to NIP-SA event types
- [ ] Create TrajectorySession (39230) at run start
- [ ] Stream TrajectoryEvents (39231) to relays during run
- [ ] Support public (NIP-28) and private (NIP-EE) trajectory channels
- [ ] Calculate and publish trajectory hash for verification
- [ ] Add trajectory verification helper

### Phase 6: GitAfter Integration
- [ ] Add `trajectory` and `trajectory_hash` tags to PR events (kind:1618)
- [ ] Fetch and display trajectory timeline in PR review UI
- [ ] Implement trajectory hash verification
- [ ] Link bounty claims (kind:1637) to trajectory proof
- [ ] Display agent reputation from trajectory history
- [ ] Flag suspicious trajectories (gaps, mismatches)

### Phase 7: Skill Protection (Future)
- [ ] Implement SkillLicense event creation (kind:39220)
- [ ] Implement SkillDelivery via gift wrap (kind:39221)
- [ ] Create marketplace signer middleware
- [ ] Implement license-gated threshold ECDH for skill decryption
- [ ] Add license revocation support

## Key Files to Create/Modify

| File | Purpose |
|------|---------|
| `crates/nostr/core/src/nip_sa/mod.rs` | **NEW** - Module exports |
| `crates/nostr/core/src/nip_sa/profile.rs` | **NEW** - AgentProfile (39200) |
| `crates/nostr/core/src/nip_sa/state.rs` | **NEW** - AgentState (39201) |
| `crates/nostr/core/src/nip_sa/schedule.rs` | **NEW** - AgentSchedule (39202) |
| `crates/nostr/core/src/nip_sa/goals.rs` | **NEW** - AgentGoals (39203) |
| `crates/nostr/core/src/nip_sa/tick.rs` | **NEW** - Tick events (39210, 39211) |
| `crates/nostr/core/src/nip_sa/trajectory.rs` | **NEW** - Trajectory events (39230, 39231) |
| `crates/nostr/core/src/nip_sa/skill.rs` | **NEW** - Skill events (39220, 39221) |
| `crates/nostr/core/src/lib.rs` | Add nip_sa module export |
| `crates/wallet/src/core/sovereign.rs` | **NEW** - SovereignAgentIdentity |
| `crates/wallet/src/cli/agent.rs` | **NEW** - Agent CLI commands |
| `crates/autopilot/src/nostr_agent.rs` | **NEW** - Nostr-integrated agent loop |
| `crates/autopilot/src/nip_sa_trajectory.rs` | **NEW** - Trajectory publisher |
| `crates/autopilot/src/daemon/nostr_trigger.rs` | **NEW** - Nostr event triggers |
| `crates/gitafter/src/trajectory/verifier.rs` | Add NIP-SA trajectory verification |
| `crates/gitafter/src/views/trajectory.rs` | Add trajectory timeline display |

## Dependencies

### External
- `crates/frostr/` - Native Rust FROSTR implementation (see d-007)
- `chacha20poly1305` - For NIP-44 encryption

### Internal (OpenAgents crates)
- `nostr-core` - Base Nostr types and NIP implementations
- `nostr-client` - Relay pool and subscription management
- `wallet` - UnifiedIdentity foundation
- `autopilot` - Agent execution loop
- `gitafter` - Git collaboration UI

### Related Directives
- **d-001** (Spark SDK) - Agent wallet balance via Lightning
- **d-002** (Nostr Protocol) - NIP-44, NIP-59, NIP-78 support
- **d-003** (Wallet) - UnifiedIdentity as foundation for agent identity
- **d-004** (Autopilot) - Trajectory logging infrastructure to extend
- **d-005** (GitAfter) - Trajectory display and verification in PRs
- **d-007** (FROSTR) - Native Rust threshold signatures (**blocking dependency for Phase 2**)

## Event Kinds Reference

| Kind | Name | Type | Description |
|------|------|------|-------------|
| 39200 | Agent Profile | Replaceable | Agent metadata with threshold config |
| 39201 | Agent State | Replaceable | NIP-44 encrypted goals, memory, wallet |
| 39202 | Agent Schedule | Replaceable | Heartbeat interval and triggers |
| 39203 | Agent Goals | Replaceable | Public goals (optional transparency) |
| 39210 | Tick Request | Ephemeral | Runner signals tick start |
| 39211 | Tick Result | Ephemeral | Runner reports tick outcome |
| 39220 | Skill License | Addressable | Marketplace-issued license |
| 39221 | Skill Delivery | Ephemeral | Gift-wrapped skill content |
| 39230 | Trajectory Session | Addressable | Run metadata and participants |
| 39231 | Trajectory Event | Regular | Individual trajectory step |

## Testing Strategy

1. **Unit tests** - Each NIP-SA event type serialization/deserialization
2. **Integration tests** - Full tick cycle with mock relays
3. **Trajectory tests** - Map autopilot TrajectoryCollector → NIP-SA events
4. **Threshold tests** - Key splitting and coordinated signing (mock signers)
5. **E2E tests** - Agent claims issue → executes → publishes trajectory → PR merged

## Configuration

```toml
# ~/.openagents/agent.toml

[identity]
# Use threshold-protected agent identity
threshold = [2, 3]  # 2-of-3 scheme
marketplace_signer = "npub1marketplace..."
guardian_signer = "npub1guardian..."  # optional

[schedule]
heartbeat_seconds = 900  # 15 minutes
triggers = ["mention", "dm", "zap"]

[trajectory]
publish_mode = "public"  # or "private" (NIP-EE group)
relays = ["wss://relay.damus.io", "wss://nos.lol"]

[budget]
daily_limit_sats = 10000
per_tick_limit_sats = 1000
reserved_sats = 5000
```

## Security Considerations

### Threshold Key Protection
- Share 1 stored in secure enclave (never exportable)
- Marketplace signer enforces policy before signing
- Guardian share for recovery only
- Rate limiting on threshold operations

### State Confidentiality
- State encrypted to agent pubkey (NIP-44)
- Decryption requires marketplace participation
- Runners see encrypted state only

### Trajectory Integrity
- Each event signed by author
- Session hash covers all events
- Gaps detectable via sequence numbers
- Thinking blocks can be signed but redacted

## Notes

This directive operationalizes NIP-SA as drafted in `crates/nostr/nips/SA.md`. The implementation phases are ordered to provide value incrementally:

1. **Types first** - Enable other code to use NIP-SA events
2. **Identity second** - Agents need identity before they can act
3. **State third** - Agents need persistent state to be useful
4. **Ticks fourth** - Agents need execution triggers to be autonomous
5. **Trajectories fifth** - Agents need transparency to build trust
6. **GitAfter sixth** - Connects trajectories to git collaboration
7. **Skills last** - Lower priority, more complex (marketplace coordination)

The key insight from comparative analysis with DeepMind's Distributional AGI Safety:
- We prioritize **economic alignment** over structural controls
- We prioritize **permissionless protocols** over controlled sandboxes
- We prioritize **distributed governance** over centralized oversight

Agents operating via NIP-SA are economically aligned: they start with zero resources, must create value to survive, and face market punishment for bad behavior. This is safer than centralized control which can be captured.

## Related Documents

- `crates/nostr/nips/SA.md` - Complete NIP-SA specification
- `docs/openagents-vs-distributional-agi-safety.md` - Comparative analysis
- `reference/planning/19-autonomous-agents.md` - Autonomous agent epic
- `reference/writing/THE_SYNTHESIS.md` - Strategic vision
