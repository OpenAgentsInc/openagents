---
id: d-009
title: Autopilot GUI - Visual Agent Interface Powered by Claude Agent SDK
status: active
priority: high
created: 2025-12-21
updated: 2025-12-25T14:16:58Z
---

## Goal

Build a native WGPUI desktop GUI for Autopilot that wraps the Claude Agent SDK (Rust crate), providing a visual interface for running AI agents with real-time visibility into sessions, context, and execution. The experience should feel familiar to Claude Code users while adding the power of a rich visual interface. For the first round, permissions are auto-approved (no dedicated permissions pane).

## Background

The Claude Agent SDK provides programmatic access to Claude Code's capabilities:
- Query streaming with full message types
- Permission handling (rules-based and callback)
- Session management (continue, resume)
- Control methods (interrupt, abort, set_permission_mode)
- MCP server integration

Currently, autopilot runs headlessly via CLI. A GUI enables:
- **Real-time visibility** into agent thinking and tool execution
- **Visual permission management** instead of config files
- **Session browsing** with search and resume
- **Context inspection** to understand what the agent sees
- **Multi-agent orchestration** with visual topology

### Design Principles from Claude Code

Claude Code's CLI provides an excellent UX despite being terminal-based. Key patterns to replicate:

1. **Permission Transparency** - Show tool intent; auto-approve in phase 1, rules UI later
2. **Token Awareness** - Warning indicators when approaching context limits
3. **Abort Capability** - Cancel any operation cleanly at any time
4. **Background Tasks** - Operations can run without blocking UI
5. **Progressive Disclosure** - Verbose mode toggles detailed output
6. **Context Injection** - Git status, directory structure, CLAUDE.md loaded automatically

### Why GUI Over CLI

| Aspect | CLI | GUI |
|--------|-----|-----|
| Multi-session monitoring | Limited (tabs/tmux) | Native multi-pane |
| Permission management | Config file editing | Visual rule builder |
| Context inspection | `/context` command | Collapsible tree view |
| Token usage | Single status line | Real-time gauge/graph |
| Tool execution | Inline text | Syntax-highlighted panels |
| History browsing | `/resume` picker | Searchable timeline |
| Subagent visualization | Nested output | Node graph topology |

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           AUTOPILOT GUI                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  winit EventLoop + wgpu                                                     │
│  WGPUI renderer + layout                                                    │
│  App state (entities + panes)                                               │
│  Backend channels (commands/events)                                         │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Autopilot + Claude Agent SDK                             │
│  • Query streaming (SdkMessage types)                                       │
│  • Session management (continue, resume)                                    │
│  • Control methods (interrupt, abort, set_model)                            │
│  • MCP server integration                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Component Breakdown

```
crates/autopilot-gui/
├── Cargo.toml
├── src/
│   ├── main.rs                 # WGPUI app shell (winit + wgpu)
│   ├── lib.rs                  # run() entrypoint
│   ├── app.rs                  # UI shell + pane layout
│   ├── backend/                # In-process backend (channels)
│   │   └── mod.rs
│   ├── state/                  # App state + view models
│   │   └── mod.rs
│   └── views/                  # Pane views
│       ├── dashboard.rs
│       ├── chat.rs
│       ├── context.rs
│       └── parallel.rs
```

## Success Criteria

### Phase 1: Core Window + Basic Chat (v0.1)

- [ ] Create `crates/autopilot-gui/` with Cargo.toml
- [ ] Implement WGPUI app shell (winit + wgpu)
- [ ] Pane layout with Dashboard, Chat, Context, Parallel
- [ ] Single-session chat interface
- [ ] Query submission via input box
- [ ] Streaming message display via in-process channel
- [ ] Message types: User, Assistant, System
- [ ] Abort button to interrupt query
- [ ] Basic error display
- [ ] Permissions auto-approved (no modal in phase 1)

**CLI Command**: `openagents`

### Phase 2: Tool Execution Display (v0.2)

- [ ] Tool call panels with syntax highlighting
- [ ] Tool progress indicators (elapsed time)
- [ ] Tool result display (collapsible)
- [ ] Bash output with ANSI color support
- [ ] File diff visualization (old vs new)
- [ ] Read file content display
- [ ] Glob/Grep results as file list

### Phase 3: Permission System (v0.3)

- [ ] Permission dialog component (Allow/Always/Reject)
- [ ] Implement `PermissionHandler` trait with UI callbacks
- [ ] Permission rule storage in SQLite
- [ ] Visual permission manager view
- [ ] Pattern-based rules (e.g., `Bash(npm:*)`)
- [ ] Per-session vs persistent permissions
- [ ] Safe command auto-approval (git status, etc.)

### Phase 4: Context Awareness (v0.4)

- [ ] Context inspector view (collapsible tree)
- [ ] Git status display (branch, changes, commits)
- [ ] Directory structure visualization
- [ ] CLAUDE.md content display
- [ ] Token usage gauge (warning at 60%, error at 80%)
- [ ] Context size breakdown by source
- [ ] Compact button with confirmation

### Phase 5: Session Management (v0.5)

- [ ] Session list view with search
- [ ] Session metadata (timestamp, model, turns, cost)
- [ ] Resume session from list
- [ ] Fork session (branch from point)
- [ ] Session naming and tagging
- [ ] Delete/archive sessions
- [ ] Session comparison view

### Phase 6: Thinking & Advanced Display (v0.6)

- [ ] Thinking block display (collapsible, styled)
- [ ] Toggle thinking visibility
- [ ] Extended thinking (ultrathink) support
- [ ] Subagent visualization (nested or tabbed)
- [ ] Agent hierarchy view
- [ ] Cost tracking per session/agent

### Phase 7: Multi-Session & Orchestration (v0.7)

- [ ] Multi-pane session view
- [ ] Run multiple agents in parallel
- [ ] Agent topology graph (subagent relationships)
- [ ] Cross-session context sharing
- [ ] Session templates (save/load configurations)

### Phase 8: Polish & Performance (v0.8)

- [ ] Keyboard shortcuts (CC-compatible)
- [ ] Theme support (light/dark)
- [ ] Font/size preferences
- [ ] Window state persistence
- [ ] Lazy loading for large sessions
- [ ] Memory optimization for long conversations
- [ ] Export session (JSON, Markdown)

## Key Features (Claude Code Parity)

### Must Replicate from Claude Code

| Feature | CC Implementation | GUI Approach |
|---------|-------------------|--------------|
| Tool permissions | Config file + runtime prompt | Visual dialog + rules DB |
| Context injection | Git status, LS, CLAUDE.md | Same, plus visual inspector |
| Token warnings | Status line percentage | Real-time gauge with thresholds |
| Conversation compact | `/compact` command | Button with preview |
| Session resume | `/resume` selector | Searchable session list |
| Abort | Ctrl+C / ESC | Button + keyboard shortcut |
| Verbose mode | `/config` toggle | View option toggle |
| Background tasks | Bash backgrounding | Async panel display |

### New GUI-Only Features

1. **Visual Permission Builder** - Drag-drop rule creation, regex testing
2. **Context Diff** - See what changed between compactions
3. **Agent Topology** - Interactive graph of subagent spawns
4. **Cost Dashboard** - Historical spend with breakdown
5. **Template Library** - Save/share agent configurations
6. **Collaborative View** - Multiple users watching same session

## SDK Integration Pattern

```rust
use claude_agent_sdk::{query, QueryOptions, SdkMessage, PermissionHandler, PermissionResult};
use tokio::sync::broadcast;

pub struct GuiSession {
    query: Query,
    message_tx: broadcast::Sender<SdkMessage>,
}

impl GuiSession {
    pub async fn start(prompt: &str, options: QueryOptions) -> Result<Self> {
        let (message_tx, _) = broadcast::channel(1024);
        let tx = message_tx.clone();

        // Create permission handler that routes to UI
        let permission_handler = UiPermissionHandler::new(permission_tx.clone());

        let query = query_with_permissions(
            prompt,
            options,
            Arc::new(permission_handler),
        ).await?;

        // Stream messages to UI via broadcast channel
        let mut stream = query.stream();
        tokio::spawn(async move {
            while let Some(msg) = stream.next().await {
                if let Ok(msg) = msg {
                    let _ = tx.send(msg);
                }
            }
        });

        Ok(Self { query, message_tx })
    }

    pub fn subscribe(&self) -> broadcast::Receiver<SdkMessage> {
        self.message_tx.subscribe()
    }

    pub async fn interrupt(&self) -> Result<()> {
        self.query.interrupt().await
    }

    pub async fn abort(&self) -> Result<()> {
        self.query.abort().await
    }
}

// Permission handler that shows UI dialog
struct UiPermissionHandler {
    dialog_tx: mpsc::Sender<PermissionRequest>,
    response_rx: mpsc::Receiver<PermissionResult>,
}

#[async_trait]
impl PermissionHandler for UiPermissionHandler {
    async fn can_use_tool(
        &self,
        tool_name: &str,
        input: &Value,
        _suggestions: Option<Vec<PermissionUpdate>>,
        _blocked_path: Option<String>,
        _decision_reason: Option<String>,
        _tool_use_id: &str,
        _agent_id: Option<String>,
    ) -> claude_agent_sdk::Result<PermissionResult> {
        // Send to UI for display
        self.dialog_tx.send(PermissionRequest {
            tool_name: tool_name.to_string(),
            input: input.clone(),
        }).await?;

        // Wait for user response
        let result = self.response_rx.recv().await?;
        Ok(result)
    }
}
```

## Backend Channel Protocol

The GUI communicates with the in-process backend via channels:

```text
BackendCommand:
- StartFullAuto
- StopFullAuto
- StartParallel { count }
- StopParallel
- RunPrompt { prompt }
- AbortPrompt

BackendEvent:
- Metrics { sessions, summary }
- Chat { path, session_id, entries }
- Agents { agents }
- Issues { issues }
- Platform { info }
- FullAuto { metrics }
- PromptStatus { running, last_prompt }
- Status { message }
```

## Dependencies

```toml
[dependencies]
# GUI
wgpui = { path = "../wgpui", features = ["desktop"] }
wgpu = "24.0"
winit = "0.30"
pollster = "0.4"

# Agent SDK
claude-agent-sdk = { path = "../claude-agent-sdk" }

# Async
tokio = { version = "1", features = ["full"] }

# Data
serde = { version = "1", features = ["derive"] }
serde_json = "1"
rusqlite = { version = "0.32", features = ["bundled"] }

# Utilities
tracing = "0.1"
tracing-subscriber = "0.3"
chrono = { version = "0.4", features = ["serde"] }
```

## Testing Strategy

1. **Unit tests** - Backend logic and view models in isolation
2. **Integration tests** - Backend command/event wiring with mock SDK
3. **UI tests** - WGPUI layout/render passes for key panes
4. **Visual regression** - Scene snapshot comparison
5. **Performance tests** - Large session rendering and scroll

## Notes

### UX Priorities

1. **Speed** - UI should feel instant, even during long operations
2. **Clarity** - Permission dialogs must be unambiguous
3. **Control** - User should always be able to abort/interrupt
4. **Familiarity** - CC users should feel at home

### Technical Considerations

1. **Memory** - Long sessions can grow large; use lazy loading
2. **Startup** - Window should appear fast; defer heavy loading
3. **Offline** - UI works without network (shows cached sessions)
4. **Updates** - Check for CLI updates, prompt user

### Open Questions

1. How to handle multiple simultaneous permission dialogs?
   → Queue them, show count badge

2. Should session storage be shared with CLI autopilot?
   → Yes, same SQLite DB in ~/.openagents/

3. How to visualize thinking blocks without overwhelming?
   → Collapsed by default, expandable, syntax highlighted

4. What's the right window size default?
   → 1200x800, but resizable with state persistence

## Related Directives

- d-004 (Autopilot Improvement) - Metrics from GUI sessions feed back
- d-008 (Marketplace) - Skills could be browsed/installed via GUI

## References

- Claude Agent SDK: `crates/claude-agent-sdk/README.md`
- SDK Overview: `crates/claude-agent-sdk/docs/agent-sdk-overview.md`
- Claude Code Architecture Patterns: `reference/claudecode/CLAUDE_CODE_PATTERNS.md`
