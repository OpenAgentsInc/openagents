---
id: d-009
title: Autopilot GUI - Visual Agent Interface Powered by Codex Agent SDK
status: active
priority: high
created: 2025-12-21
updated: 2026-01-10T17:00:00Z
---

## Goal

Build a native WGPUI desktop GUI for Autopilot that wraps the Codex Agent SDK (Rust crate), providing a visual interface for running AI agents with real-time visibility into sessions, context, and execution. The experience should feel familiar to Codex Code users while adding the power of a rich visual interface. For the first round, permissions are auto-approved (no dedicated permissions pane).

## Background

The Codex Agent SDK provides programmatic access to Codex Code's capabilities:
- Query streaming with full message types
- Permission handling (rules-based and callback)
- Session management (continue, resume)
- Control methods (interrupt, abort, set_permission_mode)
- MCP server integration

Currently, autopilot runs headlessly via CLI. A GUI enables:
- **Real-time visibility** into agent thinking and tool execution
- **Visual permission management** instead of config files
- **Session browsing** with search and resume
- **Context inspection** to understand what the agent sees
- **Multi-agent orchestration** with visual topology

### Design Principles from Codex Code

Codex Code's CLI provides an excellent UX despite being terminal-based. Key patterns to replicate:

1. **Permission Transparency** - Show tool intent; auto-approve in phase 1, rules UI later
2. **Token Awareness** - Warning indicators when approaching context limits
3. **Abort Capability** - Cancel any operation cleanly at any time
4. **Background Tasks** - Operations can run without blocking UI
5. **Progressive Disclosure** - Verbose mode toggles detailed output
6. **Context Injection** - Git status, directory structure, CLAUDE.md loaded automatically

### Why GUI Over CLI

| Aspect | CLI | GUI |
|--------|-----|-----|
| Multi-session monitoring | Limited (tabs/tmux) | Native multi-pane |
| Permission management | Config file editing | Visual rule builder |
| Context inspection | `/context` command | Collapsible tree view |
| Token usage | Single status line | Real-time gauge/graph |
| Tool execution | Inline text | Syntax-highlighted panels |
| History browsing | `/resume` picker | Searchable timeline |
| Subagent visualization | Nested output | Node graph topology |

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AUTOPILOT GUI                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  winit EventLoop + wgpu                                                     â”‚
â”‚  WGPUI renderer + layout                                                    â”‚
â”‚  App state (entities + panes)                                               â”‚
â”‚  Backend channels (commands/events)                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Autopilot + Codex Agent SDK                             â”‚
â”‚  â€¢ Query streaming (SdkMessage types)                                       â”‚
â”‚  â€¢ Session management (continue, resume)                                    â”‚
â”‚  â€¢ Control methods (interrupt, abort, set_model)                            â”‚
â”‚  â€¢ MCP server integration                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Breakdown

> **Note**: Implementation lives in `crates/coder/` (not `crates/autopilot-gui/` as originally planned).

```
crates/coder/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs                 # WGPUI app shell (winit + wgpu)
â”‚   â”œâ”€â”€ lib.rs                  # run() entrypoint
â”‚   â”œâ”€â”€ app/                    # App state and modules
â”‚   â”‚   â”œâ”€â”€ mod.rs              # App struct and state
â”‚   â”‚   â”œâ”€â”€ state.rs            # Global state management
â”‚   â”‚   â”œâ”€â”€ agents/             # Multi-backend agent support
â”‚   â”‚   â”‚   â”œâ”€â”€ backend.rs      # AgentBackend trait
â”‚   â”‚   â”‚   â”œâ”€â”€ codex_backend.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ codex_backend.rs
â”‚   â”‚   â”‚   â””â”€â”€ registry.rs
â”‚   â”‚   â”œâ”€â”€ autopilot/          # Autopilot integration
â”‚   â”‚   â”‚   â”œâ”€â”€ handler.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ dspy_callback.rs # DSPy real-time callbacks
â”‚   â”‚   â”‚   â””â”€â”€ state.rs
â”‚   â”‚   â”œâ”€â”€ chat/               # Chat interface
â”‚   â”‚   â”œâ”€â”€ session/            # Session management
â”‚   â”‚   â”œâ”€â”€ permissions/        # Permission handling
â”‚   â”‚   â”œâ”€â”€ tools/              # Tool visualization
â”‚   â”‚   â”œâ”€â”€ config/             # Configuration
â”‚   â”‚   â””â”€â”€ ui/                 # UI rendering
â”‚   â”‚       â””â”€â”€ rendering/      # WGPUI components
â”‚   â”‚           â”œâ”€â”€ chat.rs
â”‚   â”‚           â”œâ”€â”€ chat_layout.rs
â”‚   â”‚           â”œâ”€â”€ dspy.rs     # DSPy stage visualization
â”‚   â”‚           â”œâ”€â”€ modals/     # Modal dialogs
â”‚   â”‚           â””â”€â”€ ...
```

## Success Criteria

**Overall Progress: ~40%** (Phases 1-2 complete, Phases 6-7 in progress)

| Phase | Status | Progress |
|-------|--------|----------|
| Phase 1: Core Window + Basic Chat | âœ… Complete | 100% |
| Phase 2: Tool Execution Display | âœ… Complete | 100% |
| Phase 3: Permission System | â¬œ Not Started | 0% |
| Phase 4: Context Awareness | â¬œ Not Started | 0% |
| Phase 5: Session Management | â¬œ Not Started | 0% |
| Phase 6: Thinking & Advanced Display | ðŸ”„ In Progress | 60% |
| Phase 7: Multi-Session & Orchestration | ðŸ”„ In Progress | 20% |
| Phase 8: Polish & Performance | â¬œ Not Started | 0% |
| Phase 9: Replay Viewer | â¬œ Not Started | 0% |
| Phase 10: Approval UX | â¬œ Not Started | 0% |

### Phase 1: Core Window + Basic Chat (v0.1) âœ… COMPLETE

- [x] Create `crates/coder/` with Cargo.toml (impl: coder instead of autopilot-gui)
- [x] Implement WGPUI app shell (winit + wgpu)
- [x] Pane layout with Dashboard, Chat, Context, Parallel
- [x] Single-session chat interface
- [x] Query submission via input box
- [x] Streaming message display via in-process channel
- [x] Message types: User, Assistant, System
- [x] Abort button to interrupt query
- [x] Basic error display
- [x] Permissions auto-approved (no modal in phase 1)

**CLI Command**: `coder` (will be `openagents` via d-010 unified binary)

### Phase 2: Tool Execution Display (v0.2) âœ… COMPLETE

- [x] Tool call panels with syntax highlighting
- [x] Tool progress indicators (elapsed time)
- [x] Tool result display (collapsible)
- [x] Bash output with ANSI color support
- [x] File diff visualization (old vs new)
- [x] Read file content display
- [x] Glob/Grep results as file list

### Phase 3: Permission System (v0.3)

- [ ] Permission dialog component (Allow/Always/Reject)
- [ ] Implement `PermissionHandler` trait with UI callbacks
- [ ] Permission rule storage in SQLite
- [ ] Visual permission manager view
- [ ] Pattern-based rules (e.g., `Bash(npm:*)`)
- [ ] Per-session vs persistent permissions
- [ ] Safe command auto-approval (git status, etc.)

### Phase 4: Context Awareness (v0.4)

- [ ] Context inspector view (collapsible tree)
- [ ] Git status display (branch, changes, commits)
- [ ] Directory structure visualization
- [ ] CLAUDE.md content display
- [ ] Token usage gauge (warning at 60%, error at 80%)
- [ ] Context size breakdown by source
- [ ] Compact button with confirmation

### Phase 5: Session Management (v0.5)

- [ ] Session list view with search
- [ ] Session metadata (timestamp, model, turns, cost)
- [ ] Resume session from list
- [ ] Fork session (branch from point)
- [ ] Session naming and tagging
- [ ] Delete/archive sessions
- [ ] Session comparison view

### Phase 6: Thinking & Advanced Display (v0.6) ðŸ”„ IN PROGRESS

- [x] Thinking block display (collapsible, styled)
- [x] Toggle thinking visibility
- [ ] Extended thinking (ultrathink) support
- [ ] Subagent visualization (nested or tabbed)
- [ ] Agent hierarchy view
- [x] Cost tracking per session/agent
- [x] **DSPy callbacks for real-time LLM visibility** (2026-01-10)
  - UiDspyCallback bridges dsrs events to UI
  - Module lifecycle display
  - LLM inference progress indicators
  - Optimizer status visualization

### Phase 7: Multi-Session & Orchestration (v0.7) ðŸ”„ IN PROGRESS

- [ ] Multi-pane session view
- [x] **Multi-backend agent support** (Codex + Codex) (2026-01-10)
  - AgentBackend trait abstraction
  - Codex backend (codex-agent-sdk)
  - Codex backend (codex-agent-sdk)
  - Agent backends pane for selection
- [ ] Run multiple agents in parallel
- [ ] Agent topology graph (subagent relationships)
- [ ] Cross-session context sharing
- [ ] Session templates (save/load configurations)

### Phase 8: Polish & Performance (v0.8)

- [ ] Keyboard shortcuts (CC-compatible)
- [ ] Theme support (light/dark)
- [ ] Font/size preferences
- [ ] Window state persistence
- [ ] Lazy loading for large sessions
- [ ] Memory optimization for long conversations
- [ ] Export session (JSON, Markdown)

### Phase 9: Replay Viewer (Launch Priority)

Scrub-able replay of completed Autopilot runs for demos and review.

- [ ] Timeline scrubber with playback controls (play, pause, 1x/2x/4x)
- [ ] "Skip to outcomes" button (jump to PR creation)
- [ ] Inline diff display (files changed, highlighted)
- [ ] Tool call visualization with syntax highlighting
- [ ] Receipts panel:
  - Tests run / passed / failed
  - CI status
  - Exit codes
  - Duration breakdown
- [ ] Cost + duration + APM display in header
- [ ] Share replay link (for web viewer)
- [ ] Download replay bundle
- [ ] Annotations / bookmarks during playback

### Phase 10: Approval UX (Launch Priority)

Visual approval flow for pending Autopilot actions.

- [ ] Pending approvals badge in header
- [ ] Approval dialog component:
  - Show exact action being requested
  - Context: which file, which command
  - Risk level indicator
- [ ] Approval options:
  - "Allow once" - this specific action
  - "Allow for this repo" - all similar actions in repo
  - "Allow always" - add to permanent rules
  - "Deny" - reject and continue
  - "Deny and stop" - reject and abort session
- [ ] Approval history view
- [ ] Bulk approve for multiple pending items
- [ ] Auto-approve rules management

## Key Features (Codex Code Parity)

### Must Replicate from Codex Code

| Feature | CC Implementation | GUI Approach |
|---------|-------------------|--------------|
| Tool permissions | Config file + runtime prompt | Visual dialog + rules DB |
| Context injection | Git status, LS, CLAUDE.md | Same, plus visual inspector |
| Token warnings | Status line percentage | Real-time gauge with thresholds |
| Conversation compact | `/compact` command | Button with preview |
| Session resume | `/resume` selector | Searchable session list |
| Abort | Ctrl+C / ESC | Button + keyboard shortcut |
| Verbose mode | `/config` toggle | View option toggle |
| Background tasks | Bash backgrounding | Async panel display |

### New GUI-Only Features

1. **Visual Permission Builder** - Drag-drop rule creation, regex testing
2. **Context Diff** - See what changed between compactions
3. **Agent Topology** - Interactive graph of subagent spawns
4. **Cost Dashboard** - Historical spend with breakdown
5. **Template Library** - Save/share agent configurations
6. **Collaborative View** - Multiple users watching same session

## SDK Integration Pattern

```rust
use codex_agent_sdk::{query, QueryOptions, SdkMessage, PermissionHandler, PermissionResult};
use tokio::sync::broadcast;

pub struct GuiSession {
    query: Query,
    message_tx: broadcast::Sender<SdkMessage>,
}

impl GuiSession {
    pub async fn start(prompt: &str, options: QueryOptions) -> Result<Self> {
        let (message_tx, _) = broadcast::channel(1024);
        let tx = message_tx.clone();

        // Create permission handler that routes to UI
        let permission_handler = UiPermissionHandler::new(permission_tx.clone());

        let query = query_with_permissions(
            prompt,
            options,
            Arc::new(permission_handler),
        ).await?;

        // Stream messages to UI via broadcast channel
        let mut stream = query.stream();
        tokio::spawn(async move {
            while let Some(msg) = stream.next().await {
                if let Ok(msg) = msg {
                    let _ = tx.send(msg);
                }
            }
        });

        Ok(Self { query, message_tx })
    }

    pub fn subscribe(&self) -> broadcast::Receiver<SdkMessage> {
        self.message_tx.subscribe()
    }

    pub async fn interrupt(&self) -> Result<()> {
        self.query.interrupt().await
    }

    pub async fn abort(&self) -> Result<()> {
        self.query.abort().await
    }
}

// Permission handler that shows UI dialog
struct UiPermissionHandler {
    dialog_tx: mpsc::Sender<PermissionRequest>,
    response_rx: mpsc::Receiver<PermissionResult>,
}

#[async_trait]
impl PermissionHandler for UiPermissionHandler {
    async fn can_use_tool(
        &self,
        tool_name: &str,
        input: &Value,
        _suggestions: Option<Vec<PermissionUpdate>>,
        _blocked_path: Option<String>,
        _decision_reason: Option<String>,
        _tool_use_id: &str,
        _agent_id: Option<String>,
    ) -> codex_agent_sdk::Result<PermissionResult> {
        // Send to UI for display
        self.dialog_tx.send(PermissionRequest {
            tool_name: tool_name.to_string(),
            input: input.clone(),
        }).await?;

        // Wait for user response
        let result = self.response_rx.recv().await?;
        Ok(result)
    }
}
```

## Backend Channel Protocol

The GUI communicates with the in-process backend via channels:

```text
BackendCommand:
- StartFullAuto
- StopFullAuto
- StartParallel { count }
- StopParallel
- RunPrompt { prompt }
- AbortPrompt

BackendEvent:
- Metrics { sessions, summary }
- Chat { path, session_id, entries }
- Agents { agents }
- Issues { issues }
- Platform { info }
- FullAuto { metrics }
- PromptStatus { running, last_prompt }
- Status { message }
```

## Dependencies

```toml
[dependencies]
# GUI
wgpui = { path = "../wgpui", features = ["desktop"] }
wgpu = "24.0"
winit = "0.30"
pollster = "0.4"

# Agent SDK
codex-agent-sdk = { path = "../codex-agent-sdk" }

# Async
tokio = { version = "1", features = ["full"] }

# Data
serde = { version = "1", features = ["derive"] }
serde_json = "1"
rusqlite = { version = "0.32", features = ["bundled"] }

# Utilities
tracing = "0.1"
tracing-subscriber = "0.3"
chrono = { version = "0.4", features = ["serde"] }
```

## Testing Strategy

1. **Unit tests** - Backend logic and view models in isolation
2. **Integration tests** - Backend command/event wiring with mock SDK
3. **UI tests** - WGPUI layout/render passes for key panes
4. **Visual regression** - Scene snapshot comparison
5. **Performance tests** - Large session rendering and scroll

## Notes

### UX Priorities

1. **Speed** - UI should feel instant, even during long operations
2. **Clarity** - Permission dialogs must be unambiguous
3. **Control** - User should always be able to abort/interrupt
4. **Familiarity** - CC users should feel at home

### Technical Considerations

1. **Memory** - Long sessions can grow large; use lazy loading
2. **Startup** - Window should appear fast; defer heavy loading
3. **Offline** - UI works without network (shows cached sessions)
4. **Updates** - Check for CLI updates, prompt user

### Open Questions

1. How to handle multiple simultaneous permission dialogs?
   â†’ Queue them, show count badge

2. Should session storage be shared with CLI autopilot?
   â†’ Yes, same SQLite DB in ~/.openagents/

3. How to visualize thinking blocks without overwhelming?
   â†’ Collapsed by default, expandable, syntax highlighted

4. What's the right window size default?
   â†’ 1200x800, but resizable with state persistence

## Related Directives

- d-004 (Autopilot Improvement) - Metrics from GUI sessions feed back
- d-008 (Marketplace) - Skills could be browsed/installed via GUI

## References

- Codex Agent SDK: `crates/codex-agent-sdk/README.md`
- SDK Overview: `crates/codex-agent-sdk/docs/agent-sdk-overview.md`
- Codex Code Architecture Patterns: `reference/codexcode/CLAUDE_CODE_PATTERNS.md`
