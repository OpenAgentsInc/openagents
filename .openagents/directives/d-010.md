---
id: d-010
title: Unified OpenAgents Binary Architecture
status: completed
priority: high
created: 2025-12-21
updated: 2025-12-25T14:16:58Z
---

## Summary

All OpenAgents functionality is unified into a single `openagents` binary. Running `openagents` launches the WGPUI Autopilot Control Room by default, while CLI subcommands expose the rest of the functionality.

**Status: COMPLETE** - Implementation finished 2025-12-21.

**Integration Note:** `openagents autopilot` and `openagents daemon` delegate to the `autopilot`/`autopilotd` binaries when present so the unified CLI remains the user-facing entrypoint. Unknown autopilot subcommands are forwarded directly to the autopilot binary. Override discovery with `OPENAGENTS_AUTOPILOT_BIN` and `OPENAGENTS_AUTOPILOTD_BIN` if needed.

## Where to Put New Code

This section tells future agents exactly where different types of code belong.

### Adding a New CLI Subcommand

1. **Create wrapper in `src/cli/`** - Add `src/cli/yourfeature.rs`
2. **Add to `src/cli/mod.rs`** - Export the new module
3. **Wire into `src/main.rs`** - Add variant to `Commands` enum and match arm

Example structure:
```rust
// src/cli/yourfeature.rs
use clap::Subcommand;

#[derive(Subcommand)]
pub enum YourFeatureCommands {
    DoSomething { ... },
}

pub async fn handle(cmd: YourFeatureCommands) -> anyhow::Result<()> {
    match cmd {
        YourFeatureCommands::DoSomething { .. } => { ... }
    }
}
```

### Adding a New WGPUI Screen

1. **Add view in `crates/autopilot-gui/src/views/`** - Create `yourfeature.rs`
2. **Wire into `crates/autopilot-gui/src/app.rs`** - Add pane layout + routing
3. **Reuse WGPUI components** - Pull from `crates/wgpui/src/components`
4. **New app?** Create a new WGPUI crate and add a CLI subcommand to launch it

### Adding Core Business Logic

**DO NOT put business logic in `src/`**. The unified binary is just a thin wrapper.

1. **Create or extend a crate in `crates/`** - Business logic lives in library crates
2. **Export public API from `lib.rs`** - Make types and functions accessible
3. **Call from `src/cli/` or a WGPUI app** - e.g. `crates/autopilot-gui/src/backend`

### Adding UI Components

1. **Shared components go in `crates/wgpui/src/components/`** - Atoms, molecules, panes
2. **Feature-specific views stay in feature crates** - e.g. `crates/autopilot-gui/src/views/`
3. **Layout/navigation in app shells** - e.g. `crates/autopilot-gui/src/app.rs`

### Adding Backend Channels

1. **Define commands/events in `crates/autopilot-gui/src/backend/`**
2. **Send updates over `mpsc` to the UI thread**
3. **Trigger re-render via WGPUI invalidation**

---

## Current Architecture

### Directory Structure

```
openagents/                      # Workspace root
├── Cargo.toml                   # Workspace + unified binary config
├── src/                         # Unified binary source (THIN WRAPPER ONLY)
│   ├── main.rs                  # Entry point with clap CLI
│   ├── cli/                     # CLI subcommand handlers
│   │   ├── mod.rs
│   │   ├── wallet.rs            # openagents wallet ...
│   │   ├── marketplace.rs       # openagents marketplace ...
│   │   ├── autopilot.rs         # openagents autopilot ...
│   │   ├── gitafter.rs          # openagents gitafter ...
│   │   └── daemon.rs            # openagents daemon ...
│
└── crates/                      # Library crates (BUSINESS LOGIC HERE)
    ├── wallet/                  # Nostr identity + Bitcoin payments
    ├── marketplace/             # Compute/skills/data marketplace
    ├── autopilot/               # Autonomous task runner + daemon
    ├── autopilot-gui/           # WGPUI Autopilot Control Room
    ├── wgpui/                   # WGPUI framework + components
    ├── gitafter/                # Git collaboration (NIP-34)
    ├── nostr/core/              # Nostr protocol types
    ├── nostr/client/            # Nostr relay connections
    ├── nostr/relay/             # Relay implementation
    ├── codex-agent-sdk/        # Codex Code integration
    ├── codex-agent-sdk/         # Codex integration
    ├── issues/                  # Issue tracking
    ├── compute/                 # NIP-90 compute provider
    └── ...
```

Legacy note: `src/gui/` remains only for archived assets and is not wired into the unified binary.

### Crate Responsibilities

| Crate | Purpose | Exports |
|-------|---------|---------|
| `wallet` | Identity, keys, Bitcoin | `cli::*`, `gui::*`, `core::*` |
| `marketplace` | Compute/skills/data market | `cli::*`, `gui::*`, models |
| `autopilot` | Task runner, daemon, metrics | `run()`, `daemon::*`, `metrics::*` |
| `autopilot-gui` | WGPUI Autopilot Control Room | `run()`, `app::*`, `backend::*` |
| `wgpui` | GPU UI framework + components | `components::*`, renderer |
| `gitafter` | Git + Nostr (NIP-34) | Desktop UI + server |
| `nostr/core` | Protocol types, NIPs | Event, Kind, Tag, etc. |
| `nostr/client` | Relay connections | NostrClient |
| `issues` | Issue tracking | Issue, IssueStore |

### GUI Stack

```
┌─────────────────────────────────────┐
│  winit EventLoop                    │
├─────────────────────────────────────┤
│  wgpu + WGPUI renderer              │
├─────────────────────────────────────┤
│  WGPUI components + panes           │
└─────────────────────────────────────┘
```

Note: GitAfter currently retains the wry/tao + Actix stack and should be migrated to WGPUI later.

### Shared State

```rust
pub struct AppState {
    pub sessions: Vec<SessionMetrics>,
    pub summary: SummaryStats,
    pub agents: Vec<AgentInfo>,
    pub chat_entries: Vec<ChatEntry>,
    pub prompt_running: bool,
    // Additional fields: issues, status, log path, etc.
}
```

---

## CLI Commands

```bash
# GUI (default)
openagents                              # Launch Autopilot Control Room

# Wallet
openagents wallet init                  # Create new identity
openagents wallet import                # Import from seed phrase
openagents wallet whoami                # Show current identity

# Marketplace
openagents marketplace compute list     # List compute providers
openagents marketplace skills list      # List available skills

# Autopilot
openagents autopilot run <issue>        # Run autonomous task
openagents autopilot dashboard          # Launch dashboard
openagents autopilot metrics show       # Show metrics
openagents autopilot baseline update    # Update baselines

# GitAfter
openagents gitafter repos               # List repositories
openagents gitafter repo <id>           # Open repository

# Daemon
openagents daemon start                 # Start supervisor daemon
openagents daemon stop                  # Stop daemon
openagents daemon status                # Check daemon status
openagents daemon restart-worker        # Restart worker process
```

---

## Patterns & Conventions

### WGPUI View Pattern

```rust
// crates/autopilot-gui/src/views/yourfeature.rs
use wgpui::prelude::*;
use crate::state::AppState;

pub fn view(cx: &mut ViewContext<AppState>) -> impl Element {
    div().child(text("Your Feature"))
}
```

### CLI Handler Pattern

```rust
// src/cli/yourfeature.rs
use clap::Subcommand;

#[derive(Subcommand)]
pub enum YourFeatureCommands {
    /// Do something useful
    DoThing {
        #[arg(short, long)]
        name: String,
    },
}

pub async fn handle(cmd: YourFeatureCommands) -> anyhow::Result<()> {
    match cmd {
        YourFeatureCommands::DoThing { name } => {
            // Call into library crate
            yourfeature_crate::do_thing(&name).await?;
            println!("Done: {}", name);
            Ok(())
        }
    }
}
```

### Backend Channel Pattern

```rust
// Send command to backend thread
backend.sender.send(BackendCommand::RunPrompt { prompt })?;

// Handle events on the UI thread
if let Ok(event) = backend.receiver.try_recv() {
    app.apply(event);
    cx.notify();
}
```

---

## Key Files Reference

| File | Purpose |
|------|---------|
| `src/main.rs` | Entry point, CLI parsing, command dispatch |
| `crates/autopilot-gui/src/app.rs` | WGPUI pane layout + app shell |
| `crates/autopilot-gui/src/backend/mod.rs` | Backend channels + integration |
| `crates/autopilot-gui/src/views/*` | Pane views (dashboard/chat/context/parallel) |
| `crates/wallet/src/lib.rs` | Wallet library exports |
| `crates/autopilot/src/lib.rs` | Autopilot library exports |
| `crates/wgpui/src/components/*` | Shared WGPUI components |

---

## What Was Removed

The following were eliminated during unification:

| Removed | Replaced By |
|---------|-------------|
| `crates/desktop/` | WGPUI app shells (e.g. `crates/autopilot-gui/`) |
| `wallet` binary | `openagents wallet` |
| `marketplace` binary | `openagents marketplace` |
| `autopilot` binary | `openagents autopilot` |
| `autopilotd` binary | `openagents daemon` |
| `autopilot-gui` binary | `openagents` default UI |
| `gitafter` binary | `openagents gitafter` |

---

## Systemd Integration

Daemon runs via systemd user service:

```bash
# Service file: crates/autopilot/systemd/autopilotd.service
systemctl --user start autopilotd
systemctl --user status autopilotd

# Commands use unified binary
ExecStart=~/.cargo/bin/openagents daemon start --workdir ~/code/openagents --project openagents
ExecStop=~/.cargo/bin/openagents daemon stop
```

Baseline updates:
```bash
# Timer: systemd/autopilot-baseline-update.timer
# Runs: openagents autopilot baseline update
```

---

## Adding a New Feature Module

Complete checklist for adding a major new feature:

1. **Create library crate** (if substantial)
   ```bash
   mkdir -p crates/yourfeature/src
   # Add to workspace members in Cargo.toml
   ```

2. **Implement business logic in crate**
   - `crates/yourfeature/src/lib.rs` - Public exports
   - `crates/yourfeature/src/core.rs` - Core logic
   - `crates/yourfeature/src/cli.rs` - CLI command types (optional)

3. **Add CLI wrapper**
   - Create `src/cli/yourfeature.rs`
   - Add to `src/cli/mod.rs`
   - Add enum variant + match arm in `src/main.rs`

4. **Add WGPUI screens** (if has UI)
   - Create a view in `crates/<feature>-gui/src/views/`
   - Wire into the app shell (`app.rs`)
   - Connect backend channels for data/commands

5. **Add dependency to unified binary**
   - Add `yourfeature = { path = "crates/yourfeature" }` to root Cargo.toml

6. **Test**
   - `cargo build --bin openagents`
   - `./target/debug/openagents yourfeature --help`
   - `./target/debug/openagents` (check GUI tab)

---

## Related Directives

- d-003 (Wallet) - Wallet library architecture
- d-008 (Marketplace) - Marketplace library architecture
- d-009 (Autopilot GUI) - Autopilot views and dashboard

## History

- 2025-12-21: Initial implementation completed
  - Created unified binary structure in `src/`
  - Removed all standalone binaries
  - Deleted `crates/desktop/` (replaced by WGPUI app shells)
  - Updated systemd files for `openagents daemon`
  - Updated AGENTS.md with new commands
