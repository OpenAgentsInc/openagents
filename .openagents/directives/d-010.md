---
id: d-010
title: Unified OpenAgents Binary Architecture
status: completed
priority: high
created: 2025-12-21
updated: 2025-12-21
---

## Summary

All OpenAgents functionality is unified into a single `openagents` binary. This binary launches a tabbed GUI by default and exposes all functionality through CLI subcommands.

**Status: COMPLETE** - Implementation finished 2025-12-21.

## Where to Put New Code

This section tells future agents exactly where different types of code belong.

### Adding a New CLI Subcommand

1. **Create wrapper in `src/cli/`** - Add `src/cli/yourfeature.rs`
2. **Add to `src/cli/mod.rs`** - Export the new module
3. **Wire into `src/main.rs`** - Add variant to `Commands` enum and match arm

Example structure:
```rust
// src/cli/yourfeature.rs
use clap::Subcommand;

#[derive(Subcommand)]
pub enum YourFeatureCommands {
    DoSomething { ... },
}

pub async fn handle(cmd: YourFeatureCommands) -> anyhow::Result<()> {
    match cmd {
        YourFeatureCommands::DoSomething { .. } => { ... }
    }
}
```

### Adding a New GUI Tab/Route

1. **Create route handler in `src/gui/routes/`** - Add `src/gui/routes/yourfeature.rs`
2. **Add to `src/gui/routes/mod.rs`** - Export module and add to `configure_routes()`
3. **Add tab to `src/gui/views/layout.rs`** - Add navigation tab
4. **Add Tab variant to `src/gui/state.rs`** - If tracking active tab

Routes mount at `/yourfeature/*` and return Maud HTML fragments for HTMX.

### Adding Core Business Logic

**DO NOT put business logic in `src/`**. The unified binary is just a thin wrapper.

1. **Create or extend a crate in `crates/`** - Business logic lives in library crates
2. **Export public API from `lib.rs`** - Make types and functions accessible
3. **Call from `src/cli/` or `src/gui/routes/`** - Thin wrapper only

### Adding UI Components

1. **Shared components go in `crates/ui/`** - Buttons, forms, icons, etc.
2. **Feature-specific views stay in feature crates** - `crates/wallet/src/gui/views/`
3. **Layout/navigation in `src/gui/views/`** - Unified shell only

### Adding WebSocket Handlers

1. **Use the shared `WsBroadcaster` in `src/gui/ws.rs`**
2. **Feature-specific WS routes in `src/gui/routes/yourfeature.rs`**
3. **Broadcast updates via `state.broadcaster.send()`**

---

## Current Architecture

### Directory Structure

```
openagents/                      # Workspace root
├── Cargo.toml                   # Workspace + unified binary config
├── src/                         # Unified binary source (THIN WRAPPER ONLY)
│   ├── main.rs                  # Entry point with clap CLI
│   ├── cli/                     # CLI subcommand handlers
│   │   ├── mod.rs
│   │   ├── wallet.rs            # openagents wallet ...
│   │   ├── marketplace.rs       # openagents marketplace ...
│   │   ├── autopilot.rs         # openagents autopilot ...
│   │   ├── agentgit.rs          # openagents agentgit ...
│   │   └── daemon.rs            # openagents daemon ...
│   │
│   └── gui/                     # Unified GUI shell
│       ├── mod.rs
│       ├── app.rs               # Window creation (wry/tao)
│       ├── server.rs            # Unified Actix server
│       ├── state.rs             # AppState (broadcaster, active_tab)
│       ├── ws.rs                # WsBroadcaster for live updates
│       ├── routes/              # Route mounting
│       │   ├── mod.rs           # configure_routes()
│       │   ├── wallet.rs        # /wallet/*
│       │   ├── marketplace.rs   # /marketplace/*
│       │   ├── autopilot.rs     # /autopilot/*
│       │   ├── agentgit.rs      # /git/*
│       │   └── daemon.rs        # /daemon/*
│       └── views/
│           ├── mod.rs
│           └── layout.rs        # Tabbed navigation shell
│
└── crates/                      # Library crates (BUSINESS LOGIC HERE)
    ├── wallet/                  # Nostr identity + Bitcoin payments
    ├── marketplace/             # Compute/skills/data marketplace
    ├── autopilot/               # Autonomous task runner + daemon
    ├── autopilot-gui/           # Autopilot-specific views
    ├── agentgit/                # Git collaboration (NIP-34)
    ├── ui/                      # Shared Maud/HTMX components
    ├── nostr/core/              # Nostr protocol types
    ├── nostr/client/            # Nostr relay connections
    ├── nostr/relay/             # Relay implementation
    ├── claude-agent-sdk/        # Claude Code integration
    ├── codex-agent-sdk/         # Codex integration
    ├── issues/                  # Issue tracking
    ├── compute/                 # NIP-90 compute provider
    └── ...
```

### Crate Responsibilities

| Crate | Purpose | Exports |
|-------|---------|---------|
| `wallet` | Identity, keys, Bitcoin | `cli::*`, `gui::*`, `core::*` |
| `marketplace` | Compute/skills/data market | `cli::*`, `gui::*`, models |
| `autopilot` | Task runner, daemon, metrics | `run()`, `daemon::*`, `metrics::*` |
| `autopilot-gui` | Autopilot visual components | Views for embedding |
| `agentgit` | Git + Nostr (NIP-34) | `server::*`, routes |
| `ui` | Shared UI components | Icons, buttons, forms |
| `nostr/core` | Protocol types, NIPs | Event, Kind, Tag, etc. |
| `nostr/client` | Relay connections | NostrClient |
| `issues` | Issue tracking | Issue, IssueStore |

### GUI Stack

```
┌─────────────────────────────────────┐
│  wry/tao (native window)            │
├─────────────────────────────────────┤
│  Actix-web (local HTTP server)      │
├─────────────────────────────────────┤
│  Maud (HTML templating)             │
├─────────────────────────────────────┤
│  HTMX (dynamic updates)             │
├─────────────────────────────────────┤
│  WebSocket (live push updates)      │
└─────────────────────────────────────┘
```

### Shared State

```rust
pub struct AppState {
    pub broadcaster: Arc<WsBroadcaster>,  // WebSocket broadcast
    pub active_tab: RwLock<Tab>,          // Current UI tab
    // Future: identity, nostr_client, etc.
}
```

---

## CLI Commands

```bash
# GUI (default)
openagents                              # Launch tabbed GUI

# Wallet
openagents wallet init                  # Create new identity
openagents wallet import                # Import from seed phrase
openagents wallet whoami                # Show current identity

# Marketplace
openagents marketplace compute list     # List compute providers
openagents marketplace skills list      # List available skills

# Autopilot
openagents autopilot run <issue>        # Run autonomous task
openagents autopilot dashboard          # Launch dashboard
openagents autopilot metrics show       # Show metrics
openagents autopilot baseline update    # Update baselines

# AgentGit
openagents agentgit repo list           # List repositories
openagents agentgit issues              # Browse issues

# Daemon
openagents daemon start                 # Start supervisor daemon
openagents daemon stop                  # Stop daemon
openagents daemon status                # Check daemon status
openagents daemon restart-worker        # Restart worker process
```

---

## Patterns & Conventions

### Route Handler Pattern

```rust
// src/gui/routes/yourfeature.rs
use actix_web::{web, HttpResponse};
use maud::html;
use crate::gui::state::AppState;

pub fn configure(cfg: &mut web::ServiceConfig) {
    cfg.service(
        web::scope("/yourfeature")
            .route("/", web::get().to(index))
            .route("/action", web::post().to(action))
    );
}

async fn index(state: web::Data<AppState>) -> HttpResponse {
    let content = html! {
        div {
            h1 { "Your Feature" }
        }
    };
    HttpResponse::Ok().content_type("text/html").body(content.into_string())
}
```

### CLI Handler Pattern

```rust
// src/cli/yourfeature.rs
use clap::Subcommand;

#[derive(Subcommand)]
pub enum YourFeatureCommands {
    /// Do something useful
    DoThing {
        #[arg(short, long)]
        name: String,
    },
}

pub async fn handle(cmd: YourFeatureCommands) -> anyhow::Result<()> {
    match cmd {
        YourFeatureCommands::DoThing { name } => {
            // Call into library crate
            yourfeature_crate::do_thing(&name).await?;
            println!("Done: {}", name);
            Ok(())
        }
    }
}
```

### WebSocket Broadcast Pattern

```rust
// When something changes that clients should know about
state.broadcaster.send("event-type", &payload);

// Client-side (HTMX/JS)
// ws.onmessage = (e) => { /* handle update */ }
```

---

## Key Files Reference

| File | Purpose |
|------|---------|
| `src/main.rs` | Entry point, CLI parsing, command dispatch |
| `src/gui/app.rs` | Window creation with wry/tao |
| `src/gui/server.rs` | Actix server setup |
| `src/gui/routes/mod.rs` | All route configuration |
| `src/gui/views/layout.rs` | Base HTML with tab navigation |
| `crates/wallet/src/lib.rs` | Wallet library exports |
| `crates/autopilot/src/lib.rs` | Autopilot library exports |
| `crates/ui/src/lib.rs` | Shared UI components |

---

## What Was Removed

The following were eliminated during unification:

| Removed | Replaced By |
|---------|-------------|
| `crates/desktop/` | `src/gui/` (entire crate deleted) |
| `wallet` binary | `openagents wallet` |
| `marketplace` binary | `openagents marketplace` |
| `autopilot` binary | `openagents autopilot` |
| `autopilotd` binary | `openagents daemon` |
| `autopilot-gui` binary | Integrated into GUI tabs |
| `agentgit` binary | `openagents agentgit` |

---

## Systemd Integration

Daemon runs via systemd user service:

```bash
# Service file: crates/autopilot/systemd/autopilotd.service
systemctl --user start autopilotd
systemctl --user status autopilotd

# Commands use unified binary
ExecStart=~/.cargo/bin/openagents daemon start --workdir ~/code/openagents --project openagents
ExecStop=~/.cargo/bin/openagents daemon stop
```

Baseline updates:
```bash
# Timer: systemd/autopilot-baseline-update.timer
# Runs: openagents autopilot baseline update
```

---

## Adding a New Feature Module

Complete checklist for adding a major new feature:

1. **Create library crate** (if substantial)
   ```bash
   mkdir -p crates/yourfeature/src
   # Add to workspace members in Cargo.toml
   ```

2. **Implement business logic in crate**
   - `crates/yourfeature/src/lib.rs` - Public exports
   - `crates/yourfeature/src/core.rs` - Core logic
   - `crates/yourfeature/src/cli.rs` - CLI command types (optional)

3. **Add CLI wrapper**
   - Create `src/cli/yourfeature.rs`
   - Add to `src/cli/mod.rs`
   - Add enum variant + match arm in `src/main.rs`

4. **Add GUI routes** (if has UI)
   - Create `src/gui/routes/yourfeature.rs`
   - Add to `src/gui/routes/mod.rs`
   - Add tab in `src/gui/views/layout.rs`
   - Add Tab variant in `src/gui/state.rs`

5. **Add dependency to unified binary**
   - Add `yourfeature = { path = "crates/yourfeature" }` to root Cargo.toml

6. **Test**
   - `cargo build --bin openagents`
   - `./target/debug/openagents yourfeature --help`
   - `./target/debug/openagents` (check GUI tab)

---

## Related Directives

- d-003 (Wallet) - Wallet library architecture
- d-008 (Marketplace) - Marketplace library architecture
- d-009 (Autopilot GUI) - Autopilot views and dashboard

## History

- 2025-12-21: Initial implementation completed
  - Created unified binary structure in `src/`
  - Removed all standalone binaries
  - Deleted `crates/desktop/` (merged into `src/gui/`)
  - Updated systemd files for `openagents daemon`
  - Updated CLAUDE.md with new commands
