---
id: d-012
title: No Stubs - Production-Ready Code Only
status: active
priority: urgent
created: 2025-12-21
updated: 2025-12-21
---

## Directive

**All code must be production-ready or REMOVED. No stubs. No placeholders. No "NotImplemented" errors. No TODOs that ship.**

This is a zero-tolerance policy. Every line of code in this repository must either:
1. Work correctly in production as designed, OR
2. Be REMOVED ENTIRELY if we don't need it yet

There is no middle ground.

**CRITICAL: Replacing stubs with `NotImplemented` or `Error::NotSupported` errors is NOT acceptable.** This is just a different kind of stub. If the functionality isn't ready, REMOVE THE CODE PATH ENTIRELY. Don't leave dead code that returns errors - that's still incomplete code taking up space and confusing users.

## What This Means

### Forbidden Patterns

```rust
// FORBIDDEN: Stub implementations
fn get_balance(&self) -> Result<u64> {
    todo!()
}

// FORBIDDEN: Placeholder returns
fn fetch_data(&self) -> Vec<Item> {
    vec![]  // TODO: implement
}

// FORBIDDEN: Demo/mock behavior in production code
async fn handle_websocket(&self, msg: Message) {
    // Echo for now
    self.send(msg).await;
}

// FORBIDDEN: Unimplemented trait methods
fn process(&self) -> Result<()> {
    unimplemented!()
}

// FORBIDDEN: Panic placeholders
fn calculate(&self) -> f64 {
    panic!("not yet implemented")
}

// FORBIDDEN: Silent no-ops
fn save(&self) {
    // TODO: implement persistence
}
```

### Required Patterns

```rust
// CORRECT: Real implementation that works
fn get_balance(&self) -> Result<u64> {
    let balance = self.wallet.sync().await?;
    Ok(balance.confirmed)
}

// CORRECT: Code REMOVED entirely until ready
// (The function simply doesn't exist in the codebase)
// When Breez SDK is integrated, add get_balance() then

// CORRECT: Feature-gated incomplete code (not compiled by default)
#[cfg(feature = "experimental")]
fn experimental_feature(&self) -> Result<()> {
    // Only compiled when explicitly enabled
}
```

### WRONG Patterns (These Are Still Stubs!)

```rust
// WRONG: "NotImplemented" error is still a stub!
fn unsupported_operation(&self) -> Result<()> {
    Err(Error::NotImplemented("Coming soon"))  // DELETE THIS FUNCTION
}

// WRONG: Printing a message and returning Ok is a stub!
fn pending_feature(&self) -> Result<()> {
    println!("This feature is coming soon");
    Ok(())  // DELETE THIS FUNCTION
}

// WRONG: Returning empty data is a stub!
fn get_items(&self) -> Vec<Item> {
    vec![]  // DELETE THIS FUNCTION
}
```

**If you can't implement it NOW, delete it. Add it back when you can.**

## Rationale

The 2025-12-21 audit (docs/logs/20251221/1349-audit.md) found extensive stub code across the codebase:

| Location | Issue |
|----------|-------|
| `crates/spark/src/wallet.rs` | Balance, sync, address all stubbed with TODOs |
| `crates/wallet/src/cli/bitcoin.rs` | Payment commands print warnings, return empty |
| `crates/autopilot/src/dashboard.rs` | WebSocket is echo-only, not real metrics |
| `crates/autopilot-gui/src/server/ws.rs` | Demo handler with simulated tool calls |
| `crates/marketplace/src/compute/consumer.rs` | Network operations marked TODO |
| `crates/marketplace/src/skills/browse.rs` | Relay fetching not implemented |
| `crates/compute/src/services/ollama_service.rs` | Explicitly stubbed |

This creates:
- **False confidence**: Code appears complete but doesn't work
- **Hidden failures**: Users encounter silent no-ops
- **Technical debt**: Stubs accumulate faster than implementations
- **Audit confusion**: Difficult to assess actual system capability

## Rules

### Rule 1: Never Commit Stubs

Before committing, verify:
- No `todo!()`, `unimplemented!()`, or `panic!("not implemented")`
- No functions that return dummy/empty values
- No "demo" or "echo" handlers in production paths
- No `// TODO` comments on code that ships

### Rule 2: Comment Out Incomplete Code

If you can't finish an implementation:

```rust
// === BLOCKED: Spark wallet integration ===
// Waiting for: Breez SDK dependency (see d-001)
// When ready: Uncomment and implement SparkWallet::get_balance()
//
// pub async fn get_balance(&self) -> Result<u64> {
//     self.spark.get_balance().await
// }
```

### Rule 3: Explicit Errors Over Silent Failures

```rust
// BAD: Silent failure
fn send_payment(&self, _amount: u64) -> Result<()> {
    Ok(())  // Does nothing
}

// GOOD: Explicit error
fn send_payment(&self, _amount: u64) -> Result<()> {
    Err(Error::NotConfigured(
        "Lightning payments not available. Initialize wallet first."
    ))
}
```

### Rule 4: Feature Gates for Experimental Code

```rust
// Code that's not production-ready can be feature-gated
#[cfg(feature = "experimental-payments")]
pub mod lightning {
    // Work in progress - only compiled with explicit flag
}
```

### Rule 5: CLI Commands Must Work or Not Exist

```rust
// BAD: Command exists but doesn't work
Commands::Balance => {
    println!("TODO: implement balance check");
    Ok(())
}

// GOOD: Command removed until implemented
// Balance command will be added when Spark integration is complete

// ALSO GOOD: Command exists with clear feedback
Commands::Balance => {
    return Err(anyhow!("Balance checking requires wallet setup. Run: openagents wallet init"));
}
```

## Enforcement

### Pre-Commit Check

Add to `.githooks/pre-commit`:
```bash
# Check for stub patterns
if grep -rn --include="*.rs" -E "(todo!\(\)|unimplemented!\(\)|panic!\(\".*not.*implement)" src/ crates/; then
    echo "ERROR: Stub code detected. See d-012."
    exit 1
fi
```

### Code Review Checklist

- [ ] No `todo!()` or `unimplemented!()` macros
- [ ] No functions returning placeholder values
- [ ] No "demo" or "echo" behavior in production code
- [ ] Incomplete code is commented out with explanation
- [ ] CLI commands either work or don't exist

### Audit Trigger

Any stub found in production code triggers:
1. Immediate fix or comment-out
2. Root cause analysis (why was it committed?)
3. Process improvement to prevent recurrence

## Remediation Plan

Existing stubs must be addressed:

### Priority 1: User-Facing Commands
- `crates/wallet/src/cli/bitcoin.rs` - Payment commands
- `crates/autopilot/src/dashboard.rs` - WebSocket streaming

### Priority 2: Core Infrastructure
- `crates/spark/src/wallet.rs` - Wallet operations
- `crates/marketplace/src/compute/consumer.rs` - Job submission

### Priority 3: Secondary Features
- `crates/marketplace/src/skills/browse.rs` - Relay integration
- `crates/compute/src/services/ollama_service.rs` - Ollama service

For each stub:
1. Implement fully NOW, OR
2. REMOVE the code path entirely

**Do NOT:**
- Replace with `NotImplemented` errors
- Comment out and leave in codebase
- Return empty/dummy values

## Exceptions

None. If code exists, it works. If it doesn't work, it doesn't exist.

The only acceptable incomplete code is:
- Commented out with clear blocker explanation
- Behind a non-default feature flag
- In a branch, not main

## Related

- docs/logs/20251221/1349-audit.md - Audit that identified stub prevalence
- d-001 (Spark) - Blocked wallet stubs
- d-003 (Wallet) - Payment flow stubs
- d-004 (Autopilot) - Dashboard streaming stubs
- d-008 (Marketplace) - Network operation stubs
- d-009 (Autopilot GUI) - WebSocket handler stubs
