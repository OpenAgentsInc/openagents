---
id: d-014
title: Full End-to-End NIP-SA and Bifrost Integration Tests
status: active
priority: high
created: 2025-12-22
updated: 2025-12-22
---

## Goal

Implement comprehensive end-to-end tests for the full NIP-SA (Sovereign Agents) protocol stack, including Bifrost threshold operations over real Nostr relays. These tests will verify that all components work together correctly in realistic scenarios.

## Background

The NIP-SA types and FROSTR/Bifrost implementations are complete:
- NIP-SA event types (39200-39231) in `crates/nostr/core/src/nip_sa/`
- Threshold keygen, signing, and ECDH in `crates/frostr/src/`
- Bifrost peer coordination in `crates/frostr/src/bifrost/`
- Test relay infrastructure in `crates/nostr/tests/integration/`

What's missing: E2E tests that exercise the full stack over real Nostr relays to verify interoperability.

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    E2E Test Infrastructure                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐       │
│  │  Test Relay  │    │  Peer 1      │    │  Peer 2      │       │
│  │  (in-proc)   │◄───┤  (FrostShare)│◄───┤  (FrostShare)│       │
│  └──────┬───────┘    └──────────────┘    └──────────────┘       │
│         │                                                         │
│         ▼                                                         │
│  ┌──────────────────────────────────────────────────────┐       │
│  │              Test Scenarios                            │       │
│  │  • Bifrost signing round                              │       │
│  │  • Bifrost ECDH round                                 │       │
│  │  • NIP-SA event publishing                            │       │
│  │  • Full agent lifecycle                               │       │
│  └──────────────────────────────────────────────────────┘       │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

## Success Criteria

### Phase 1: Bifrost E2E Tests (crates/frostr/tests/bifrost_e2e.rs)

- [x] Create test file `crates/frostr/tests/bifrost_e2e.rs`
- [x] Add test: `test_bifrost_signing_2_of_3_over_relay`
  - Start test relay using `nostr_tests::start_test_relay()`
  - Generate 2-of-3 FROST shares using `generate_key_shares(2, 3)`
  - Create 2 BifrostNode instances pointing at test relay
  - Execute signing round with event hash
  - Verify signature is valid Schnorr signature for group public key
- [x] Add test: `test_bifrost_ecdh_2_of_3_over_relay`
  - Start test relay
  - Generate 2-of-3 FROST shares
  - Create 2 BifrostNode instances
  - Execute ECDH round with peer public key
  - Verify shared secret matches expected (single-key ECDH for verification)
- [x] Add test: `test_bifrost_peer_discovery`
  - Start test relay
  - Create BifrostNode with known peer pubkeys
  - Verify node can ping peers and track status
- [x] Add test: `test_bifrost_timeout_handling`
  - Start test relay
  - Create BifrostNode with unreachable peer
  - Verify signing fails with timeout error after configured duration
- [x] Add test: `test_bifrost_3_of_5_signing`
  - Generate 3-of-5 shares
  - Create 3 BifrostNode instances
  - Verify signing succeeds with 3 peers

### Phase 2: NIP-SA Event Tests (crates/nostr/tests/integration/nip_sa.rs)

- [x] Add module `nip_sa` to `crates/nostr/tests/integration/mod.rs`
- [x] Create test file `crates/nostr/tests/integration/nip_sa.rs`
- [x] Add test: `test_agent_profile_publish_and_fetch`
  - Create AgentProfile event (kind 39200)
  - Publish to test relay
  - Fetch via subscription filter
  - Verify profile data integrity
- [ ] Add test: `test_agent_state_encrypt_decrypt`
  - Create keypair
  - Create AgentState with goals/memory
  - Encrypt state using NIP-44 to self
  - Publish to relay
  - Fetch and decrypt
  - Verify state content matches original
- [x] Add test: `test_agent_schedule_replace`
  - Publish AgentSchedule (39202) with heartbeat
  - Publish TickRequest (39210) with event reference
  - Publish TickResult (39211) with metrics
  - Query both by e-tag
  - Verify tick lifecycle complete
- [x] Add test: `test_trajectory_session_and_events`
  - Create TrajectorySession (39230)
  - Publish multiple TrajectoryEvents (39231)
  - Query events by session reference
  - Verify event ordering by sequence
- [ ] Add test: `test_skill_license_delivery`
  - Create SkillLicense (39220) for skill
  - Create SkillDelivery (39221) as gift-wrap
  - Verify license-to-delivery linking via tags

### Phase 3: Full Agent Lifecycle (crates/frostr/tests/e2e_agent.rs)

- [ ] Create test file `crates/frostr/tests/e2e_agent.rs`
- [ ] Add test: `test_sovereign_agent_lifecycle`
  ```rust
  // 1. Generate threshold identity
  let shares = generate_key_shares(2, 3)?;
  let group_pk = shares[0].verifying_key();

  // 2. Start test relay
  let (relay, addr, _tmp) = start_test_relay(19000).await;
  let relay_url = test_relay_url(19000);

  // 3. Create and publish agent profile
  let profile = AgentProfile::new(
      group_pk.to_bytes(),
      "TestAgent",
      Some("E2E test agent"),
      ThresholdConfig { k: 2, n: 3 },
  );
  // Sign with threshold (using 2 shares)
  // Publish to relay

  // 4. Create and store encrypted state
  let state = AgentState::new(
      goals: vec!["test goal"],
      memory: serde_json::json!({"key": "value"}),
      budget: Budget { daily_limit: 1000, spent: 0 },
  );
  // Encrypt to agent pubkey
  // Publish to relay

  // 5. Fetch and decrypt state
  // Verify state round-trip

  // 6. Execute tick with trajectory
  let session = TrajectorySession::new(agent_pk, "test-run");
  // Publish session
  // Publish trajectory events
  // Publish tick result
  ```
- [ ] Add test: `test_agent_signs_with_bifrost`
  - Create agent event (profile update)
  - Sign using BifrostNode threshold signing
  - Verify signature
  - Publish signed event
- [ ] Add test: `test_agent_decrypts_dm_with_threshold_ecdh`
  - External keypair sends NIP-44 encrypted DM to agent
  - Agent uses threshold ECDH to derive shared secret
  - Agent decrypts message
  - Verify decrypted content

### Phase 4: Cross-System Integration

- [ ] Add test: `test_state_encryption_with_threshold_ecdh`
  - Agent stores encrypted state
  - Different threshold quorum fetches and decrypts
  - Verify both quorums derive same shared secret
- [ ] Add test: `test_trajectory_hash_verification`
  - Publish trajectory session and events
  - Calculate merkle hash of events
  - Verify session hash tag matches
- [ ] Add test: `test_skill_delivery_decryption`
  - Publisher encrypts skill to agent
  - Agent uses threshold ECDH to decrypt
  - Verify skill content

## Key Files to Create/Modify

| File | Purpose |
|------|---------|
| `crates/frostr/tests/bifrost_e2e.rs` | **NEW** - Bifrost over relay tests |
| `crates/nostr/tests/integration/nip_sa.rs` | **NEW** - NIP-SA event flow tests |
| `crates/nostr/tests/integration/mod.rs` | Add `pub mod nip_sa;` |
| `crates/nostr/tests/e2e_agent.rs` | **NEW** - Full agent lifecycle tests |
| `crates/frostr/Cargo.toml` | Add dev-dependencies for nostr relay |

## Implementation Patterns

### Starting Test Relay

```rust
use nostr_tests::integration::{start_test_relay, test_relay_url};

#[tokio::test]
async fn test_something() {
    let (server, addr, _temp_dir) = start_test_relay(19001).await;
    let relay_url = test_relay_url(19001);
    // ... test code ...
}
```

### Creating Bifrost Nodes for Testing

```rust
use frostr::keygen::generate_key_shares;
use frostr::bifrost::{BifrostNode, BifrostConfig};

// Generate shares
let shares = generate_key_shares(2, 3).expect("keygen");

// Create config pointing at test relay
let config = BifrostConfig {
    relays: vec![relay_url],
    threshold: 2,
    ..Default::default()
};

// Create nodes for different shares
let node1 = BifrostNode::new_with_share(shares[0].clone(), config.clone())?;
let node2 = BifrostNode::new_with_share(shares[1].clone(), config.clone())?;
```

### Publishing and Fetching Events

```rust
use nostr_client::{Client, Filter};
use nostr::Event;

let client = Client::new(&[relay_url]);
client.connect().await?;

// Publish
client.publish(event).await?;

// Fetch
let filter = Filter::new().kind(39200).author(agent_pk);
let events = client.fetch(&filter).await?;
```

### NIP-44 Encryption Pattern

```rust
use nostr::nip44::{encrypt, decrypt};

// Encrypt to recipient
let ciphertext = encrypt(&sender_sk, &recipient_pk, &plaintext)?;

// Decrypt (requires shared secret)
let shared_secret = threshold_ecdh(&shares[0..2], &sender_pk)?;
let plaintext = decrypt(&shared_secret, &ciphertext)?;
```

## Test Configuration

```toml
# crates/frostr/Cargo.toml additions
[dev-dependencies]
nostr-relay = { path = "../nostr/relay" }
nostr-client = { path = "../nostr/client" }
nostr-tests = { path = "../nostr/tests" }
tempfile = "3"
```

## Running Tests

```bash
# Run all E2E tests
cargo test -p frostr --test bifrost_e2e
cargo test -p nostr-tests --test integration_tests nip_sa
cargo test -p nostr-tests --test e2e_agent

# Run with logging
RUST_LOG=debug cargo test -p frostr --test bifrost_e2e -- --nocapture
```

## Dependencies

### Required Crates
- `frostr` - Threshold crypto and Bifrost
- `nostr` (core) - Event types and NIP-SA
- `nostr-client` - Relay connections
- `nostr-relay` - Test relay server
- `tokio` - Async runtime
- `tempfile` - Temporary test directories

### Related Directives
- **d-006** - NIP-SA protocol (implemented types)
- **d-007** - FROSTR implementation (implemented crypto)

## Notes

This directive focuses on **testing** the existing implementations, not implementing new features. The goal is to verify:

1. **Bifrost works over real relays** - Not just mock transport
2. **NIP-SA events survive round-trips** - Serialization/parsing correct
3. **Encryption/decryption flows work** - Threshold ECDH + NIP-44
4. **Full agent lifecycle is viable** - All pieces integrate

Tests should be deterministic and not require external relays. The in-process test relay provides isolation and reproducibility.

## Success Metric

All tests pass with `cargo test` in CI. No flaky tests. Test coverage for:
- 2-of-3 and 3-of-5 threshold configurations
- All 10 NIP-SA event kinds
- Full encrypt→publish→fetch→decrypt flow
- Error handling and timeout scenarios
