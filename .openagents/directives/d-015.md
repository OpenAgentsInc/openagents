---
id: d-015
title: Comprehensive Marketplace and Agent Commerce E2E Tests
status: active
priority: high
created: 2025-12-22
updated: 2025-12-22
---

## Goal

Implement comprehensive end-to-end tests for the marketplace (d-008), including compute jobs, skill licensing, data purchase, and trajectory contribution flows. Tests sovereign agent commerce scenarios where agents use Bifrost threshold signing (from d-014) to participate in the marketplace economy.

## Background

Building on d-014's Bifrost/NIP-SA E2E tests, this directive adds marketplace commerce testing:
- NIP-90 compute job lifecycle over real relay
- Skill discovery, licensing, and execution flows
- Data marketplace publish/purchase scenarios
- Trajectory contribution validation
- Sovereign agent commerce (agent buys compute, sells skills)
- Bitcoin payment flows (mock initially, Testnet when Breez ready)

### Implementation Status

**Ready to Test E2E:**
- Compute: job submission, provider discovery, job tracking
- Skills/Data: browse, search, filter (discovery layer)
- Trajectories: collect, redact, anonymize, contribute
- NIP-90: protocol types, DVM service with Ollama
- Bifrost: signing and ECDH (from d-014)

**Mock Required (Stubs):**
- Lightning payments (mock until Breez SDK)
- Skill install/invoke, data purchase/serve
- Revenue splits and bidding

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                 Marketplace E2E Test Infrastructure              │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐       │
│  │  Test Relay  │    │  Provider    │    │  Consumer    │       │
│  │  (in-proc)   │◄───┤  (DVM Svc)   │◄───┤  (Agent)     │       │
│  └──────┬───────┘    └──────────────┘    └──────────────┘       │
│         │                                                         │
│         ▼                                                         │
│  ┌──────────────────────────────────────────────────────┐       │
│  │              Test Scenarios                            │       │
│  │  • NIP-90 compute job lifecycle                       │       │
│  │  • Skill license and delivery                         │       │
│  │  • Data publish and purchase                          │       │
│  │  • Trajectory contribution                            │       │
│  │  • Agent commerce (Bifrost-signed transactions)       │       │
│  │  • Payment mocking (Testnet when ready)               │       │
│  └──────────────────────────────────────────────────────┘       │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

## Success Criteria

### Phase 1: NIP-90 Compute E2E (crates/marketplace/tests/compute_e2e.rs)

- [ ] Create test file `crates/marketplace/tests/compute_e2e.rs`
- [ ] Add test: `test_nip90_job_request_publish_fetch`
- [ ] Add test: `test_nip90_job_result_lifecycle`
- [ ] Add test: `test_nip90_job_feedback_flow`
- [ ] Add test: `test_nip89_provider_discovery`
- [ ] Add test: `test_dvm_service_with_relay`

### Phase 2: Skill Marketplace E2E (crates/marketplace/tests/skills_e2e.rs)

- [ ] Create test file `crates/marketplace/tests/skills_e2e.rs`
- [ ] Add test: `test_skill_browse_over_relay`
- [ ] Add test: `test_skill_license_issuance`
- [ ] Add test: `test_skill_delivery_encrypted`
- [ ] Add test: `test_skill_versioning`

### Phase 3: Data Marketplace E2E (crates/marketplace/tests/data_e2e.rs)

- [ ] Create test file `crates/marketplace/tests/data_e2e.rs`
- [ ] Add test: `test_dataset_discovery_over_relay`
- [ ] Add test: `test_dataset_publish_flow`
- [ ] Add test: `test_dataset_purchase_mock`
- [ ] Add test: `test_dataset_encrypted_delivery`

### Phase 4: Trajectory E2E (crates/marketplace/tests/trajectory_e2e.rs)

- [ ] Create test file `crates/marketplace/tests/trajectory_e2e.rs`
- [ ] Add test: `test_trajectory_collect_from_fixture`
- [ ] Add test: `test_trajectory_redaction`
- [ ] Add test: `test_trajectory_quality_validation`
- [ ] Add test: `test_trajectory_contribution_to_relay`

### Phase 5: Sovereign Agent Commerce (crates/marketplace/tests/agent_commerce_e2e.rs)

- [ ] Create test file `crates/marketplace/tests/agent_commerce_e2e.rs`
- [ ] Add test: `test_agent_submits_compute_job`
- [ ] Add test: `test_agent_purchases_skill`
- [ ] Add test: `test_agent_sells_skill`
- [ ] Add test: `test_agent_to_agent_commerce`
- [ ] Add test: `test_agent_budget_enforcement`

### Phase 6: Payment Integration (crates/marketplace/tests/payments_e2e.rs)

- [ ] Create test file `crates/marketplace/tests/payments_e2e.rs`
- [ ] Add test: `test_mock_lightning_payment`
- [ ] Add test: `test_spark_signer_derivation`
- [ ] Add test: `test_payment_flow_with_mock`
- [ ] Add cfg feature test: `test_testnet_payment` (requires breez feature)

### Phase 7: Cross-System Integration

- [ ] Add test: `test_full_marketplace_flow`
- [ ] Add test: `test_agent_commerce_with_threshold_ecdh`
- [ ] Add test: `test_trajectory_contribution_with_agent_identity`

## Prerequisites (from d-014)

- [ ] Implement BifrostNode::new_with_share constructor
- [ ] Add nostr-relay dev-dependency to frostr

## Prerequisites (new for d-015)

- [ ] Create MockPaymentService for testing without Breez SDK
- [ ] Add nostr-relay and frostr dev-dependencies to marketplace
- [ ] Implement skill publish stub for testing (d-008)
- [ ] Implement data publish stub for testing (d-008)
- [ ] Create test fixtures directory with sample trajectories

## Key Files to Create/Modify

| File | Purpose |
|------|---------|
| `crates/marketplace/tests/compute_e2e.rs` | **NEW** - NIP-90 compute tests |
| `crates/marketplace/tests/skills_e2e.rs` | **NEW** - Skill marketplace tests |
| `crates/marketplace/tests/data_e2e.rs` | **NEW** - Data marketplace tests |
| `crates/marketplace/tests/trajectory_e2e.rs` | **NEW** - Trajectory tests |
| `crates/marketplace/tests/agent_commerce_e2e.rs` | **NEW** - Sovereign agent commerce |
| `crates/marketplace/tests/payments_e2e.rs` | **NEW** - Payment flow tests |
| `crates/marketplace/Cargo.toml` | Add dev-dependencies |
| `crates/marketplace/tests/fixtures/` | **NEW** - Test fixtures directory |

## Implementation Patterns

### Mock Payment Service

```rust
/// Mock payment service for testing without Breez SDK
pub struct MockPaymentService {
    pending_payments: HashMap<String, u64>,
    completed_payments: HashSet<String>,
}

impl MockPaymentService {
    pub fn create_invoice(&mut self, amount_msats: u64) -> String {
        let invoice = format!("lnbc{}m1mock", amount_msats / 1000);
        self.pending_payments.insert(invoice.clone(), amount_msats);
        invoice
    }

    pub fn pay_invoice(&mut self, invoice: &str) -> Result<String> {
        if let Some(_amount) = self.pending_payments.remove(invoice) {
            let preimage = hex::encode(rand::random::<[u8; 32]>());
            self.completed_payments.insert(invoice.to_string());
            Ok(preimage)
        } else {
            Err(anyhow!("Invoice not found"))
        }
    }

    pub fn is_paid(&self, invoice: &str) -> bool {
        self.completed_payments.contains(invoice)
    }
}
```

### Using Test Relay with Marketplace

```rust
use nostr_tests::integration::{start_test_relay, test_relay_url};
use marketplace::compute::{JobConsumer, ProviderDiscovery};

#[tokio::test]
async fn test_compute_over_relay() {
    let (server, addr, _tmp) = start_test_relay(19100).await;
    let relay_url = test_relay_url(19100);

    let consumer = JobConsumer::new(&[&relay_url]).await?;
    let job_request = JobRequest::text_generation()
        .input_text("Hello, world!")
        .bid(1000)
        .build()?;

    let job_id = consumer.submit(job_request).await?;
}
```

### Agent Commerce with Bifrost

```rust
use frostr::keygen::generate_key_shares;
use frostr::bifrost::BifrostNode;

#[tokio::test]
async fn test_agent_purchases_skill() {
    let shares = generate_key_shares(2, 3)?;
    let agent_pk = shares[0].verifying_key();

    let node1 = BifrostNode::new_with_share(shares[0].clone(), config.clone())?;
    let node2 = BifrostNode::new_with_share(shares[1].clone(), config.clone())?;

    let license_request = SkillLicenseRequest::new(skill_id, agent_pk);
    let request_hash = license_request.hash();
    let signature = node1.sign(&request_hash).await?;

    let event = license_request.to_event_with_sig(signature)?;
    client.publish(event).await?;
}
```

### Feature-Gated Testnet Tests

```rust
#[cfg(feature = "testnet")]
#[tokio::test]
async fn test_real_testnet_payment() {
    use spark::{SparkWallet, Network};

    let wallet = SparkWallet::new(WalletConfig {
        network: Network::Testnet,
        ..Default::default()
    }).await?;

    let balance = wallet.get_balance().await?;
    assert!(balance.total_sats() > 0, "Need testnet funds");
}
```

## Test Configuration

```toml
# crates/marketplace/Cargo.toml additions
[dev-dependencies]
nostr-relay = { path = "../nostr/relay" }
nostr-client = { path = "../nostr/client" }
nostr-tests = { path = "../nostr/tests" }
frostr = { path = "../frostr" }
spark = { path = "../spark" }
tempfile = "3"

[features]
default = []
testnet = ["spark/testnet"]
```

## Running Tests

```bash
# Run all marketplace E2E tests
cargo test -p marketplace --test compute_e2e
cargo test -p marketplace --test skills_e2e
cargo test -p marketplace --test data_e2e
cargo test -p marketplace --test trajectory_e2e
cargo test -p marketplace --test agent_commerce_e2e
cargo test -p marketplace --test payments_e2e

# Run with testnet payments (requires funded wallet)
cargo test -p marketplace --features testnet --test payments_e2e

# Run with logging
RUST_LOG=debug cargo test -p marketplace --test compute_e2e -- --nocapture
```

## Dependencies

### Required Crates
- `marketplace` - Marketplace core logic
- `frostr` - Threshold crypto and Bifrost (from d-014)
- `spark` - Bitcoin payments
- `nostr` (core) - Event types, NIP-90, NIP-89, NIP-SA
- `nostr-client` - Relay connections
- `nostr-relay` - Test relay server
- `compute` - DVM service

### Related Directives
- **d-001** - Spark SDK integration (payments)
- **d-006** - NIP-SA protocol (skill licensing)
- **d-007** - FROSTR implementation (threshold signing)
- **d-008** - Marketplace implementation (being tested)
- **d-014** - Bifrost/NIP-SA E2E tests (foundation)

## Notes

This directive builds on d-014's work to test the full agent economy:

1. **Mock-first approach**: Payment operations return NotImplemented until Breez SDK. Tests use MockPaymentService to simulate payment flows.

2. **Feature-gated real payments**: When `--features testnet` is enabled and Breez SDK is integrated, tests can use real Testnet Bitcoin.

3. **Sovereign agent commerce**: Agents using Bifrost threshold signing can participate in marketplace as buyers and sellers.

4. **Progressive complexity**: Tests build from simple relay operations → marketplace flows → agent commerce → cross-system integration.

5. **Deterministic tests**: No external services required. Test relay runs in-process, payments are mocked.

## Success Metric

All tests pass with `cargo test -p marketplace`. Test coverage for:
- NIP-90 job lifecycle (request → feedback → result)
- NIP-89 provider discovery
- Skill licensing and encrypted delivery
- Data marketplace discovery
- Trajectory contribution flow
- Agent-to-agent commerce with threshold signatures
- Payment flow (mocked, testnet-ready)
