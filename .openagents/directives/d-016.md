---
id: d-016
title: Measure Actions Per Minute (APM)
status: active
priority: high
created: 2025-12-22
updated: 2025-12-25T14:20:56Z
---

## Goal

Implement comprehensive APM (Actions Per Minute) tracking inspired by StarCraft 2's competitive metric. APM measures agent velocity and effectiveness, enabling comparison between interactive Codex Code usage and autonomous Autopilot runs.

## Background

APM is defined as:

```
APM = (messages + tool_calls) / duration_minutes
```

This metric captures how "fast" an agent is working. Key insights from existing data:
- **Codex Code direct**: ~4.5 APM (human-in-the-loop, interactive)
- **Autopilot autonomous**: ~19 APM (fully autonomous, no waiting)
- **Efficiency ratio**: Autopilot is ~4.2x faster than interactive Codex Code

### Why APM Matters

1. **Velocity tracking** - How productive is the agent per unit time?
2. **Mode comparison** - Interactive vs autonomous efficiency
3. **Regression detection** - Has a change slowed the agent down?
4. **Gamification** - Leaderboards, personal bests, improvement tracking

### Data Sources

| Source | Location | Content |
|--------|----------|---------|
| Codex Code | `~/.codex/projects/<project>/*.jsonl` | Interactive sessions |
| Autopilot | `docs/logs/YYYYMMDD/*.rlog` + `.json` | Autonomous runs |
| Metrics DB | `autopilot-metrics.db` | Aggregated session data |

## Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                         APM COLLECTION                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   Codex Code Sessions          Autopilot Trajectories              │
│   ~/.codex/projects/           docs/logs/YYYYMMDD/                  │
│          │                              │                            │
│          ▼                              ▼                            │
│   ┌─────────────┐              ┌─────────────┐                      │
│   │ JSONL Parser│              │ RLOG Parser │                      │
│   └─────────────┘              └─────────────┘                      │
│          │                              │                            │
│          └──────────┬───────────────────┘                           │
│                     ▼                                                │
│            ┌───────────────┐                                        │
│            │  APM Calculator │                                      │
│            │  (messages + tool_calls) / minutes                     │
│            └───────────────┘                                        │
│                     │                                                │
│       ┌─────────────┼─────────────┐                                 │
│       ▼             ▼             ▼                                 │
│   ┌───────┐   ┌──────────┐   ┌──────────┐                          │
│   │ CLI   │   │ Dashboard│   │ HUD/UI   │                          │
│   │ Report│   │ Display  │   │ Overlay  │                          │
│   └───────┘   └──────────┘   └──────────┘                          │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## APM Specification v1

### Formula

```
APM = (messages + tool_calls) / duration_minutes
```

Where:
- **messages**: User and assistant message count
- **tool_calls**: All tool invocations (Read, Edit, Bash, Grep, etc.)
- **duration_minutes**: Wall-clock time (not active time)

### Time Windows

| Window | Description | Use Case |
|--------|-------------|----------|
| Session | Current session only | Real-time display |
| 1h | Last 60 minutes | Recent performance |
| 6h | Last 6 hours | Work session |
| 1d | Last 24 hours | Daily comparison |
| 1w | Last 7 days | Weekly trend |
| 1m | Last 30 days | Monthly trend |
| Lifetime | All recorded data | Overall baseline |

### Tool Categories

| Category | Tools | Weight |
|----------|-------|--------|
| Code Generation | Edit, MultiEdit, Write, NotebookEdit | 1.0 |
| File Operations | Read, Glob | 1.0 |
| System Operations | Bash, BashOutput, KillShell | 1.0 |
| Search | Grep, WebSearch, WebFetch | 1.0 |
| Planning | TodoWrite, TodoRead, Task | 1.0 |
| Other | All others | 1.0 |

### Color Coding (UI Display)

| APM Range | Color | Tier |
|-----------|-------|------|
| 0-5 | Gray | Baseline |
| 5-15 | Blue | Active |
| 15-30 | Green | Productive |
| 30-50 | Amber | High Performance |
| 50+ | Gold | Elite |

## Compare/Contrast: Codex Code vs Autopilot

### Codex Code (Interactive)

**Characteristics:**
- Human-in-the-loop approval
- Wait times between actions (human reading, thinking)
- Smaller context windows (less aggressive)
- Session gaps (breaks, meetings)

**Typical APM:** 2-8 (median ~4.5)

**Data source:** `~/.codex/projects/<project>/*.jsonl`

**Calculation notes:**
- Wall-clock includes human wait time
- Actions are discrete (one at a time usually)
- Lower APM doesn't mean less effective

### Autopilot (Autonomous)

**Characteristics:**
- No human wait time
- Continuous execution until completion
- Aggressive tool parallelization
- Full context utilization

**Typical APM:** 15-30 (median ~19)

**Data source:** `docs/logs/YYYYMMDD/*.rlog` + metrics.db

**Calculation notes:**
- Pure agent velocity (no human delays)
- Higher parallelization inflates count
- Better measure of raw agent speed

### Comparison Insights

| Metric | Codex Code | Autopilot | Ratio |
|--------|-------------|-----------|-------|
| Median APM | 4.5 | 19 | 4.2x |
| Actions/Session | ~50 | ~200 | 4x |
| Session Duration | ~15 min | ~12 min | 0.8x |
| Human Wait % | ~60% | 0% | - |

**Key insight:** Autopilot is 4x faster in actions, but sessions are similar length because Codex Code has human wait time that doesn't count against effectiveness.

## Success Criteria

### Phase 1: Core APM Module
- [ ] Create `crates/autopilot/src/apm.rs` with APM calculation
- [ ] Define APMStats struct with all time windows
- [ ] Add APM fields to SessionMetrics
- [ ] Implement Codex Code JSONL parser for APM extraction
- [ ] CLI command: `cargo autopilot apm` - show current APM stats

### Phase 2: Data Collection
- [ ] Parse existing Codex Code logs from ~/.codex/projects/
- [ ] Extract APM from autopilot trajectories
- [ ] Store APM history in metrics.db
- [ ] Backfill historical APM from existing data
- [ ] CLI command: `cargo autopilot apm import`

### Phase 3: Dashboard Integration
- [ ] Add APM widget to dashboard
- [ ] Show session APM with color coding
- [ ] Display APM trends (1h, 6h, 1d, 1w, 1m)
- [ ] Compare Codex Code vs Autopilot APM
- [ ] Real-time APM via backend channels

### Phase 4: UI/HUD Overlay
- [ ] Add APM display to autopilot-gui
- [ ] Color-coded APM indicator
- [ ] Tool category breakdown
- [ ] Session vs historical comparison
- [ ] Export APM data (JSON, CSV)

### Phase 5: Analysis & Gamification
- [ ] APM baseline per project
- [ ] Regression detection for APM drops
- [ ] Personal best tracking
- [ ] Weekly APM reports
- [ ] Leaderboard (if multi-user)

## Key Files to Create/Modify

| File | Purpose |
|------|---------|
| `crates/autopilot/src/apm.rs` | **NEW** - Core APM calculation |
| `crates/autopilot/src/apm_parser.rs` | **NEW** - Codex Code JSONL parser |
| `crates/autopilot/src/metrics/mod.rs` | Add APM fields to SessionMetrics |
| `crates/autopilot-gui/src/views/dashboard.rs` | Add APM widget to dashboard pane |
| `crates/autopilot-gui/src/views/apm.rs` | **NEW** - APM UI component |
| `crates/autopilot/src/main.rs` | Add `apm` CLI subcommand |

## Database Schema Changes

```sql
-- Add to sessions table
ALTER TABLE sessions ADD COLUMN apm REAL;
ALTER TABLE sessions ADD COLUMN source TEXT DEFAULT 'autopilot'; -- 'autopilot' | 'codex'

-- New APM history table
CREATE TABLE apm_snapshots (
    id INTEGER PRIMARY KEY,
    timestamp DATETIME,
    source TEXT,  -- 'autopilot' | 'codex' | 'combined'
    window TEXT,  -- 'session' | '1h' | '6h' | '1d' | '1w' | '1m' | 'lifetime'
    apm REAL,
    actions INTEGER,
    duration_minutes REAL,
    messages INTEGER,
    tool_calls INTEGER
);

CREATE INDEX idx_apm_snapshots_source_window ON apm_snapshots(source, window);
CREATE INDEX idx_apm_snapshots_timestamp ON apm_snapshots(timestamp);
```

## CLI Commands

```bash
# Show current APM stats
cargo autopilot apm
# Output:
# APM Statistics
# ─────────────────────────────────────────
# Source        Session   1h    6h    1d    1w
# Autopilot     23.4     19.2  18.5  17.8  18.1
# Codex Code   -        4.2   4.5   4.3   4.4
# Combined      23.4     12.1  11.2  10.8  11.0

# Import Codex Code sessions
cargo autopilot apm import ~/.codex/projects/openagents/

# Show APM for specific session
cargo autopilot apm show <session-id>

# Export APM data
cargo autopilot apm export --format json --output apm-data.json
```

## Testing Strategy

1. **Unit tests** - APM calculation with known inputs
2. **Parser tests** - JSONL and RLOG parsing accuracy
3. **Integration tests** - Full pipeline from log to APM
4. **Snapshot tests** - Dashboard APM widget rendering
5. **Regression tests** - APM calculation consistency

## Notes

APM is inspired by StarCraft 2's competitive metric. In StarCraft, professional players achieve 300-500 APM. Our agents are closer to 20-50 APM, but the principle is the same: **faster = more actions = more potential impact**.

However, APM alone doesn't measure effectiveness. A high-APM session that fails to complete its task is worse than a low-APM session that succeeds. APM should be viewed alongside:
- Task completion rate
- Error rate
- Cost efficiency

APM is a velocity metric, not a quality metric.

## Related Directives

- d-004 (Autopilot Improvement) - APM is a key metric for improvement
- d-009 (Autopilot GUI) - APM display in the UI
- d-013 (Testing) - APM calculation must be tested
