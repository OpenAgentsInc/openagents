---
id: d-017
title: "Integrate Agent Client Protocol (ACP)"
status: active
priority: high
created: 2025-12-23
updated: 2025-12-23
---

# d-017: Integrate Agent Client Protocol (ACP)

## Goal

Standardize communication between OpenAgents apps and AI coding agents using ACP, enabling support for multiple agents (Claude Code, Codex) through a unified protocol.

## Background

ACP is a JSON-RPC 2.0 based protocol developed by Zed for IDE <-> agent communication. OpenAgents currently uses a custom JSONL protocol via `claude-agent-sdk`. This directive adds an ACP adapter layer that preserves existing functionality while enabling:

- Multi-agent support (Claude Code, Codex, future agents)
- Protocol standardization with the broader ecosystem
- Session replay compatibility
- Unified permission and file operation handling

### Architecture

```
+-------------------+     +------------------+     +----------------------+
|   Desktop GUI     |     |   acp-adapter    |     |  Agent subprocess    |
|   (wry + actix)   |---->|   (new crate)    |---->|  (CC / Codex)        |
+-------------------+     +------------------+     +----------------------+
        |                        |
        | HTMX/WS               |
        v                        v
+-------------------+     +------------------+
|   rlog streamer   |<----|   converters     |
|   (docs/logs/)    |     |   (ACP <-> rlog) |
+-------------------+     +------------------+
```

### Key Decisions

- **SDK approach**: Wrap existing claude-agent-sdk with ACP adapter layer
- **Recorder**: Bridge with bidirectional ACP <-> rlog converters
- **Transport**: Stdio subprocess (like Zed) for desktop
- **Agent order**: Claude Code first, then Codex

## Success Criteria

### Phase 1: Core Adapter (v0.1) âœ… COMPLETE
- [x] Create `crates/acp-adapter/` with connection management
- [x] Implement `acp::Client` trait for permission/file operations
- [x] Add SDK <-> ACP message converters
- [x] Add ACP <-> rlog converters

### Phase 2: Agent Wrappers (v0.2) âœ… COMPLETE
- [x] Claude Code wrapper with subprocess spawning
- [x] Codex wrapper with subprocess spawning
- [x] Agent discovery/configuration

### Phase 3: GUI Integration (v0.3) ðŸš§ IN PROGRESS
- [ ] REST API for ACP session management
- [ ] Real-time update streaming to UI
- [ ] Permission request UI handling

### Phase 4: Session Replay (v0.4)
- [ ] Replay rlog files as ACP notifications
- [ ] Stream ACP to rlog in real-time
- [ ] Session load/resume support

### Phase 5: Codex Full Support (v0.5)
- [ ] Codex ThreadEvent -> ACP mapping
- [ ] Codex-specific tool handling
- [ ] Unified agent selection in UI

## Key Files to Create/Modify

| File | Purpose |
|------|---------|
| `crates/acp-adapter/Cargo.toml` | **NEW** - Crate manifest |
| `crates/acp-adapter/src/lib.rs` | **NEW** - Main exports |
| `crates/acp-adapter/src/connection.rs` | **NEW** - ACP connection management |
| `crates/acp-adapter/src/session.rs` | **NEW** - Per-session state + trajectory |
| `crates/acp-adapter/src/client.rs` | **NEW** - Implements `acp::Client` trait |
| `crates/acp-adapter/src/transport.rs` | **NEW** - Stdio transport wrapper |
| `crates/acp-adapter/src/converters/mod.rs` | **NEW** - Converter exports |
| `crates/acp-adapter/src/converters/sdk_to_acp.rs` | **NEW** - SDK -> ACP |
| `crates/acp-adapter/src/converters/acp_to_sdk.rs` | **NEW** - ACP -> SDK |
| `crates/acp-adapter/src/converters/rlog.rs` | **NEW** - ACP <-> rlog |
| `crates/acp-adapter/src/agents/mod.rs` | **NEW** - Agent factory |
| `crates/acp-adapter/src/agents/claude.rs` | **NEW** - Claude Code wrapper |
| `crates/acp-adapter/src/agents/codex.rs` | **NEW** - Codex wrapper |
| `src/gui/routes/acp.rs` | **NEW** - REST API for sessions |
| `src/gui/state.rs` | Add ACP session storage |
| `src/gui/routes/mod.rs` | Register ACP routes |
| `Cargo.toml` | Add `acp-adapter` to workspace members |

## Dependencies

**External**:
- `agent-client-protocol-schema` v0.10+ (Zed's ACP Rust crate)
- `tokio` (async runtime, already in workspace)
- `async-trait` (async traits)

**Internal**:
- `claude-agent-sdk` - Existing SDK (for adapter layer)
- `codex-agent-sdk` - Existing SDK (if present)
- `autopilot` - TrajectoryCollector
- `recorder` - rlog parsing

## API Design

### AcpAgentConnection

```rust
/// ACP connection to an agent subprocess
pub struct AcpAgentConnection {
    pub agent_name: String,
    connection: Arc<acp::ClientSideConnection>,
    sessions: Arc<RwLock<HashMap<acp::SessionId, AcpAgentSession>>>,
    agent_capabilities: acp::AgentCapabilities,
    root_dir: PathBuf,
    child: Child,
}

impl AcpAgentConnection {
    /// Create connection via stdio
    pub async fn stdio(name: &str, command: AgentCommand, root_dir: &Path) -> Result<Self>;

    /// Create a new session
    pub async fn new_session(&self, cwd: PathBuf) -> Result<AcpAgentSession>;

    /// Send a prompt
    pub async fn prompt(&self, session_id: &SessionId, content: String) -> Result<PromptResponse>;

    /// Cancel ongoing work
    pub async fn cancel(&self, session_id: &SessionId);
}
```

### OpenAgentsAcpClient (implements acp::Client)

```rust
#[async_trait]
impl acp::Client for OpenAgentsAcpClient {
    async fn request_permission(&self, req: RequestPermissionRequest) -> Result<RequestPermissionResponse>;
    async fn read_text_file(&self, req: ReadTextFileRequest) -> Result<ReadTextFileResponse>;
    async fn write_text_file(&self, req: WriteTextFileRequest) -> Result<WriteTextFileResponse>;
    async fn session_notification(&self, notification: SessionNotification) -> Result<()>;
    async fn create_terminal(&self, req: CreateTerminalRequest) -> Result<CreateTerminalResponse>;
    // ... other Client methods
}
```

### REST API Endpoints

```
GET    /api/acp/sessions           - List active sessions
POST   /api/acp/sessions           - Create session {agent: "claude"|"codex", model?, cwd?}
POST   /api/acp/sessions/{id}/prompt - Send prompt {content: string}
POST   /api/acp/sessions/{id}/cancel - Cancel session
DELETE /api/acp/sessions/{id}      - Close session
```

## Testing Strategy

1. **Unit Tests**: Converter functions for SDK <-> ACP, ACP <-> rlog
2. **Integration Tests**: Full prompt flow with mock agent subprocess
3. **E2E Tests**: GUI session lifecycle with real Claude Code
4. **Replay Tests**: rlog -> ACP notification fidelity

## Sub-Issues

| ID | Title | Phase |
|----|-------|-------|
| acp-001 | Create acp-adapter crate skeleton | v0.1 |
| acp-002 | Implement AcpAgentConnection | v0.1 |
| acp-003 | Implement acp::Client trait | v0.1 |
| acp-004 | SDK <-> ACP converters | v0.1 |
| acp-005 | ACP <-> rlog converters | v0.1 |
| acp-006 | Claude Code agent wrapper | v0.2 |
| acp-007 | Codex agent wrapper | v0.2 |
| acp-008 | GUI REST API for sessions | v0.3 |
| acp-009 | Real-time UI updates | v0.3 |
| acp-010 | Session replay from rlog | v0.4 |
| acp-011 | Live rlog streaming | v0.4 |
| acp-012 | Codex event mapping | v0.5 |
| acp-013 | Integration tests | v0.5 |
| acp-014 | Documentation | v0.5 |

## Notes

- The ACP crate is `agent-client-protocol-schema` on crates.io (published by Zed)
- Zed's implementation in `~/code/zed/crates/agent_servers/src/acp.rs` serves as reference
- ACP protocol spec is at `~/code/agent-client-protocol/docs/protocol/`
- Existing `claude-agent-sdk` uses JSONL over stdio, different from ACP's JSON-RPC 2.0

## Related Directives

- d-009: Autopilot GUI (uses rlog for display)
- d-012: No Stubs policy (all implementations must be complete)

## References

- [ACP Protocol Specification](https://agentclientprotocol.com/protocol/overview)
- [agent-client-protocol-schema crate](https://crates.io/crates/agent-client-protocol-schema)
- [Zed ACP Implementation](https://github.com/zed-industries/zed/tree/main/crates/agent_servers)
