---
id: d-018
title: Parallel Autopilot Container Isolation
status: active
priority: high
created: 2025-12-23
updated: 2025-12-25T14:20:56Z
---

## Goal

Enable running multiple autopilot instances (3-10) simultaneously in isolated Docker containers, each with its own git worktree, to parallelize issue resolution across a shared issue database. Full control via both CLI and GUI.

## Background

Current autopilot is single-instance: one daemon, one worker, one working directory. When there are 50+ open issues, a single agent processes them sequentially, which is slow. Multi-agent parallelism can dramatically increase throughput.

**Key insight**: The existing `crates/issues/src/issue.rs` already has atomic issue claiming with 15-minute expiry. No new coordination logic is needed - all containers can share `autopilot.db` via bind mount and SQLite's atomic operations prevent race conditions.

**Target environments**:
- Linux desktop: Intel i7-14700K, 128GB RAM, RTX 4080 → up to 10 agents
- MacBook Pro: Apple M2 Pro, 16GB RAM → up to 5 agents

## Architecture

```
Host Machine
├── .git/                    (shared object database)
├── autopilot.db             (SHARED - atomic issue claiming)
├── .worktrees/
│   ├── agent-001/           (worktree → branch agent/001)
│   ├── agent-002/           (worktree → branch agent/002)
│   └── agent-00N/
└── docs/logs/               (shared log output)

Docker Containers
├── agent-001 → /workspace mounted from .worktrees/agent-001
├── agent-002 → /workspace mounted from .worktrees/agent-002
└── agent-00N → each mounts shared autopilot.db
```

**Resource limits per container**:
- Linux: `--memory=12g --cpus=4`
- macOS: `--memory=3g --cpus=2`

## Success Criteria

### Phase 1: Basic Container Setup
- [ ] Create `docker/autopilot/Dockerfile` with Rust toolchain + autopilot binary
- [ ] Install Codex Code CLI in container
- [ ] Create `docker/autopilot/docker-compose.yml` with YAML anchors for N agents
- [ ] Script to create worktrees before container start
- [ ] Bind mount worktrees + shared autopilot.db into containers

### Phase 2: Credential & Log Management
- [ ] Mount Codex credentials read-only (`~/.codex/`)
- [ ] Mount git credentials (SSH keys, `.gitconfig`)
- [ ] Logs written to shared `docs/logs/` via bind mount
- [ ] Add log tailing functionality

### Phase 3: Orchestration Library
- [ ] Create `crates/autopilot/src/parallel/mod.rs` - public API
- [ ] Create `parallel/docker.rs` - Docker Compose wrapper
- [ ] Create `parallel/worktree.rs` - git worktree management
- [ ] Functions: `start_agents(n)`, `stop_agents()`, `list_agents()`, `get_logs(id)`
- [ ] Platform detection for resource limits

### Phase 4: GUI Integration
- [ ] Add "Parallel Agents" pane in `crates/autopilot-gui/src/views/parallel.rs`
- [ ] Wire UI controls to backend commands (start/stop/list/logs)
- [ ] Stream status updates via backend events (no WebSocket)
- [ ] WGPUI controls for agent count, start, stop, log preview

### Phase 5: CLI Wrapper
- [ ] Create `scripts/parallel-autopilot.sh`
- [ ] Commands: `start N`, `stop`, `status`, `logs [id]`, `cleanup`

### Phase 6: Resource Optimization
- [ ] Platform detection (Linux vs macOS)
- [ ] Memory/CPU limits tuned per platform
- [ ] Health checks and auto-restart policy
- [ ] Graceful shutdown on SIGTERM

### Phase 7: macOS Container (Future)
- [ ] Detect macOS 26+ availability
- [ ] Add Apple Container backend as alternative
- [ ] Performance comparison with Docker Desktop

## Key Files

| File | Purpose |
|------|---------|
| `docker/autopilot/Dockerfile` | Container image |
| `docker/autopilot/docker-compose.yml` | Orchestration |
| `crates/autopilot/src/parallel/mod.rs` | Orchestration library |
| `crates/autopilot/src/parallel/docker.rs` | Docker Compose wrapper |
| `crates/autopilot/src/parallel/worktree.rs` | Git worktree management |
| `crates/autopilot-gui/src/views/parallel.rs` | GUI view |
| `crates/autopilot-gui/src/backend/parallel.rs` | GUI/backend integration |
| `scripts/parallel-autopilot.sh` | CLI wrapper |
| `docs/development/parallel-autopilot-containers.md` | Documentation |

## GUI Design

```
┌─────────────────────────────────────────────────────────────────────┐
│ Autopilot GUI  │ Dashboard │ Chat │ Context │ Parallel Agents │    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  PARALLEL AGENTS                                                    │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Agent Count: [  3  ▼]     [▶ Start Agents]  [■ Stop All]    │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌─ Running Agents ─────────────────────────────────────────────┐  │
│  │  ● agent-001  │ Working on #42  │ 5m 23s  │ [View Logs]      │  │
│  │  ● agent-002  │ Working on #45  │ 3m 10s  │ [View Logs]      │  │
│  │  ○ agent-003  │ Idle (no issues)│ 1m 05s  │ [View Logs]      │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌─ Open Issues Queue ──────────────────────────────────────────┐  │
│  │  #43 [high]   Implement feature X                            │  │
│  │  #44 [medium] Fix bug in Y                                   │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌─ Resource Usage ─────────────────────────────────────────────┐  │
│  │  Platform: Linux x86_64 │ Memory: 45 GB / 128 GB │ Max: 10   │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

## Dependencies

- Docker / Docker Desktop
- SQLite (WAL mode for concurrent access)
- Existing `crates/issues/` for atomic issue claiming
- Git worktrees

## Testing Strategy

1. **Unit**: Worktree creation/cleanup functions
2. **Integration**: Multiple containers claiming different issues atomically
3. **E2E**: Full parallel run with 3 agents on test issues
4. **Platform**: Verify on both Linux (Arch) and macOS (M2 Pro)

## Notes

- Containers use per-agent branches (`agent/001`, `agent/002`) for git isolation
- All agents share a single `autopilot.db` - SQLite handles concurrent access
- 15-minute claim expiry means crashed agents release issues automatically
- No Windows support planned (Linux and macOS only)

## Related Directives

- d-004: Continual Constant Improvement of Autopilot (metrics collection applies to parallel runs)
- d-009: Autopilot GUI (parallel agents page extends the GUI)
