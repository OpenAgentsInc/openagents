---
id: d-022
title: "Agent Orchestration Framework"
status: active
priority: high
created: 2025-12-24
updated: 2025-12-25T14:24:33Z
---

# d-022: Agent Orchestration Framework

## Goal

Build a native Rust agent orchestration layer inspired by oh-my-opencode, providing multi-model agent management, lifecycle hooks, background task orchestration, and deep integration with OpenAgents infrastructure (directives, autopilot, marketplace, FROSTR).

## Background

[oh-my-opencode](https://github.com/code-yeongyu/oh-my-opencode) is a TypeScript plugin for OpenCode that provides powerful agent orchestration:

- **7 Specialized Agents**: Sisyphus (orchestrator), Oracle (architecture), Librarian (docs), Explore (search), Frontend (UI), DocWriter, Multimodal
- **21 Lifecycle Hooks**: Session recovery, context injection, compaction management, notifications
- **Background Tasks**: Parallel agent execution with notification on completion
- **Tool Integration**: LSP, AST-grep, custom file operations
- **MCP Servers**: Context7, Exa web search, Grep.app

We are ALREADY RUNNING Sisyphus (it's processing this conversation). However, oh-my-opencode is TypeScript and runs inside OpenCode — we need native Rust integration with:

- Our directive system (d-001 through d-020)
- Autopilot issue tracking and parallel execution
- FROSTR threshold signatures for agent identity
- NIP-SA sovereign agent protocol
- Marketplace skill licensing
- Trajectory recording and APM metrics

### Why Harvest Instead of Consume?

| Approach | Pros | Cons |
|----------|------|------|
| **Consume** (run oh-my-opencode via OpenCode) | Immediate access to agents | No Rust integration, TypeScript dependency, can't customize deeply |
| **Harvest** (port concepts to Rust) | Deep integration, type safety, customize for our needs | More work upfront |

**We choose Harvest** because:
1. We need compile-time integration with 15+ existing Rust crates
2. Agent identity must integrate with FROSTR (Rust cryptography)
3. Hooks must trigger our directive/issue system
4. Background tasks must integrate with autopilot daemon
5. Tool outputs must feed trajectory recorder

### Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        crates/agent-orchestrator/                             │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                           AgentRegistry                                  │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │ │
│  │  │ Sisyphus │ │  Oracle  │ │ Librarian│ │ Explore  │ │ Frontend │ ...  │ │
│  │  │(primary) │ │ (GPT-5.2)│ │ (Sonnet) │ │  (Grok)  │ │ (Gemini) │      │ │
│  │  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘      │ │
│  │       │            │            │            │            │             │ │
│  │       └────────────┴────────────┴────────────┴────────────┘             │ │
│  │                                 │                                        │ │
│  │                    ┌────────────┴────────────┐                          │ │
│  │                    │   AgentDispatcher       │                          │ │
│  │                    │   • route to agent      │                          │ │
│  │                    │   • manage lifecycle    │                          │ │
│  │                    │   • collect metrics     │                          │ │
│  │                    └────────────┬────────────┘                          │ │
│  └─────────────────────────────────┼───────────────────────────────────────┘ │
│                                    │                                          │
│  ┌─────────────────────────────────┼───────────────────────────────────────┐ │
│  │                          HookManager                                     │ │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐               │ │
│  │  │ session.* │ │ tool.*    │ │ context.* │ │ notify.*  │               │ │
│  │  │ created   │ │ before    │ │ inject    │ │ complete  │               │ │
│  │  │ idle      │ │ after     │ │ compact   │ │ error     │               │ │
│  │  │ error     │ │ progress  │ │ window    │ │ toast     │               │ │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘               │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                       BackgroundTaskManager                              │ │
│  │  • Spawn subagent sessions                                               │ │
│  │  • Track completion via session.idle events                              │ │
│  │  • Notify parent session when done                                       │ │
│  │  • Cancel on timeout or parent abort                                     │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐        │
│  │ Integration  │ │ Integration  │ │ Integration  │ │ Integration  │        │
│  │ directives   │ │ autopilot    │ │ marketplace  │ │ trajectory   │        │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘        │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ via opencode-sdk (d-021)
                                      │     or codex-agent-sdk
                                      │     or codex-agent-sdk
                                      │     or gpt-oss (d-019)
                                      ▼
                            ┌─────────────────────┐
                            │   Backend Agent     │
                            │   (any provider)    │
                            └─────────────────────┘
```

## Success Criteria

### Phase 1: Core Framework (v0.1)
- [x] Create `crates/agent-orchestrator/` crate structure
- [x] Define `AgentConfig` struct mirroring oh-my-opencode schema
- [x] Implement `AgentRegistry` with agent lookup and configuration
- [x] Define `Hook` trait for lifecycle hooks
- [x] Implement `HookManager` with event dispatch

### Phase 2: Agent Definitions (v0.2)
- [x] Port Sisyphus agent prompt and behavior (already using it!)
- [x] Port Oracle agent (architecture, debugging guidance)
- [x] Port Librarian agent (external docs, GitHub search)
- [x] Port Explore agent (codebase navigation)
- [x] Port remaining agents (Frontend, DocWriter, Multimodal)
- [x] Store prompts in `agents/` subdirectory

### Phase 3: Background Tasks (v0.3)
- [x] Implement `BackgroundTaskManager`
- [x] Support `background_task`, `background_output`, `background_cancel` tools
- [ ] Parent session notification on task completion
- [ ] Integration with autopilot daemon for long-running tasks

### Phase 4: Core Hooks (v0.4)
- [x] `session.created` / `session.idle` / `session.error` hooks
- [x] `tool.execute.before` / `tool.execute.after` hooks
- [x] `context.inject` for AGENTS.md, README.md, rules
- [x] `context.compact` for preserving state during compaction
- [x] `todo.continuation` hook for enforcing task completion

### Phase 5: OpenAgents Integrations (v0.5)
- [x] Directive awareness (load active directives into context)
- [x] Issue integration (claim/complete via hooks)
- [x] Trajectory integration (APM metrics, action logging)
- [x] Marketplace integration (skill licensing for agents)
- [ ] WGPUI integration (status + notifications in autopilot-gui)

### Phase 6: Advanced Features (v0.6)
- [x] FROSTR integration (threshold-signed agent identity)
- [x] NIP-SA integration (sovereign agent protocol)
- [x] Multi-backend support (route to OpenCode, Codex, Codex, GPT-OSS)
- [x] Agent cost tracking and budget enforcement

## Key Files to Create/Modify

| File | Purpose |
|------|---------|
| `crates/agent-orchestrator/Cargo.toml` | **NEW** - Crate manifest |
| `crates/agent-orchestrator/src/lib.rs` | **NEW** - Public exports |
| `crates/agent-orchestrator/src/registry.rs` | **NEW** - AgentRegistry |
| `crates/agent-orchestrator/src/dispatcher.rs` | **NEW** - AgentDispatcher |
| `crates/agent-orchestrator/src/config.rs` | **NEW** - Configuration types |
| `crates/agent-orchestrator/src/hooks/mod.rs` | **NEW** - Hook trait and manager |
| `crates/agent-orchestrator/src/hooks/session.rs` | **NEW** - Session lifecycle hooks |
| `crates/agent-orchestrator/src/hooks/tool.rs` | **NEW** - Tool execution hooks |
| `crates/agent-orchestrator/src/hooks/context.rs` | **NEW** - Context injection hooks |
| `crates/agent-orchestrator/src/hooks/notify.rs` | **NEW** - Notification hooks |
| `crates/agent-orchestrator/src/background.rs` | **NEW** - BackgroundTaskManager |
| `crates/agent-orchestrator/src/agents/mod.rs` | **NEW** - Agent definitions |
| `crates/agent-orchestrator/src/agents/sisyphus.rs` | **NEW** - Sisyphus config |
| `crates/agent-orchestrator/src/agents/oracle.rs` | **NEW** - Oracle config |
| `crates/agent-orchestrator/src/agents/librarian.rs` | **NEW** - Librarian config |
| `crates/agent-orchestrator/src/agents/explore.rs` | **NEW** - Explore config |
| `crates/agent-orchestrator/src/integrations/mod.rs` | **NEW** - Integration points |
| `crates/agent-orchestrator/src/integrations/directives.rs` | **NEW** - Directive loading |
| `crates/agent-orchestrator/src/integrations/autopilot.rs` | **NEW** - Issue tracking |
| `crates/agent-orchestrator/src/integrations/trajectory.rs` | **NEW** - APM metrics |
| `crates/autopilot/src/main.rs` | Use orchestrator for agent management |
| `Cargo.toml` | Add agent-orchestrator to workspace |

## Dependencies

**External**:
- `async-trait` — Async trait definitions
- `tokio` — Async runtime (already in workspace)
- `serde` — Configuration serialization
- `tracing` — Logging

**Internal**:
- `opencode-sdk` (d-021) — Primary backend communication
- `codex-agent-sdk` — Fallback/direct Codex access
- `codex-agent-sdk` — Codex backend
- `gpt-oss` (d-019) — Local inference backend
- `acp-adapter` — Protocol unification
- `issues` — Issue tracking
- `recorder` — Trajectory logging
- `frostr` (d-007) — Threshold signatures
- `marketplace` — Skill licensing

## API Design

### AgentConfig

```rust
// crates/agent-orchestrator/src/config.rs

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AgentConfig {
    /// Model identifier (e.g., "openai/codex-opus-4-5")
    pub model: String,

    /// System prompt defining agent behavior
    pub prompt: String,

    /// Temperature for generation (0.0 - 2.0)
    pub temperature: f32,

    /// Short description for UI
    pub description: String,

    /// Agent mode: "primary", "subagent", or "all"
    pub mode: AgentMode,

    /// Color for UI display (hex)
    pub color: String,

    /// Tool permissions
    pub tools: HashMap<String, bool>,

    /// Permission settings
    pub permission: AgentPermission,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AgentPermission {
    pub edit: PermissionLevel,
    pub bash: BashPermission,
    pub webfetch: PermissionLevel,
}

#[derive(Debug, Clone, Copy, Serialize, Deserialize)]
pub enum PermissionLevel {
    Allow,
    Ask,
    Deny,
}
```

### AgentRegistry

```rust
// crates/agent-orchestrator/src/registry.rs

pub struct AgentRegistry {
    agents: HashMap<String, AgentConfig>,
    disabled: HashSet<String>,
    overrides: HashMap<String, AgentOverride>,
}

impl AgentRegistry {
    /// Create registry with builtin agents
    pub fn new() -> Self;

    /// Load user/project configuration
    pub fn load_config(&mut self, path: &Path) -> Result<()>;

    /// Get agent by name
    pub fn get(&self, name: &str) -> Option<&AgentConfig>;

    /// List all enabled agents
    pub fn list(&self) -> Vec<&str>;

    /// Check if agent is available
    pub fn is_enabled(&self, name: &str) -> bool;

    /// Get primary agent (usually Sisyphus)
    pub fn primary(&self) -> Option<&AgentConfig>;

    /// Apply runtime override
    pub fn override_agent(&mut self, name: &str, config: AgentOverride);
}
```

### Hook System

```rust
// crates/agent-orchestrator/src/hooks/mod.rs

#[async_trait]
pub trait Hook: Send + Sync {
    /// Hook identifier
    fn name(&self) -> &str;

    /// Called on session lifecycle events
    async fn on_session(&self, event: SessionEvent) -> HookResult {
        HookResult::Continue
    }

    /// Called before tool execution
    async fn before_tool(&self, call: &mut ToolCall) -> HookResult {
        HookResult::Continue
    }

    /// Called after tool execution
    async fn after_tool(&self, call: &ToolCall, output: &mut ToolOutput) -> HookResult {
        HookResult::Continue
    }

    /// Called to inject context
    async fn inject_context(&self, context: &mut ContextBuilder) -> HookResult {
        HookResult::Continue
    }
}

pub enum HookResult {
    Continue,
    Block { message: String },
    Modify,
}

pub struct HookManager {
    hooks: Vec<Box<dyn Hook>>,
}

impl HookManager {
    pub fn new() -> Self;
    pub fn register(&mut self, hook: impl Hook + 'static);
    pub fn disable(&mut self, name: &str);

    pub async fn dispatch_session(&self, event: SessionEvent);
    pub async fn dispatch_before_tool(&self, call: &mut ToolCall) -> HookResult;
    pub async fn dispatch_after_tool(&self, call: &ToolCall, output: &mut ToolOutput);
    pub async fn dispatch_inject_context(&self, context: &mut ContextBuilder);
}
```

### Background Task Manager

```rust
// crates/agent-orchestrator/src/background.rs

pub struct BackgroundTask {
    pub id: TaskId,
    pub session_id: SessionId,
    pub parent_session_id: SessionId,
    pub description: String,
    pub agent: String,
    pub status: TaskStatus,
    pub started_at: DateTime<Utc>,
    pub completed_at: Option<DateTime<Utc>>,
    pub result: Option<String>,
    pub error: Option<String>,
}

pub enum TaskStatus {
    Pending,
    Running,
    Completed,
    Error,
    Cancelled,
}

pub struct BackgroundTaskManager {
    tasks: Arc<RwLock<HashMap<TaskId, BackgroundTask>>>,
    client: Arc<dyn AgentClient>,
}

impl BackgroundTaskManager {
    pub fn new(client: Arc<dyn AgentClient>) -> Self;

    /// Launch a background task
    pub async fn spawn(
        &self,
        parent_session: &SessionId,
        agent: &str,
        prompt: &str,
        description: &str,
    ) -> Result<TaskId>;

    /// Get task output (optionally blocking)
    pub async fn get_output(&self, task_id: &TaskId, block: bool) -> Result<Option<String>>;

    /// Cancel a running task
    pub async fn cancel(&self, task_id: &TaskId) -> Result<()>;

    /// Cancel all tasks for a parent session
    pub async fn cancel_all(&self, parent_session: &SessionId) -> Result<()>;

    /// List tasks by parent session
    pub fn list(&self, parent_session: &SessionId) -> Vec<BackgroundTask>;
}
```

### Directive Integration

```rust
// crates/agent-orchestrator/src/integrations/directives.rs

pub struct DirectiveContext {
    pub active_directives: Vec<DirectiveSummary>,
    pub current_directive: Option<DirectiveId>,
    pub linked_issues: Vec<IssueSummary>,
}

impl DirectiveContext {
    /// Load active directives from .openagents/directives/
    pub async fn load(workspace: &Path) -> Result<Self>;

    /// Format for context injection
    pub fn format_for_context(&self) -> String;

    /// Check if current work relates to a directive
    pub fn find_related(&self, keywords: &[&str]) -> Option<&DirectiveSummary>;
}
```

### Usage Example

```rust
use agent_orchestrator::{
    AgentRegistry, HookManager, BackgroundTaskManager,
    hooks::{TodoContinuationHook, ContextInjectionHook, SessionRecoveryHook},
    integrations::DirectiveContext,
};

#[tokio::main]
async fn main() -> Result<()> {
    // Initialize registry with builtin agents
    let mut registry = AgentRegistry::new();
    registry.load_config(&PathBuf::from(".openagents/agents.json"))?;

    // Set up hooks
    let mut hooks = HookManager::new();
    hooks.register(TodoContinuationHook::new());
    hooks.register(ContextInjectionHook::new(workspace.clone()));
    hooks.register(SessionRecoveryHook::new());

    // Load directive context
    let directives = DirectiveContext::load(&workspace).await?;

    // Create agent dispatcher
    let dispatcher = AgentDispatcher::new(registry, hooks);

    // Get primary agent (Sisyphus)
    let agent = dispatcher.primary()?;

    // Create session with context
    let mut context = ContextBuilder::new();
    context.add_directives(&directives);
    hooks.dispatch_inject_context(&mut context).await;

    // Run with the agent
    let session = dispatcher.create_session(agent, context).await?;
    dispatcher.prompt(&session.id, "Implement d-021 phase 1").await?;

    // Background task example
    let bg_manager = BackgroundTaskManager::new(dispatcher.client());
    let task_id = bg_manager.spawn(
        &session.id,
        "explore",
        "Find all OpenAPI-related code in the codebase",
        "Explore OpenAPI patterns"
    ).await?;

    // Wait for background task
    let result = bg_manager.get_output(&task_id, true).await?;
    println!("Background task result: {:?}", result);

    Ok(())
}
```

## Testing Strategy

1. **Unit Tests** — Agent config parsing, hook dispatch, task lifecycle
2. **Integration Tests** — Full agent sessions with mock backend
3. **Hook Tests** — Each hook type with various scenarios
4. **Background Tests** — Task spawn, completion, cancellation flows
5. **Directive Tests** — Context loading and injection

## Agents to Port

| Agent | Model | Purpose | Priority |
|-------|-------|---------|----------|
| **Sisyphus** | codex-opus-4-5 | Primary orchestrator, delegates to specialists | P0 |
| **Oracle** | gpt-5.2 | Architecture decisions, debugging after 2+ failures | P0 |
| **Librarian** | codex-sonnet-4-5 | External docs, GitHub search, OSS reference | P0 |
| **Explore** | grok-code | Fast codebase exploration, pattern search | P0 |
| **Frontend** | gemini-3-pro | UI/UX development, visual changes | P1 |
| **DocWriter** | gemini-3-pro | Technical documentation | P1 |
| **Multimodal** | gemini-3-flash | PDF/image analysis | P2 |

## Hooks to Port

| Hook | Purpose | Priority |
|------|---------|----------|
| `todo-continuation-enforcer` | Ensure TODO completion before proceeding | P0 |
| `session-recovery` | Auto-recover from transient errors | P0 |
| `context-window-monitor` | Track token usage, warn on limits | P0 |
| `tool-output-truncator` | Prevent context overflow from large outputs | P0 |
| `directory-agents-injector` | Auto-inject AGENTS.md into context | P1 |
| `directory-readme-injector` | Auto-inject README.md into context | P1 |
| `rules-injector` | Load .codex/rules/ conditionally | P1 |
| `compaction-context-injector` | Preserve state during compaction | P1 |
| `session-notification` | OS notify on session idle | P2 |
| `background-notification` | Notify on background task completion | P2 |
| `comment-checker` | Prevent excessive code comments | P2 |
| `think-mode` | Activate extended thinking on keywords | P2 |

## Notes

### Configuration File Locations

```
~/.config/openagents/orchestrator.json    # User-level config
.openagents/orchestrator.json             # Project-level config (overrides)
```

### Config Schema

```json
{
  "$schema": "https://openagents.com/schemas/orchestrator.json",
  "disabled_agents": ["multimodal-looker"],
  "disabled_hooks": ["comment-checker"],
  "agents": {
    "Sisyphus": {
      "model": "openai/codex-opus-4-5",
      "temperature": 0.1
    }
  },
  "integrations": {
    "directives": true,
    "autopilot": true,
    "marketplace": false
  }
}
```

### Relationship to oh-my-opencode

This is NOT a port of oh-my-opencode — it's a Rust reimplementation of the concepts for deep OpenAgents integration. Key differences:

1. **Language**: TypeScript → Rust (compile-time safety, no Node.js runtime)
2. **Runtime**: OpenCode plugin → Standalone Rust crate
3. **Integration**: Generic hooks → OpenAgents-specific (directives, FROSTR, NIP-SA)
4. **Backend**: OpenCode only → Multi-backend (OpenCode, Codex, Codex, GPT-OSS)

## Related Directives

- **d-021**: OpenCode SDK Integration (primary backend)
- **d-019**: GPT-OSS Local Inference (local backend option)
- **d-017**: ACP Integration (protocol layer)
- **d-004**: Continual Autopilot Improvement (metrics integration)
- **d-007**: FROSTR (agent identity)
- **d-006**: NIP-SA (sovereign agent protocol)

## References

- [oh-my-opencode Repository](https://github.com/code-yeongyu/oh-my-opencode)
- [oh-my-opencode Architecture](~/code/oh-my-opencode/docs/ARCHITECTURE.md)
- [Sisyphus Agent Prompt](~/code/oh-my-opencode/src/agents/sisyphus.ts)
- [OpenCode Plugin SDK](~/code/opencode/packages/plugin/src/index.ts)
