---
id: "d-025"
title: "All-In WGPUI - Delete Web Stack"
status: active
priority: urgent
created: 2025-12-24
updated: 2025-12-24T10:30:00
---

## Goal

Delete the HTMX/Maud/Tailwind web stack entirely and build all OpenAgents applications with WGPUI. The first application is autopilot-gui, rebuilt as a native WGPUI app with in-process backend (Zed's architecture pattern).

## Background

OpenAgents currently has two UI stacks:
- **Web stack** (to be deleted): Maud templates + HTMX + Tailwind, served via Actix-web in wry/tao webview
- **WGPUI** (the future): GPU-accelerated native rendering via wgpu

The web stack adds complexity (localhost server, WebSocket bridge, HTML/CSS parsing) without benefit. WGPUI already has 60+ components and full Arwes parity (d-024). Time to go all-in.

**Key decisions:**
- All-in WGPUI (no hybrid)
- First app: autopilot-gui
- In-process backend (like Zed) - no Actix server
- Move deleted code to `~/code/backroom/openagents-maud-archive/`

## Architecture

### Before (Web Stack)
```
main.rs -> [Actix Server] -> HTTP/WS -> [wry WebView] <- HTML
```

### After (WGPUI Native)
```
main.rs -> [winit EventLoop] -> [WGPUI Renderer] <- GPU
              |
         App Singleton (owns all state)
              |
         Entity<Model> handles
```

### Target File Structure
```
crates/autopilot-gui/
  src/
    main.rs                 # winit event loop, wgpu init
    app.rs                  # App singleton, Entity storage
    state/
      mod.rs                # State exports
      sessions.rs           # Session list state
      permissions.rs        # Permission state
      chat.rs               # Chat/streaming state
      agents.rs             # Parallel agents state
    views/
      mod.rs                # View exports
      root.rs               # Root layout + navigation
      dashboard.rs          # Dashboard view
      chat.rs               # Chat view
      context.rs            # Context inspector
      permissions.rs        # Permissions manager
      parallel.rs           # Parallel agents
    components/
      mod.rs                # Component exports
      (new components listed in issues below)
    backend/
      mod.rs                # Backend integration
      sessions.rs           # Session queries
      permissions.rs        # Permission storage
      agent.rs              # Agent execution
```

## Success Criteria

### Phase 1: Framework Foundation
- [x] Entity system with reactive state (Entity<T>, Context<T>, cx.notify()) ✅ 2025-12-24
- [x] Element trait with 3-phase lifecycle (request_layout, prepaint, paint) ✅ 2025-12-24
- [ ] Window abstraction with layout engine integration
- [ ] Styled trait with fluent builder DSL (div().flex().bg())
- [ ] App singleton with cx.spawn() async support

### Phase 2: Delete Web Stack
- [ ] Move crates/ui to ~/code/backroom/openagents-maud-archive/
- [ ] Move crates/storybook to ~/code/backroom/openagents-maud-archive/
- [ ] Move crates/autopilot-gui to ~/code/backroom/openagents-maud-archive/
- [ ] Remove maud, actix-web, wry, tao from workspace Cargo.toml
- [ ] Remove HTMX/Maud references from CLAUDE.md and SYNTHESIS.md

### Phase 3: Autopilot-GUI Native
- [ ] winit/wgpu application shell
- [ ] Navigation with 5 views (Dashboard, Chat, Context, Permissions, Parallel)
- [ ] Dashboard with session list and stats
- [ ] Chat with streaming messages and tool calls
- [ ] Permission dialogs (modal layer)
- [ ] In-process backend integration via channels

### Phase 4: Component Parity
- [ ] All components from old ui crate ported to WGPUI
- [ ] WGPUI storybook example for component development

## Issues

### Framework Foundation (Phase 1)

#### Issue 1: Entity System ✅ COMPLETE
**Title:** Implement GPUI-style Entity system in WGPUI
**Priority:** Urgent
**Status:** Complete (2025-12-24)
**Description:** Add reactive state management with Entity<T> handles, Context<T> wrapper, and automatic invalidation via cx.notify().

Files created:
- `crates/wgpui/src/app/mod.rs` ✅
- `crates/wgpui/src/app/entity_map.rs` - SlotMap-based entity storage with Entity<T>, WeakEntity<T>, AnyEntity, Lease ✅
- `crates/wgpui/src/app/app_context.rs` - App singleton and Context<T> with notify/observe/update_entity ✅
- `crates/wgpui/src/app/subscription.rs` - Subscription with drop cleanup, SubscriberSet ✅

12 unit tests passing.

Reference: `~/code/zed/crates/gpui/src/app/entity_map.rs`

---

#### Issue 2: Element Trait ✅ COMPLETE
**Title:** Implement 3-phase Element lifecycle in WGPUI
**Priority:** Urgent
**Status:** Complete (2025-12-24)
**Description:** Replace Component trait with GPUI-style Element trait with request_layout -> prepaint -> paint phases.

Files created:
- `crates/wgpui/src/element/mod.rs` ✅
- `crates/wgpui/src/element/element.rs` - Element trait ✅
- `crates/wgpui/src/element/into_element.rs` - IntoElement trait ✅
- `crates/wgpui/src/element/render.rs` - Render and RenderOnce traits ✅
- `crates/wgpui/src/element/any_element.rs` - Type-erased element ✅
- `crates/wgpui/src/element/drawable.rs` - Draw phase wrapper ✅

Keep existing Component trait for backward compat, wrap in ComponentElement<C>. ✅

Reference: `~/code/zed/crates/gpui/src/element.rs`

---

#### Issue 3: Window Abstraction
**Title:** Implement Window struct with layout engine integration
**Priority:** Urgent
**Description:** Centralize window management, layout computation, focus, and rendering.

Files to create:
- `crates/wgpui/src/window/mod.rs`
- `crates/wgpui/src/window/window.rs` - Window struct
- `crates/wgpui/src/window/window_handle.rs` - External reference
- `crates/wgpui/src/window/invalidator.rs` - Dirty tracking
- `crates/wgpui/src/window/dispatch.rs` - Event dispatch tree

Integrate existing LayoutEngine (Taffy) with Window.

---

#### Issue 4: Styled Trait
**Title:** Implement fluent styling DSL in WGPUI
**Priority:** High
**Description:** Add Styled trait enabling div().flex().w_full().bg(color) pattern.

Files to create:
- `crates/wgpui/src/styled/mod.rs`
- `crates/wgpui/src/styled/style.rs` - Style struct
- `crates/wgpui/src/styled/styled.rs` - Styled trait with methods
- `crates/wgpui/src/styled/refinement.rs` - StyleRefinement
- `crates/wgpui/src/styled/helpers.rs` - px(), pct() helpers

Implement on Div, Text, Button, etc.

---

#### Issue 5: Async Support
**Title:** Add cx.spawn() async task support to WGPUI
**Priority:** High
**Description:** Enable async operations from within views with Task<T> handles.

Files to create:
- `crates/wgpui/src/async/mod.rs`
- `crates/wgpui/src/async/task.rs` - Task<T> wrapper
- `crates/wgpui/src/async/executor.rs` - Foreground/background executors

Add cx.spawn() to Context<T>.

---

#### Issue 6: Focus System
**Title:** Implement focus management in WGPUI
**Priority:** Medium
**Description:** Add FocusHandle, focus chain, tab navigation.

Files to create:
- `crates/wgpui/src/focus/mod.rs`
- `crates/wgpui/src/focus/focus_handle.rs`
- `crates/wgpui/src/focus/focus_chain.rs`

---

### Delete Web Stack (Phase 2)

#### Issue 7: Archive Maud UI Crate
**Title:** Move crates/ui to backroom archive
**Priority:** Urgent
**Description:**
```bash
mkdir -p ~/code/backroom/openagents-maud-archive/crates
mv crates/ui ~/code/backroom/openagents-maud-archive/crates/
```
Remove from workspace Cargo.toml.

---

#### Issue 8: Archive Storybook
**Title:** Move crates/storybook to backroom archive
**Priority:** Urgent
**Description:**
```bash
mv crates/storybook ~/code/backroom/openagents-maud-archive/crates/
```
Remove from workspace Cargo.toml.

---

#### Issue 9: Archive Old Autopilot-GUI
**Title:** Move crates/autopilot-gui to backroom archive
**Priority:** Urgent
**Description:**
```bash
mv crates/autopilot-gui ~/code/backroom/openagents-maud-archive/crates/
```
Will be rebuilt as WGPUI native.

---

#### Issue 10: Remove Web Dependencies
**Title:** Remove maud, actix-web, wry, tao from workspace
**Priority:** Urgent
**Description:** Clean up Cargo.toml:
- Remove maud from [workspace.dependencies]
- Remove actix-web from [workspace.dependencies]
- Remove wry from [workspace.dependencies]
- Remove tao from [workspace.dependencies]
- Remove actix-ws
- Update any crates that imported these

---

#### Issue 11: Update Documentation
**Title:** Remove Maud/HTMX references from docs
**Priority:** High
**Description:** Update these files:
- CLAUDE.md - Remove "wry/tao + Actix + Maud" architecture references
- SYNTHESIS.md - Update Part Eleven: User Interface Architecture
- README.md - Update UI stack description

---

### Autopilot-GUI Native (Phase 3)

#### Issue 12: Create New Autopilot-GUI Crate
**Title:** Create new WGPUI-native autopilot-gui crate
**Priority:** Urgent
**Description:** Create fresh crates/autopilot-gui with:
- Cargo.toml with wgpui, winit, wgpu dependencies
- src/main.rs with winit event loop
- src/app.rs with App singleton

---

#### Issue 13: App State Structure
**Title:** Implement AutopilotApp state container
**Priority:** Urgent
**Description:** Create state modules:
- src/state/mod.rs
- src/state/sessions.rs - SessionsState
- src/state/permissions.rs - PermissionsState
- src/state/chat.rs - ChatState
- src/state/agents.rs - AgentsState (parallel)

Use tokio mpsc channels for backend events.

---

#### Issue 14: Navigation Component
**Title:** Create NavBar and navigation routing
**Priority:** High
**Description:** Create:
- src/components/nav_bar.rs - Horizontal nav
- src/components/nav_item.rs - Individual nav item
- src/views/root.rs - Root layout with nav

5 views: Dashboard, Chat, Context, Permissions, Parallel

---

#### Issue 15: Dashboard View
**Title:** Implement Dashboard view
**Priority:** High
**Description:** Create:
- src/views/dashboard.rs
- src/components/stats_card.rs
- src/components/stats_grid.rs
- src/components/session_row.rs
- src/components/session_list.rs (VirtualList wrapper)
- src/components/agent_selector.rs

Show session history, stats, agent selection.

---

#### Issue 16: Chat View
**Title:** Implement Chat view with streaming
**Priority:** High
**Description:** Create:
- src/views/chat.rs
- src/components/message_input.rs

Reuse existing WGPUI components:
- ThreadView, ThreadEntry, MessageHeader
- AssistantMessage, UserMessage
- ToolCallCard, TerminalToolCall
- StreamingIndicator

Wire up streaming via channels.

---

#### Issue 17: Permission Dialog
**Title:** Implement permission dialog modal
**Priority:** High
**Description:** Create:
- src/components/permission_dialog.rs - Modal wrapper

Reuse existing WGPUI PermissionDialog component.
Handle Allow/Deny/Always via channel to backend.

---

#### Issue 18: Context View
**Title:** Implement Context inspector view
**Priority:** Medium
**Description:** Create:
- src/views/context.rs
- src/components/git_status_panel.rs
- src/components/token_usage_panel.rs
- src/components/directory_tree.rs

Show git status, token usage, Claude.md preview.

---

#### Issue 19: Permissions View
**Title:** Implement Permissions manager view
**Priority:** Medium
**Description:** Create:
- src/views/permissions.rs
- src/components/rule_row.rs
- src/components/add_rule_form.rs

CRUD for permission rules.

---

#### Issue 20: Parallel Agents View
**Title:** Implement Parallel agents view
**Priority:** Medium
**Description:** Create:
- src/views/parallel.rs
- src/components/agent_row.rs
- src/components/issue_row.rs
- src/components/control_panel.rs
- src/components/resource_meter.rs

Show running agents, issue queue, controls.

---

#### Issue 21: Backend Integration
**Title:** Wire up in-process backend
**Priority:** High
**Description:** Create:
- src/backend/mod.rs
- src/backend/sessions.rs - Query sessions from metrics db
- src/backend/permissions.rs - Wrap permission storage
- src/backend/agent.rs - Agent execution integration

Use channels for async communication, poll in event loop.

---

### Component Parity (Phase 4)

#### Issue 22: Port Missing Recorder Components
**Title:** Port recorder components from old ui crate to WGPUI
**Priority:** Medium
**Description:** The old ui crate had recorder/* components. Verify WGPUI has equivalents:

Atoms (14): attempt_badge, blob_ref, call_id_badge, cost_badge, latency_badge, line_type_label, redacted_value, result_arrow, status_dot, step_badge, tid_badge, timestamp_badge, token_badge

Molecules (8): budget_meter, cost_accumulator, line_header, line_meta, metrics_footer, mode_indicator, phase_indicator, result_display

Organisms (14): agent_line, hour_divider, lifecycle_line, mcp_line, phase_line, plan_line, question_line, recall_line, skill_line, subagent_line, thinking_line, time_marker, todo_line, tool_line, user_line

Port any missing to crates/wgpui/src/components/recorder/.

---

#### Issue 23: WGPUI Storybook Example
**Title:** Create WGPUI component showcase example
**Priority:** Medium
**Description:** Create `crates/wgpui/examples/storybook.rs`:
- Component gallery with navigation
- All atoms, molecules, organisms displayed
- Interactive demos

Run with: `cargo run -p wgpui --example storybook --features desktop`

---

#### Issue 24: Update Autopilot UI Renderer
**Title:** Update autopilot ui_renderer to use WGPUI
**Priority:** High
**Description:** Update `crates/autopilot/src/ui_renderer.rs`:
- Replace `use ui::recorder::*` with WGPUI imports
- Update rendering to use WGPUI Scene API

---

## Dependencies

**Add to wgpui:**
- slotmap (entity storage)
- derive_more (Deref derives)

**Remove from workspace:**
- maud
- actix-web
- actix-ws
- wry
- tao

## Testing Strategy

1. Unit tests for Entity system (notify/observe/subscribe)
2. Unit tests for Element lifecycle phases
3. Visual tests via storybook example
4. Integration test: autopilot-gui launches and renders

## Notes

- Reference: Zed GPUI at ~/code/zed/crates/gpui/
- Reference: Previous WGPUI work at ~/code/backroom/archive/openagents/coder/
- Keep existing WGPUI Component trait for backward compat during migration
- No border radius (sharp corners per design spec)
- Vera Mono font only

## Related Directives

- **d-020** - WGPUI Integration (superseded by this directive)
- **d-023** - WGPUI Overview (framework docs)
- **d-024** - Arwes Parity (completed, animations ready)
