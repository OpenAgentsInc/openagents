# Build and push the Laravel web image.
#
# IMPORTANT: submit the build with context limited to the Laravel app directory,
# otherwise Cloud Build will upload the entire monorepo.
#
# Run from repo root:
#   gcloud builds submit \
#     --config apps/openagents.com/deploy/cloudbuild.yaml \
#     --substitutions _TAG="$(git rev-parse --short HEAD)" \
#     apps/openagents.com
substitutions:
  _TAG: ${SHORT_SHA}

steps:
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - -t
      - us-central1-docker.pkg.dev/${PROJECT_ID}/openagents-web/laravel:${_TAG}
      - -t
      - us-central1-docker.pkg.dev/${PROJECT_ID}/openagents-web/laravel:latest
      - .

  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - us-central1-docker.pkg.dev/${PROJECT_ID}/openagents-web/laravel:${_TAG}

  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - us-central1-docker.pkg.dev/${PROJECT_ID}/openagents-web/laravel:latest

images:
  - us-central1-docker.pkg.dev/${PROJECT_ID}/openagents-web/laravel:${_TAG}
  - us-central1-docker.pkg.dev/${PROJECT_ID}/openagents-web/laravel:latest

options:
  logging: CLOUD_LOGGING_ONLY
  substitutionOption: ALLOW_LOOSE
