apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: runtime-alert-rules
  labels:
    app.kubernetes.io/name: runtime
    app.kubernetes.io/component: monitoring
spec:
  groups:
    - name: runtime.slo
      rules:
        - alert: OpenAgentsRuntimeExecutorLatencyP95High
          expr: quantile_over_time(0.95, openagents_runtime_executor_run_once_duration_ms[10m]) > 5000
          for: 10m
          labels:
            severity: warning
            service: runtime
          annotations:
            summary: Runtime executor p95 latency exceeded 5s
            description: Investigate model/tool provider latency and runtime queue pressure.
            runbook: apps/runtime/docs/OPERATIONS_ALERTING.md#executor-latency

        - alert: OpenAgentsRuntimeHttp5xxRateHigh
          expr: sum(rate(phoenix_endpoint_stop_duration_count{status_class="5xx"}[5m])) / clamp_min(sum(rate(phoenix_endpoint_stop_duration_count[5m])), 1) > 0.02
          for: 10m
          labels:
            severity: warning
            service: runtime
          annotations:
            summary: Runtime 5xx ratio exceeded 2%
            description: Runtime API failures are elevated; inspect recent error classes and request traces.
            runbook: apps/runtime/docs/OPERATIONS_ALERTING.md#http-5xx-rate

        - alert: OpenAgentsRuntimeStreamDoneRatioLow
          expr: sum(rate(openagents_runtime_stream_emit_count{event_type="run.finished", outcome="ok"}[10m])) / clamp_min(sum(rate(openagents_runtime_stream_session_count[10m])), 1) < 0.95
          for: 15m
          labels:
            severity: warning
            service: runtime
          annotations:
            summary: Stream completion ratio is below 95%
            description: Stream sessions are not reaching run.finished often enough.
            runbook: apps/runtime/docs/OPERATIONS_ALERTING.md#stream-completion-ratio

        - alert: OpenAgentsRuntimeLeaseStealRateHigh
          expr: sum(rate(openagents_runtime_lease_operation_count{action="acquire", result="stolen"}[5m])) > 0.05
          for: 10m
          labels:
            severity: warning
            service: runtime
          annotations:
            summary: Lease steals are elevated
            description: Excessive lease steals may indicate executor churn or pod instability.
            runbook: apps/runtime/docs/OPERATIONS_ALERTING.md#lease-steal-rate

        - alert: OpenAgentsRuntimeToolFailureSpike
          expr: sum(rate(openagents_runtime_tool_lifecycle_count{phase="terminal", result=~"failed|timeout"}[5m])) > 0.2
          for: 10m
          labels:
            severity: warning
            service: runtime
          annotations:
            summary: Tool failure/timeout rate spiked
            description: Tool runner terminal failures exceed expected baseline.
            runbook: apps/runtime/docs/OPERATIONS_ALERTING.md#tool-failure-rate

        - alert: OpenAgentsRuntimeCircuitBreakerOpen
          expr: max(openagents_runtime_provider_breaker_state{state="open"} or vector(0)) > 0
          for: 5m
          labels:
            severity: critical
            service: runtime
          annotations:
            summary: Provider circuit breaker is open
            description: One or more model/tool provider breakers are open.
            runbook: apps/runtime/docs/OPERATIONS_ALERTING.md#provider-circuit-breakers

        - alert: OpenAgentsRuntimePolicyDenialAnomaly
          expr: sum(rate(openagents_runtime_policy_decision_count{decision!="allowed"}[10m])) / clamp_min(sum(rate(openagents_runtime_policy_decision_count[10m])), 1) > 0.05
          for: 10m
          labels:
            severity: warning
            service: runtime
          annotations:
            summary: Spend/policy denial ratio is above 5%
            description: Elevated denied or exhausted policy decisions detected.
            runbook: apps/runtime/docs/OPERATIONS_ALERTING.md#policy-denial-ratio

        - alert: OpenAgentsRuntimeKhalaProjectionLagP95High
          expr: quantile_over_time(0.95, openagents_runtime_khala_projection_lag_events{result="ok"}[10m]) > 25
          for: 10m
          labels:
            severity: warning
            service: runtime
          annotations:
            summary: Khala projection lag p95 exceeded 25 events
            description: Runtime projector is falling behind recent runtime sequence progression.
            runbook: apps/runtime/docs/OPERATIONS_ALERTING.md#khala-projection-lag

        - alert: OpenAgentsRuntimeKhalaProjectionWriteFailureRatioHigh
          expr: sum(rate(openagents_runtime_khala_projection_write_failure_count[5m])) / clamp_min(sum(rate(openagents_runtime_khala_projection_write_count[5m])), 1) > 0.01
          for: 10m
          labels:
            severity: critical
            service: runtime
          annotations:
            summary: Khala projection write failure ratio exceeded 1%
            description: Runtime projection writes to Khala are failing above error budget.
            runbook: apps/runtime/docs/OPERATIONS_ALERTING.md#khala-projection-write-failures

        - alert: OpenAgentsRuntimeKhalaProjectionDriftIncidentsHigh
          expr: sum(increase(openagents_runtime_khala_projection_drift_count[10m])) > 3
          for: 5m
          labels:
            severity: warning
            service: runtime
          annotations:
            summary: Khala projection drift incidents are elevated
            description: Projection checkpoint drift signals exceeded expected tolerance.
            runbook: apps/runtime/docs/OPERATIONS_ALERTING.md#khala-projection-drift

        - alert: OpenAgentsRuntimeKhalaProjectionHashMismatchDetected
          expr: sum(increase(openagents_runtime_khala_projection_drift_count{reason_class=~"summary_hash_mismatch|hash_and_lag_drift"}[10m])) > 0
          for: 5m
          labels:
            severity: critical
            service: runtime
          annotations:
            summary: Khala projection hash mismatch detected
            description: Projection hash mismatch reasons indicate replay determinism or projection parity drift.
            runbook: apps/runtime/docs/OPERATIONS_ALERTING.md#khala-projection-hash-mismatch

        - alert: OpenAgentsRuntimeKhalaProjectionReplayFailures
          expr: sum(increase(openagents_runtime_khala_projection_replay_count{result="error"}[15m])) > 0
          for: 5m
          labels:
            severity: critical
            service: runtime
          annotations:
            summary: Khala projection replay failure detected
            description: Runtime replay/rebuild path for Khala projections is failing.
            runbook: apps/runtime/docs/OPERATIONS_ALERTING.md#khala-projection-replay

        - alert: OpenAgentsRuntimeSyncSocketAuthFailureRatioHigh
          expr: sum(rate(openagents_runtime_sync_socket_auth_count{status="error"}[5m])) / clamp_min(sum(rate(openagents_runtime_sync_socket_auth_count[5m])), 1) > 0.05
          for: 10m
          labels:
            severity: warning
            service: runtime
          annotations:
            summary: Sync socket auth failures exceeded 5%
            description: Khala websocket auth rejects are elevated.
            runbook: apps/runtime/docs/INCIDENT_WS_AUTH_RECONNECT_STALE_CURSOR.md#incident-a-ws-auth-and-token-failures

        - alert: OpenAgentsRuntimeSyncSocketTimeoutRateHigh
          expr: sum(rate(openagents_runtime_sync_socket_timeout_count{status="timeout"}[5m])) > 0.05
          for: 10m
          labels:
            severity: warning
            service: runtime
          annotations:
            summary: Sync socket timeout rate is elevated
            description: Live websocket sessions are timing out above expected baseline.
            runbook: apps/runtime/docs/INCIDENT_WS_AUTH_RECONNECT_STALE_CURSOR.md#incident-b-ws-reconnect-and-timeout-storm

        - alert: OpenAgentsRuntimeSyncStaleCursorSpike
          expr: sum(increase(openagents_runtime_sync_replay_catchup_duration_ms_count{status="stale_cursor"}[10m])) > 20
          for: 5m
          labels:
            severity: warning
            service: runtime
          annotations:
            summary: Stale cursor incidents spiked
            description: Clients are reconnecting below retention floor and require resnapshot.
            runbook: apps/runtime/docs/INCIDENT_WS_AUTH_RECONNECT_STALE_CURSOR.md#incident-c-stale_cursor-spike

        - alert: OpenAgentsKhalaTokenMintFailureRatioHigh
          expr: ((sum(rate(openagents_laravel_khala_token_mint_total{result="error"}[10m])) or vector(0)) / clamp_min((sum(rate(openagents_laravel_khala_token_mint_total[10m])) or vector(0)), 1)) > 0.01
          for: 15m
          labels:
            severity: warning
            service: runtime
          annotations:
            summary: Khala token mint failure ratio exceeded 1%
            description: Laravel token bridge is failing to issue Khala auth tokens above budget.
            runbook: apps/runtime/docs/OPERATIONS_ALERTING.md#khala-token-mint-failures
