---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_TITLE } from '../consts';
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Register Â· ${SITE_TITLE}`} description="Create an OpenAgents account with email or GitHub." />
	</head>
	<body>
		<Header />
		<main class="auth-main">
			<h1>Register</h1>
			<form id="signup-form" class="auth-form">
				<label for="name">Name</label>
				<input id="name" name="name" type="text" required minlength="1" maxlength="100" autocomplete="name" placeholder="Your name" />
				<label for="email">Email</label>
				<input id="email" name="email" type="email" required autocomplete="email" />
				<label for="password">Password</label>
				<input id="password" name="password" type="password" required minlength="8" autocomplete="new-password" placeholder="At least 8 characters" />
				<p id="signup-error" class="auth-error" hidden></p>
				<button type="submit">Create account</button>
			</form>
			<p class="auth-divider">or</p>
			<button type="button" id="github-signup" class="auth-social">Register with GitHub</button>
			<p class="auth-footer">Already have an account? <a href="/login">Log in</a></p>
		</main>
		<Footer />
		<script>
			import { signIn, signUp } from '../lib/auth-client';
			const form = document.getElementById('signup-form') as HTMLFormElement;
			const errorEl = document.getElementById('signup-error');
			const githubBtn = document.getElementById('github-signup');
			function showError(msg: string) {
				if (errorEl) {
					errorEl.textContent = msg;
					errorEl.hidden = false;
				}
			}
			if (form) {
				form.addEventListener('submit', async (e) => {
					e.preventDefault();
					const name = (form.querySelector('#name') as HTMLInputElement)?.value?.trim();
					const email = (form.querySelector('#email') as HTMLInputElement)?.value?.trim();
					const password = (form.querySelector('#password') as HTMLInputElement)?.value;
					if (!name || !email || !password) return;
					if (password.length < 8) {
						showError('Password must be at least 8 characters');
						return;
					}
					const btn = form.querySelector('button[type="submit"]');
					if (btn) (btn as HTMLButtonElement).disabled = true;
					if (errorEl) errorEl.hidden = true;
					const { data, error } = await signUp.email({ name, email, password, callbackURL: '/' });
					if (error) {
						showError(error.message ?? 'Registration failed');
						if (btn) (btn as HTMLButtonElement).disabled = false;
						return;
					}
					window.location.href = '/';
				});
			}
			if (githubBtn) {
				githubBtn.addEventListener('click', async () => {
					const { data } = await signIn.social({ provider: 'github', callbackURL: window.location.origin + '/' });
					if (data?.url) window.location.href = data.url;
				});
			}
		</script>
		<style>
			.auth-main { padding: 2em 1em; max-width: 360px; margin: 0 auto; }
			.auth-main h1 { margin: 0 0 1rem 0; }
			.auth-form { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; }
			.auth-form label { font-weight: 600; }
			.auth-form input { padding: 0.5rem; border: 1px solid var(--panel-border); border-radius: 4px; }
			.auth-form button { padding: 0.5rem 1rem; cursor: pointer; }
			.auth-error { color: var(--text-error, #c00); font-size: 0.9rem; margin: 0; }
			.auth-divider { text-align: center; color: var(--text-muted); margin: 1rem 0; }
			.auth-social { padding: 0.5rem 1rem; cursor: pointer; width: 100%; }
			.auth-footer { margin-top: 1.5rem; color: var(--text-secondary); }
			.auth-footer a { color: var(--accent); }
		</style>
	</body>
</html>
