[package]
name = "ml"
version.workspace = true
edition.workspace = true
authors.workspace = true
license.workspace = true
publish.workspace = true
description = "Browser-first ML inference library with WebGPU compute"

[lib]
crate-type = ["cdylib", "rlib"]

[features]
default = ["browser"]

candle = ["candle-core", "candle-nn", "candle-transformers", "tokenizers"]

# Browser: WebGPU + CPU fallback
browser = [
    "candle",
    "candle-wgpu",
    "nostr",
    "wasm-bindgen",
    "wasm-bindgen-futures",
    "web-sys",
    "js-sys",
    "gloo-timers",
    "getrandom/js",
]

# Native: Candle CUDA/Metal/CPU
native = ["candle", "compute", "reqwest", "tokio"]
cuda = ["native", "candle-core/cuda", "candle-nn/cuda", "candle-transformers/cuda"]
metal = [
    "native",
    "candle-core/metal",
    "candle-nn/metal",
    "candle-transformers/metal",
]
wgpu = ["dep:wgpu", "dep:pollster", "dep:bytemuck"]

[dependencies]
async-trait = { workspace = true }
thiserror = { workspace = true }
serde = { workspace = true }
serde_json = { workspace = true }
futures = { workspace = true }
parking_lot = "0.12"
web-time = "1.1"
log = "0.4"
uuid = { workspace = true }
rand = { workspace = true }
hex = { workspace = true }
sha2 = { workspace = true }
fancy-regex = "0.13"
memmap2 = "0.9"
rustc-hash = "1.1"
getrandom = { version = "0.2", optional = true }
bytemuck = { workspace = true, optional = true }
pollster = { workspace = true, optional = true }
wgpu = { workspace = true, optional = true }

tokenizers = { version = "0.20", features = ["unstable_wasm"], optional = true }

candle-core = { version = "0.8", optional = true }
candle-nn = { version = "0.8", optional = true }
candle-transformers = { version = "0.8", optional = true }
candle-wgpu = { path = "candle-wgpu", optional = true }

compute = { path = "../compute", optional = true }
nostr = { path = "../nostr/core", optional = true }

tokio = { version = "1", features = ["rt", "sync"], optional = true }
reqwest = { workspace = true, optional = true }

wasm-bindgen = { version = "0.2", optional = true }
wasm-bindgen-futures = { version = "0.4", optional = true }
web-sys = { version = "0.3", optional = true, features = [
    "Headers",
    "Request",
    "RequestInit",
    "Response",
    "Event",
    "Window",
    "Navigator",
    "WebSocket",
    "MessageEvent",
    "CloseEvent",
    "console",
] }
js-sys = { version = "0.3", optional = true }
gloo-timers = { version = "0.3", optional = true }
