<!DOCTYPE html>
<html>
<head>
    <title>Nexus Relay</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="OpenAgents Nexus relay - Nostr relay for the compute marketplace">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>N</text></svg>">
    <style>
        @font-face {
            font-family: 'Bitstream Vera Sans Mono';
            src: local('Bitstream Vera Sans Mono'), local('BitstreamVeraSansMono-Roman');
            font-weight: normal;
            font-style: normal;
        }
        * {
            box-sizing: border-box;
        }
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #0a0a0a;
            font-family: 'Bitstream Vera Sans Mono', 'Courier New', monospace;
            color: #fff;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100vh;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        #loading-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        #loading-bar {
            width: 200px;
            height: 2px;
            background: #333;
            overflow: hidden;
        }
        #loading-progress {
            width: 0%;
            height: 100%;
            background: #fff;
            transition: width 0.2s ease;
        }
        #error {
            display: none;
            color: #f55;
            font-size: 12px;
            margin-top: 16px;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div id="loading-text">Loading...</div>
        <div id="loading-bar">
            <div id="loading-progress"></div>
        </div>
        <div id="error"></div>
    </div>
    <canvas id="canvas"></canvas>
    <script type="module">
        import init, { start_nexus_hud } from './pkg/nexus_client.js';

        async function fetchWithProgress(url, onProgress) {
            const response = await fetch(url);
            const contentLength = response.headers.get('Content-Length');
            const total = contentLength ? parseInt(contentLength, 10) : 0;

            if (!response.body) {
                return response.arrayBuffer();
            }

            const reader = response.body.getReader();
            const chunks = [];
            let received = 0;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                chunks.push(value);
                received += value.length;

                if (onProgress && total) {
                    onProgress(received, total);
                }
            }

            const allChunks = new Uint8Array(received);
            let position = 0;
            for (const chunk of chunks) {
                allChunks.set(chunk, position);
                position += chunk.length;
            }

            return allChunks.buffer;
        }

        async function run() {
            const loadingText = document.getElementById('loading-text');
            const loadingProgress = document.getElementById('loading-progress');
            const errorDiv = document.getElementById('error');

            try {
                loadingText.textContent = 'Loading WASM...';

                const wasmBytes = await fetchWithProgress(
                    './pkg/nexus_client_bg.wasm',
                    (received, total) => {
                        const pct = Math.round((received / total) * 100);
                        loadingProgress.style.width = pct + '%';
                        loadingText.textContent = `Loading... ${pct}%`;
                    }
                );

                loadingText.textContent = 'Initializing...';
                loadingProgress.style.width = '100%';

                await init({ module_or_path: wasmBytes });

                document.getElementById('loading').style.display = 'none';
                await start_nexus_hud('canvas');

            } catch (e) {
                console.error('Failed to start Nexus HUD:', e);
                loadingText.textContent = 'Failed to load';
                errorDiv.style.display = 'block';
                errorDiv.textContent = e.toString();
            }
        }

        run();
    </script>
</body>
</html>
