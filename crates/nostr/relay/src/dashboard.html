<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostr Relay Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
        }

        .header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #1e293b;
        }

        .header h1 {
            color: #f8fafc;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header .status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .status-badge {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            font-weight: 600;
            font-size: 12px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #1e293b;
            padding: 20px;
            border: 1px solid #334155;
        }

        .card h3 {
            color: #94a3b8;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .card .value {
            font-size: 32px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 8px;
        }

        .card .label {
            font-size: 14px;
            color: #64748b;
        }

        .card .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #334155;
        }

        .card .metric-row:last-child {
            border-bottom: none;
        }

        .metric-row .name {
            color: #94a3b8;
            font-size: 14px;
        }

        .metric-row .val {
            color: #f8fafc;
            font-weight: 600;
            font-size: 16px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #334155;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.3s ease;
        }

        .chart-container {
            background: #1e293b;
            padding: 20px;
            border: 1px solid #334155;
            margin-bottom: 20px;
        }

        .chart-title {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .refresh-info {
            text-align: center;
            color: #64748b;
            font-size: 12px;
            margin-top: 20px;
        }

        .highlight-green {
            color: #10b981;
        }

        .highlight-red {
            color: #ef4444;
        }

        .highlight-yellow {
            color: #f59e0b;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Nostr Relay Dashboard</h1>
        <div class="status">
            <span class="status-badge" id="status-badge">ONLINE</span>
            <span>Uptime: <strong id="uptime">--</strong></span>
            <span style="margin-left: auto;" id="last-update">Last updated: --</span>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <h3>Active Connections</h3>
            <div class="value" id="active-connections">--</div>
            <div class="label">Currently connected clients</div>
        </div>

        <div class="card">
            <h3>Events Received</h3>
            <div class="value" id="events-received">--</div>
            <div class="label"><span id="events-per-sec">--</span> events/sec</div>
        </div>

        <div class="card">
            <h3>Active Subscriptions</h3>
            <div class="value" id="active-subscriptions">--</div>
            <div class="label"><span id="avg-subs">--</span> avg per connection</div>
        </div>

        <div class="card">
            <h3>Storage Success Rate</h3>
            <div class="value" id="success-rate">--</div>
            <div class="label">Events stored successfully</div>
            <div class="progress-bar">
                <div class="progress-fill" id="success-rate-bar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">Event Statistics</div>
        <div class="grid">
            <div class="metric-row">
                <span class="name">Total Received</span>
                <span class="val" id="events-total-received">--</span>
            </div>
            <div class="metric-row">
                <span class="name">Stored</span>
                <span class="val highlight-green" id="events-stored">--</span>
            </div>
            <div class="metric-row">
                <span class="name">Rejected (Validation)</span>
                <span class="val highlight-red" id="events-rejected-validation">--</span>
            </div>
            <div class="metric-row">
                <span class="name">Rejected (Signature)</span>
                <span class="val highlight-red" id="events-rejected-signature">--</span>
            </div>
            <div class="metric-row">
                <span class="name">Rejected (Rate Limit)</span>
                <span class="val highlight-yellow" id="events-rejected-rate-limit">--</span>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">Bandwidth</div>
        <div class="grid">
            <div class="metric-row">
                <span class="name">Bytes Received</span>
                <span class="val" id="bytes-received">--</span>
            </div>
            <div class="metric-row">
                <span class="name">Bytes Sent</span>
                <span class="val" id="bytes-sent">--</span>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">Database</div>
        <div class="grid">
            <div class="metric-row">
                <span class="name">Total Queries</span>
                <span class="val" id="db-queries">--</span>
            </div>
            <div class="metric-row">
                <span class="name">Errors</span>
                <span class="val" id="db-errors">--</span>
            </div>
            <div class="metric-row">
                <span class="name">Error Rate</span>
                <span class="val" id="db-error-rate">--</span>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">Rate Limiting & Security</div>
        <div class="grid">
            <div class="metric-row">
                <span class="name">Banned IPs</span>
                <span class="val" id="banned-ips">--</span>
            </div>
            <div class="metric-row">
                <span class="name">Connections Blocked (Banned)</span>
                <span class="val" id="blocked-banned">--</span>
            </div>
            <div class="metric-row">
                <span class="name">Connections Blocked (Rate Limit)</span>
                <span class="val" id="blocked-rate-limit">--</span>
            </div>
        </div>
    </div>

    <div class="refresh-info">
        Dashboard refreshes every 2 seconds
    </div>

    <script>
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (days > 0) {
                return `${days}d ${hours}h ${mins}m`;
            } else if (hours > 0) {
                return `${hours}h ${mins}m ${secs}s`;
            } else if (mins > 0) {
                return `${mins}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        async function fetchStats() {
            try {
                const response = await fetch('/admin/stats');
                const data = await response.json();

                // Update status
                document.getElementById('status-badge').textContent = 'ONLINE';
                document.getElementById('status-badge').style.background = '#10b981';

                // Update uptime
                document.getElementById('uptime').textContent = formatUptime(data.health.uptime_secs);

                // Update last update time
                const now = new Date();
                document.getElementById('last-update').textContent =
                    `Last updated: ${now.toLocaleTimeString()}`;

                // Update main metrics
                document.getElementById('active-connections').textContent =
                    formatNumber(data.connections.active);

                document.getElementById('events-received').textContent =
                    formatNumber(data.events.received);

                document.getElementById('events-per-sec').textContent =
                    data.events.events_per_second.toFixed(2);

                document.getElementById('active-subscriptions').textContent =
                    formatNumber(data.subscriptions.active);

                document.getElementById('avg-subs').textContent =
                    data.subscriptions.avg_per_connection.toFixed(1);

                const successRate = data.events.storage_success_rate;
                document.getElementById('success-rate').textContent = successRate.toFixed(1) + '%';
                document.getElementById('success-rate-bar').style.width = successRate + '%';

                // Update event stats
                document.getElementById('events-total-received').textContent =
                    formatNumber(data.events.received);
                document.getElementById('events-stored').textContent =
                    formatNumber(data.events.stored);
                document.getElementById('events-rejected-validation').textContent =
                    formatNumber(data.events.rejected_validation);
                document.getElementById('events-rejected-signature').textContent =
                    formatNumber(data.events.rejected_signature);
                document.getElementById('events-rejected-rate-limit').textContent =
                    formatNumber(data.events.rejected_rate_limit);

                // Update bandwidth
                document.getElementById('bytes-received').textContent =
                    formatBytes(data.bandwidth.bytes_received);
                document.getElementById('bytes-sent').textContent =
                    formatBytes(data.bandwidth.bytes_sent);

                // Update database stats
                document.getElementById('db-queries').textContent =
                    formatNumber(data.database.queries);
                document.getElementById('db-errors').textContent =
                    formatNumber(data.database.errors);
                document.getElementById('db-error-rate').textContent =
                    data.database.error_rate.toFixed(2) + '%';

                // Update rate limiting
                document.getElementById('banned-ips').textContent =
                    formatNumber(data.rate_limiting.banned_ips);
                document.getElementById('blocked-banned').textContent =
                    formatNumber(data.connections.blocked_banned);
                document.getElementById('blocked-rate-limit').textContent =
                    formatNumber(data.connections.blocked_rate_limit);

            } catch (error) {
                console.error('Error fetching stats:', error);
                document.getElementById('status-badge').textContent = 'ERROR';
                document.getElementById('status-badge').style.background = '#ef4444';
            }
        }

        // Initial fetch
        fetchStats();

        // Refresh every 2 seconds
        setInterval(fetchStats, 2000);
    </script>
</body>
</html>
