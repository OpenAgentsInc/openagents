# OpenAgents Web - Cloudflare Workers configuration
# Deploy with: bun run deploy

name = "openagents-web"
main = "worker/build/index.js"
compatibility_date = "2024-12-01"

# Keep workers.dev subdomain enabled
workers_dev = true

# Custom domains - configure in Cloudflare dashboard
# openagents.com DNS needs to be pointed to this worker first

# Worker build configuration
[build]
command = "cargo install -q worker-build && cd worker && worker-build --release"

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "openagents"
database_id = "8ba16bce-6e9f-41ed-9bfb-3dee08050d65"

# KV Namespace for sessions
[[kv_namespaces]]
binding = "SESSIONS"
id = "0aa10501fe834f84ad33672acf4ed741"

# Durable Objects for WebSocket relay and containers
[durable_objects]
bindings = [
    { name = "TUNNEL_RELAY", class_name = "TunnelRelay" },
    { name = "AUTOPILOT_CONTAINER", class_name = "AutopilotContainer" },
    { name = "AGENT_DO", class_name = "AgentDo" },
    { name = "RLM_RUN_DO", class_name = "RlmRunDO" }
]

[[migrations]]
tag = "v1"
new_sqlite_classes = ["TunnelRelay"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["AutopilotContainer"]

[[migrations]]
tag = "v3"
new_sqlite_classes = ["AgentDo"]

[[migrations]]
tag = "v4"
new_sqlite_classes = ["RlmRunDO"]

# Container configuration (requires paid plan + containers:write scope)
# [[containers]]
# class_name = "AutopilotContainer"
# image = "../autopilot-container/Dockerfile"
# max_instances = 10

# Service binding to wallet worker (for /api/wallet/* routes)
[[services]]
binding = "WALLET"
service = "openagents-wallet"

# Environment variables (non-secret)
[vars]
GITHUB_CLIENT_ID = "Ov23lirHI1DWTzZ1zT1u"
STRIPE_PUBLISHABLE_KEY = ""
# CLAUDE_CLIENT_ID = "" # Set when available
LIVE_HUD_REPO = "openagents/openagents"
LIVE_HUD_AGENT_ID = ""
LIVE_HUD_STREAM_URL = ""
LIVE_HUD_STATUS = "live"
LIVE_HUD_ISSUE_URL = ""
LIVE_HUD_ISSUE_LABEL = ""
LIVE_HUD_ISSUE_TITLE = ""

# Secrets (set via: wrangler secret put <NAME>)
# GITHUB_CLIENT_SECRET
# STRIPE_SECRET_KEY
# STRIPE_WEBHOOK_SECRET
# SESSION_SECRET
# CLAUDE_CLIENT_SECRET

# Static assets (WGPUI client build)
[assets]
directory = "./dist"

# Serve as SPA for client-side routes
not_found_handling = "single-page-application"

# Production environment
[env.production]
name = "openagents-web"

# Preview environment for testing
[env.preview]
name = "openagents-web-preview"

# Local development settings
[dev]
port = 8787
local_protocol = "http"
