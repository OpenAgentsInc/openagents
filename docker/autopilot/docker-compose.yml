# Docker Compose for parallel autopilot agents
#
# Usage:
#   # Start 3 agents (default)
#   docker-compose up -d
#
#   # Start with custom count (requires running start script first)
#   AGENT_COUNT=5 docker-compose up -d
#
#   # View logs
#   docker-compose logs -f
#
#   # Stop all
#   docker-compose down

# Common configuration for all agents
x-agent-common: &agent-common
  build:
    context: ../..
    dockerfile: docker/autopilot/Dockerfile
    args:
      HOST_UID: ${HOST_UID:-1000}
  environment:
    - ISSUES_DB=/shared/autopilot.db
    - AUTOPILOT_MODEL=${AUTOPILOT_MODEL:-sonnet}
    - AUTOPILOT_FULL_AUTO=true
    - RUST_LOG=${RUST_LOG:-info}
  restart: unless-stopped
  networks:
    - autopilot-net

services:
  # Agent 001
  agent-001:
    <<: *agent-common
    container_name: autopilot-001
    hostname: agent-001
    deploy:
      resources:
        limits:
          memory: ${AGENT_MEMORY_001:-12G}
          cpus: "${AGENT_CPUS_001:-4}"
    volumes:
      # Workspace (git worktree)
      - ../../.worktrees/agent-001:/workspace:rw
      # Shared issue database
      - ../../autopilot.db:/shared/autopilot.db:rw
      # Shared log output
      - ../../docs/logs:/workspace/docs/logs:rw
      # Git credentials (read-only)
      - ~/.gitconfig:/home/agent/.gitconfig:ro
      - ~/.ssh:/home/agent/.ssh:ro
      # Container-specific MCP config (uses pre-built binary)
      - ./mcp.json:/workspace/.mcp.json:ro
    environment:
      - AGENT_ID=001
      - ISSUES_DB=/shared/autopilot.db

  # Agent 002
  agent-002:
    <<: *agent-common
    container_name: autopilot-002
    hostname: agent-002
    deploy:
      resources:
        limits:
          memory: ${AGENT_MEMORY_002:-12G}
          cpus: "${AGENT_CPUS_002:-4}"
    volumes:
      - ../../.worktrees/agent-002:/workspace:rw
      - ../../autopilot.db:/shared/autopilot.db:rw
      - ../../docs/logs:/workspace/docs/logs:rw
      - ~/.gitconfig:/home/agent/.gitconfig:ro
      - ~/.ssh:/home/agent/.ssh:ro
      - ./mcp.json:/workspace/.mcp.json:ro
    environment:
      - AGENT_ID=002
      - ISSUES_DB=/shared/autopilot.db

  # Agent 003
  agent-003:
    <<: *agent-common
    container_name: autopilot-003
    hostname: agent-003
    deploy:
      resources:
        limits:
          memory: ${AGENT_MEMORY_003:-12G}
          cpus: "${AGENT_CPUS_003:-4}"
    volumes:
      - ../../.worktrees/agent-003:/workspace:rw
      - ../../autopilot.db:/shared/autopilot.db:rw
      - ../../docs/logs:/workspace/docs/logs:rw
      - ~/.gitconfig:/home/agent/.gitconfig:ro
      - ~/.ssh:/home/agent/.ssh:ro
      - ./mcp.json:/workspace/.mcp.json:ro
    environment:
      - AGENT_ID=003
      - ISSUES_DB=/shared/autopilot.db

  # Agent 004
  agent-004:
    <<: *agent-common
    container_name: autopilot-004
    hostname: agent-004
    profiles:
      - extended
    deploy:
      resources:
        limits:
          memory: ${AGENT_MEMORY_004:-12G}
          cpus: "${AGENT_CPUS_004:-4}"
    volumes:
      - ../../.worktrees/agent-004:/workspace:rw
      - ../../autopilot.db:/shared/autopilot.db:rw
      - ../../docs/logs:/workspace/docs/logs:rw
      - ~/.gitconfig:/home/agent/.gitconfig:ro
      - ~/.ssh:/home/agent/.ssh:ro
      - ./mcp.json:/workspace/.mcp.json:ro
    environment:
      - AGENT_ID=004
      - ISSUES_DB=/shared/autopilot.db

  # Agent 005
  agent-005:
    <<: *agent-common
    container_name: autopilot-005
    hostname: agent-005
    profiles:
      - extended
    deploy:
      resources:
        limits:
          memory: ${AGENT_MEMORY_005:-12G}
          cpus: "${AGENT_CPUS_005:-4}"
    volumes:
      - ../../.worktrees/agent-005:/workspace:rw
      - ../../autopilot.db:/shared/autopilot.db:rw
      - ../../docs/logs:/workspace/docs/logs:rw
      - ~/.gitconfig:/home/agent/.gitconfig:ro
      - ~/.ssh:/home/agent/.ssh:ro
      - ./mcp.json:/workspace/.mcp.json:ro
    environment:
      - AGENT_ID=005
      - ISSUES_DB=/shared/autopilot.db

  # Agents 006-010 (Linux only - high memory)
  agent-006:
    <<: *agent-common
    container_name: autopilot-006
    hostname: agent-006
    profiles:
      - linux-full
    deploy:
      resources:
        limits:
          memory: ${AGENT_MEMORY_006:-12G}
          cpus: "${AGENT_CPUS_006:-4}"
    volumes:
      - ../../.worktrees/agent-006:/workspace:rw
      - ../../autopilot.db:/shared/autopilot.db:rw
      - ../../docs/logs:/workspace/docs/logs:rw
      - ~/.gitconfig:/home/agent/.gitconfig:ro
      - ~/.ssh:/home/agent/.ssh:ro
      - ./mcp.json:/workspace/.mcp.json:ro
    environment:
      - AGENT_ID=006
      - ISSUES_DB=/shared/autopilot.db

  agent-007:
    <<: *agent-common
    container_name: autopilot-007
    hostname: agent-007
    profiles:
      - linux-full
    deploy:
      resources:
        limits:
          memory: ${AGENT_MEMORY_007:-12G}
          cpus: "${AGENT_CPUS_007:-4}"
    volumes:
      - ../../.worktrees/agent-007:/workspace:rw
      - ../../autopilot.db:/shared/autopilot.db:rw
      - ../../docs/logs:/workspace/docs/logs:rw
      - ~/.gitconfig:/home/agent/.gitconfig:ro
      - ~/.ssh:/home/agent/.ssh:ro
      - ./mcp.json:/workspace/.mcp.json:ro
    environment:
      - AGENT_ID=007
      - ISSUES_DB=/shared/autopilot.db

  agent-008:
    <<: *agent-common
    container_name: autopilot-008
    hostname: agent-008
    profiles:
      - linux-full
    deploy:
      resources:
        limits:
          memory: ${AGENT_MEMORY_008:-12G}
          cpus: "${AGENT_CPUS_008:-4}"
    volumes:
      - ../../.worktrees/agent-008:/workspace:rw
      - ../../autopilot.db:/shared/autopilot.db:rw
      - ../../docs/logs:/workspace/docs/logs:rw
      - ~/.gitconfig:/home/agent/.gitconfig:ro
      - ~/.ssh:/home/agent/.ssh:ro
      - ./mcp.json:/workspace/.mcp.json:ro
    environment:
      - AGENT_ID=008
      - ISSUES_DB=/shared/autopilot.db

  agent-009:
    <<: *agent-common
    container_name: autopilot-009
    hostname: agent-009
    profiles:
      - linux-full
    deploy:
      resources:
        limits:
          memory: ${AGENT_MEMORY_009:-12G}
          cpus: "${AGENT_CPUS_009:-4}"
    volumes:
      - ../../.worktrees/agent-009:/workspace:rw
      - ../../autopilot.db:/shared/autopilot.db:rw
      - ../../docs/logs:/workspace/docs/logs:rw
      - ~/.gitconfig:/home/agent/.gitconfig:ro
      - ~/.ssh:/home/agent/.ssh:ro
      - ./mcp.json:/workspace/.mcp.json:ro
    environment:
      - AGENT_ID=009
      - ISSUES_DB=/shared/autopilot.db

  agent-010:
    <<: *agent-common
    container_name: autopilot-010
    hostname: agent-010
    profiles:
      - linux-full
    deploy:
      resources:
        limits:
          memory: ${AGENT_MEMORY_010:-12G}
          cpus: "${AGENT_CPUS_010:-4}"
    volumes:
      - ../../.worktrees/agent-010:/workspace:rw
      - ../../autopilot.db:/shared/autopilot.db:rw
      - ../../docs/logs:/workspace/docs/logs:rw
      - ~/.gitconfig:/home/agent/.gitconfig:ro
      - ~/.ssh:/home/agent/.ssh:ro
      - ./mcp.json:/workspace/.mcp.json:ro
    environment:
      - AGENT_ID=010
      - ISSUES_DB=/shared/autopilot.db

networks:
  autopilot-net:
    driver: bridge
