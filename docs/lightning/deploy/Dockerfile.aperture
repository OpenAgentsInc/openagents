# Build Aperture from Lightning Labs source (for Cloud Run; no reliance on Docker Hub mirror).
# Pin to a commit or tag for reproducible builds.
ARG APERTURE_REF=master
FROM golang:1.24-bookworm AS builder
ARG APERTURE_REF
WORKDIR /src
RUN apt-get update && apt-get install -y --no-install-recommends git ca-certificates && rm -rf /var/lib/apt/lists/*
COPY aperture-private-invoices.patch /tmp/aperture-private-invoices.patch
RUN git clone --depth 1 --branch "${APERTURE_REF}" https://github.com/lightninglabs/aperture.git . || \
    (git clone https://github.com/lightninglabs/aperture.git . && git checkout "${APERTURE_REF}")
RUN git apply /tmp/aperture-private-invoices.patch
RUN go build -o /aperture ./cmd/aperture

FROM debian:bookworm-slim
RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates && rm -rf /var/lib/apt/lists/* \
  && mkdir -p /tmp && chmod 1777 /tmp
COPY --from=builder /aperture /aperture
EXPOSE 8080
# Cloud Run sets PORT=8080; ensure /tmp is used for SQLite (writable in Cloud Run).
ENV TMPDIR=/tmp
ENTRYPOINT ["/aperture"]
# Default: pass config path as first arg, e.g. --args=/voltage-cfg/config.yaml
