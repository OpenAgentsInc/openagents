# syntax=docker/dockerfile:1

FROM node:22-bookworm-slim

WORKDIR /workspace

# Native build deps for better-sqlite3 when prebuilt binaries are unavailable.
RUN apt-get update \
  && apt-get install -y --no-install-recommends python3 make g++ \
  && rm -rf /var/lib/apt/lists/*

# Copy package metadata first for better layer caching.
COPY apps/lightning-wallet-executor/package.json apps/lightning-wallet-executor/package-lock.json ./apps/lightning-wallet-executor/
COPY packages/lightning-effect/package.json ./packages/lightning-effect/package.json
COPY packages/lightning-effect/src ./packages/lightning-effect/src

WORKDIR /workspace/apps/lightning-wallet-executor

# Keep dev deps because runtime uses tsx to execute TypeScript directly.
RUN npm ci --include=dev --omit=optional

# Copy executor source after dependency install.
WORKDIR /workspace
COPY apps/lightning-wallet-executor ./apps/lightning-wallet-executor

# `@openagentsinc/lightning-effect` is imported from `/workspace/packages/lightning-effect/src`,
# so provide a workspace-level node_modules path for peer deps (for example `effect`).
RUN ln -s /workspace/apps/lightning-wallet-executor/node_modules /workspace/node_modules

WORKDIR /workspace/apps/lightning-wallet-executor

EXPOSE 8080

CMD ["npm", "run", "start"]
