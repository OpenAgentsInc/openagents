# Build Aperture image and push to Artifact Registry. Run from repo root:
#   gcloud builds submit --config docs/lightning/deploy/cloudbuild-aperture.yaml docs/lightning/deploy
substitutions:
  _TAG: ${SHORT_SHA}
steps:
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-f'
      - 'Dockerfile.aperture'
      - '-t'
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/l402/aperture:${_TAG}'
      - '-t'
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/l402/aperture:latest'
      - '.'
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-central1-docker.pkg.dev/${PROJECT_ID}/l402/aperture:${_TAG}']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-central1-docker.pkg.dev/${PROJECT_ID}/l402/aperture:latest']
images:
  - 'us-central1-docker.pkg.dev/${PROJECT_ID}/l402/aperture:${_TAG}'
  - 'us-central1-docker.pkg.dev/${PROJECT_ID}/l402/aperture:latest'
options:
  logging: CLOUD_LOGGING_ONLY
  substitutionOption: ALLOW_LOOSE
