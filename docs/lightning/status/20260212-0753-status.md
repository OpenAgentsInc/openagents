# OpenAgents Bitcoin + Lightning Status Snapshot (2026-02-12)

Status: Implemented (buyer/L402), partially implemented (local-node + hosted seller infra)
Last reviewed: 2026-02-12 (post-EP212 buyer demo implementation + Lightning Storybook stories)
Scope: `packages/lightning-effect`, `packages/lnd-effect`, `apps/web`, `apps/autopilot-worker`, `apps/desktop`, `apps/lightning-ops`, `apps/mobile`

This document is a "what exists in code right now" snapshot, not a roadmap. Where something is only scaffolded, it is called out explicitly.

NOTE (2026-02-15): This snapshot predates the EP212 shift to a **server-side Spark wallet executor** (Cloud Run) + **Aperture on Cloud Run backed by GCP LND/Bitcoin Core**. For the current deployed state, see `docs/lightning/status/20260215-current-status.md`.

**Operator checklist:** For "what you need to do now" (staging reconcile, CI, product wiring, changing Aperture routes), see **§12** below.

## 0) Summary

1. `@openagentsinc/lightning-effect` is the canonical Effect-first Lightning domain package. It implements the L402 buyer handshake (402 parse -> policy -> pay -> cache -> retry) and also contains typed seller/paywall contracts + deterministic seller test layers.
2. `@openagentsinc/lnd-effect` is the canonical Effect-first LND boundary package. It defines typed contracts/services and provides deterministic + REST transport layers.
3. `openagents.com` (`apps/web`) provides the Lightning "control plane":
   - Khala tables + mutations/queries for L402 tasks, paywalls, settlements, deployments, and events.
   - Worker HTTP APIs under `/api/lightning/*` that wrap those Khala operations with deterministic error taxonomy.
   - A typed Effect client (`LightningApiService`) used by UI/controllers to call the control plane.
   - UI panes that surface L402 attempts and hosted paywall state.
4. Autopilot Lightning tools:
   - Tool contracts live in `apps/autopilot-worker/src/tools.ts` (imported by the web host runtime).
   - `openagents.com` host implementation is in `apps/web/src/effuse-host/autopilot.ts`:
     - `lightning_l402_fetch` schedules a Khala task and, by default, returns an approval intent (`status: queued`, `approvalRequired: true`) before any payment executes.
     - `lightning_l402_approve` approves a queued task (after a desktop-online preflight) so the desktop executor can run it.
     - `lightning_paywall_*` call the web control-plane HTTP endpoints (token gated) and return deterministic receipts.
5. The desktop app (`apps/desktop`) is the buyer-side payment executor boundary:
   - Main process bootstraps a real Spark wallet via Breez Spark SDK and can pay BOLT11 invoices with preimage extraction.
   - Main process also boots a local `lnd` Neutrino process (bundled binary, supervised with restart/backoff), but wallet/RPC/payment wiring to that running process is not yet complete.
   - Renderer runs an Effect-based executor loop that consumes Khala Lightning tasks and executes `fetchWithL402` using Spark when connected (else a deterministic LND fallback).
6. The mobile app (`apps/mobile`) currently has no Lightning/L402 wallet integration.

## 0.1 Recent Updates (After Original Snapshot)

This status doc started as a 07:53 snapshot. Since then (still on 2026-02-12), we implemented the EP212 external-L402 buyer demo end-to-end and added supporting tooling:

1. `lightning_l402_fetch` / `lightning_l402_approve` approval gating is live in the web host (`apps/web/src/effuse-host/autopilot.ts`) and UI (approve button in the payment state card).
2. Desktop executor now:
   - persists an L402 credential cache (host/scope) in encrypted `safeStorage` (default TTL 10 minutes), and
   - writes bounded premium response previews + SHA256 hashes into task metadata (see Section 4.4 / 5.4).
3. Added desktop-online preflight via an executor presence heartbeat:
   - Khala table: `apps/web/khala/schema.ts` (`lightningExecutorPresence`)
   - APIs: `apps/web/src/effuse-host/lightning.ts` (`/api/lightning/executor/presence`)
4. Added deterministic integration tests that cover paid + cached + blocked flows:
   - Desktop: `apps/desktop/tests/l402ExternalFlowDeterministic.integration.test.ts`
5. Added Effuse Storybook stories for the Lightning UI states (payment cards + panes):
   - `apps/web/src/storybook/stories/lightning.ts`

## 1) What Runs Where

| Component | Location | Purpose | Notes |
| --- | --- | --- | --- |
| L402 contracts + buyer logic | `packages/lightning-effect` | Parse `WWW-Authenticate: L402 ...`, enforce spend policy, pay invoice via adapter, cache credential, retry request | App-agnostic, intended to be reusable outside OpenAgents |
| LND contracts + transports | `packages/lnd-effect` | Typed LND boundary + deterministic and REST transport layers | App-agnostic, used by `lightning-effect` adapters and desktop fallback |
| Lightning control-plane data model | `apps/web/khala/lightning/*` | Tasks/paywalls/settlements/deployments/events schema + lifecycle enforcement | Source-of-truth state machine for L402 task execution |
| Lightning control-plane client | `apps/web/src/effect/lightning.ts` | Typed Effect client for tasks/paywalls/settlements/deployments | Mixes Khala queries with Worker HTTP APIs |
| Lightning HTTP API surface | `apps/web/src/effuse-host/lightning.ts` | `/api/lightning/*` routes for tasks + paywall ops, with deterministic error mapping | Used by desktop and paywall tools |
| Autopilot Lightning tools | Contracts: `apps/autopilot-worker/src/tools.ts` (imported by web host). Host: `apps/web/src/effuse-host/autopilot.ts` | Expose `lightning_l402_fetch`, `lightning_l402_approve`, and `lightning_paywall_*` into Autopilot | Payment execution remains desktop-only |
| Desktop executor boundary | `apps/desktop` | Owns wallet/payment execution and background task processing | Spark path is the real payment backend today |
| Hosted gateway ops | `apps/lightning-ops` | Deterministic Aperture config compiler + reconcile/smoke programs | Infrastructure wiring is not fully deployed yet |

## 2) Shared Packages

### 2.1 `packages/lightning-effect` (L402 + Lightning domain)

Package: `packages/lightning-effect/package.json`

Primary responsibilities:

1. Buyer-side L402 handshake in Effect: `packages/lightning-effect/src/l402/fetchWithL402.ts`
2. L402 contracts + schema decode/encode:
   - `packages/lightning-effect/src/contracts/l402.ts`
   - `packages/lightning-effect/src/contracts/payment.ts`
3. Buyer-side service tags:
   - `packages/lightning-effect/src/services/l402Client.ts`
   - `packages/lightning-effect/src/services/credentialCache.ts`
   - `packages/lightning-effect/src/services/invoicePayer.ts`
   - `packages/lightning-effect/src/services/spendPolicy.ts`
   - `packages/lightning-effect/src/services/l402Transport.ts`
4. Buyer adapters/layers:
   - Demo payer: `packages/lightning-effect/src/adapters/invoicePayerDemo.ts`
   - LND REST payer (direct): `packages/lightning-effect/src/adapters/invoicePayerLnd.ts`
   - Spark payer adapter: `packages/lightning-effect/src/adapters/invoicePayerSpark.ts`
   - `lnd-effect` bridge adapter: `packages/lightning-effect/src/lnd-effect/*`
5. Seller-side contracts and deterministic layers for hosted paywalls:
   - Contracts live under `packages/lightning-effect/src/contracts/seller/*` (via `src/contracts/index.ts`)
   - Service tags include `PaywallRegistryService`, `GatewayConfigCompilerService`, `InvoiceIssuerService`, `SettlementIngestService`, `SellerPolicyService` (see `packages/lightning-effect/README.md`)

Key implementation details of the buyer flow (`fetchWithL402`):

1. Host scoping is derived from the request URL via `new URL(url).host` (lowercased).
2. Cache key is `(host, scope)` where `scope` defaults to `"default"` (override via request `scope`).
3. If cache is hit, request is attempted with `Authorization: L402 ...`.
4. A `402` or `401` invalidates cached credentials and triggers challenge resolution.
5. The L402 challenge is parsed from `WWW-Authenticate` (case-insensitive header name).
6. Spend policy gates *before* paying:
   - `deps.policy.ensureRequestAllowed({ host, quotedAmountMsats, maxSpendMsats })`
7. Invoice is paid via `deps.payer.payInvoice({ invoice, maxAmountMsats, host })`.
8. The credential is cached and the request is retried with `Authorization: L402 macaroon="...", preimage="..."`.
9. A post-payment `402`/`401` invalidates the cached credential and fails with `CredentialMissingError`.

Current OpenAgents usage notes (payload handling):

1. The desktop executor persists a **bounded** response preview (`responseBodyTextPreview`, first 8192 UTF-8 bytes) plus `responseBodySha256` (hex digest of full body) into task transition metadata.
2. `lightning_l402_fetch` tool output includes those fields so the model can summarize premium payloads deterministically, without storing unlimited response bodies in Khala.

Tests:

1. `packages/lightning-effect/test/*` covers challenge parsing, auth header serialization, spend policy gates, payer contracts, Spark integration, and seller contract determinism.
2. Run:
   - `cd packages/lightning-effect && npm run typecheck`
   - `cd packages/lightning-effect && npm test`

### 2.2 `packages/lnd-effect` (LND boundary)

Package: `packages/lnd-effect/package.json`

Primary responsibilities:

1. Define typed LND contracts (node info, balances, channels, wallet state): `packages/lnd-effect/src/contracts/lnd.ts`
2. Define RPC transport contracts and request/response schemas: `packages/lnd-effect/src/contracts/rpc.ts`
3. Provide deterministic adapters for tests and offline flows:
   - `packages/lnd-effect/src/adapters/lndNodeDeterministic.ts` exports `makeLndDeterministicLayer(...)`
4. Provide REST transport layer with typed auth/transport/decode errors:
   - `packages/lnd-effect/src/adapters/lndRestTransport.ts`
   - `packages/lnd-effect/src/layers/lndRestTransport.ts`

Current OpenAgents usage:

1. Desktop L402 executor includes an LND deterministic fallback payment backend via `makeLndDeterministicLayer()` (see Section 4.4).
2. `lightning-effect` can be wired to real LND via:
   - `packages/lightning-effect/src/adapters/invoicePayerLnd.ts` (direct REST)
   - `packages/lightning-effect/src/lnd-effect/*` (via `lnd-effect` services)

Tests:

1. `packages/lnd-effect/test/*` covers deterministic layers and transport error mapping.
2. Run:
   - `cd packages/lnd-effect && npm run typecheck`
   - `cd packages/lnd-effect && npm test`

## 3) L402 Buyer Flow (Protocol and Current Implementation)

### 3.1 Protocol shape

For an L402-protected endpoint, the server responds:

1. HTTP `402 Payment Required`
2. `WWW-Authenticate: L402 ...` containing:
   - `invoice="ln..."`
   - `macaroon="..."`
   - optional `amount_msats=...`

The client pays the invoice, obtains a preimage, and retries with:

1. `Authorization: L402 macaroon="<macaroon>", preimage="<preimage>"`

### 3.2 OpenAgents buyer execution (as implemented)

The current buyer execution path in OpenAgents is:

1. Autopilot creates a Khala Lightning task with L402 request details.
2. Desktop executor polls **approved** tasks for the signed-in user (queued tasks require approval).
3. Desktop executor runs `fetchWithL402` with:
   - Live HTTP transport (`fetch`)
   - Persistent credential cache (host/scope) via encrypted Electron `safeStorage` (TTL-based; default 10 minutes)
   - Spend policy
   - Invoice payer: Spark (preferred) or deterministic LND fallback
4. Desktop writes task transitions and payment metadata back to the control plane.

## 4) Desktop App (`apps/desktop`)

Desktop is the execution boundary for wallet/payment operations. It is intentionally split into:

1. Main process: owns secrets, spawns `lnd`, manages Spark wallet, exposes restricted IPC APIs
2. Renderer: Effect runtime, UI panes, Khala task execution loop (no secret-bearing values)

### 4.1 Main process: LND runtime supervisor (Neutrino)

Core files:

1. Runtime manager: `apps/desktop/src/main/lndRuntimeManager.ts`
2. Config builder: `apps/desktop/src/main/lndRuntimeConfig.ts`
3. Bundled binary resolver: `apps/desktop/src/main/lndBinaryResolver.ts`
4. Process transport: `apps/desktop/src/main/lndProcessTransport.ts`

Binary shipping model:

1. Pinned release manifest: `apps/desktop/lnd/lnd-artifacts.json` (currently `v0.20.0-beta`)
2. Prepare script downloads + verifies archive and binary checksums:
   - `apps/desktop/scripts/prepare-lnd-binaries.mjs`
   - Stages under `apps/desktop/build-resources/lnd/<target>/`
   - Writes `apps/desktop/build-resources/lnd/runtime-manifest.json`
3. Packaged apps load the binary from `process.resourcesPath/lnd/...`
4. Dev builds load from `apps/desktop/build-resources/lnd/...`
5. Optional local override for a dev-built binary:
   - `OA_DESKTOP_LND_DEV_BINARY_PATH=/Users/christopherdavid/code/lnd/lnd`
   - Optional `OA_DESKTOP_LND_DEV_BINARY_SHA256=<sha256>` to enforce integrity

Default Neutrino runtime config (dev defaults, override via env):

1. Network: `testnet`
2. RPC listen: `127.0.0.1:10009`
3. REST listen: `127.0.0.1:8080`
4. P2P listen: `127.0.0.1:19735` (chosen to avoid common `9735` conflicts)
5. Config path: `${userData}/lnd/<network>/config/lnd.conf`
6. Data/log dirs: `${userData}/lnd/<network>/{data,logs}`

Health + sync observation:

1. The runtime manager attempts a REST `GET /v1/getinfo` probe.
2. It requires:
   - TLS cert at `${configDir}/tls.cert`
   - `admin.macaroon` at `${runtimeDir}/data/chain/bitcoin/<network>/admin.macaroon`
3. If `admin.macaroon` is not present, the runtime reports `admin_macaroon_unavailable` and sync fields remain null.

Important current limitation:

1. The desktop app does not yet wire the wallet unlock/init path to the *real* LND process RPC. Until that exists, `admin.macaroon` availability and REST probing will not become "fully healthy" in a fresh install without manual wallet initialization.

### 4.2 Main process: Spark wallet (Breez Spark SDK) with NIP-06 mnemonic

Core files:

1. Spark manager: `apps/desktop/src/main/sparkWalletManager.ts`
2. IPC channels: `apps/desktop/src/main/sparkWalletIpc.ts`
3. Secure storage: `apps/desktop/src/main/desktopSecureStorage.ts`

Key behaviors:

1. Uses `nostr-effect` NIP-06 helpers:
   - `generateSeedWords()` for mnemonic generation
   - `validateWords()` for mnemonic validation
2. Stores mnemonic in OS-provided encryption via Electron `safeStorage` (never exposed to renderer):
   - storage key: `spark.wallet.mnemonic`
3. Connects Spark via `@breeztech/breez-sdk-spark/nodejs` using `SdkBuilder` and a persistent storage dir:
   - default: `${userData}/spark`
4. Pays BOLT11 invoices:
   - Calls `prepareSendPayment`
   - Calls `sendPayment`
   - Extracts lightning preimage from `payment.details` when `type === "lightning"`
   - Returns `InvoicePaymentResult` with `preimageHex` required for L402 auth

Spark env configuration:

1. `OA_DESKTOP_SPARK_NETWORK`: `mainnet` or `regtest` (default `regtest`)
2. `OA_DESKTOP_SPARK_API_KEY` or `OA_DESKTOP_BREEZ_API_KEY`: required for real network usage
3. `OA_DESKTOP_SPARK_MNEMONIC_PASSPHRASE`: optional
4. `OA_DESKTOP_SPARK_AUTO_GENERATE_MNEMONIC`: set to `0` to disable auto-generation
5. `OA_DESKTOP_SPARK_PAYMENT_TIMEOUT_SECS`: default `45` (bounded)

### 4.3 Main process: Wallet manager (current state)

Core files:

1. Wallet manager: `apps/desktop/src/main/lndWalletManager.ts`
2. Local wallet state service: `apps/desktop/src/main/lndWalletLocalService.ts`

Current behavior:

1. Wallet lifecycle state is persisted locally and deterministically (JSON file under `${userData}/lnd/wallet/wallet-state.json`).
2. This is a scaffolding layer to support UI + control-plane wiring without depending on real LND wallet RPC being present.
3. This does not yet unlock/create the *real* LND wallet inside the running `lnd` process.

### 4.4 Renderer: L402 executor + task loop

Core files:

1. L402 executor: `apps/desktop/src/effect/l402Executor.ts`
2. Executor loop: `apps/desktop/src/effect/executorLoop.ts`
3. Task provider transport: `apps/desktop/src/effect/taskProvider.ts`
4. Spark renderer gateway: `apps/desktop/src/effect/sparkWalletGateway.ts`
5. Desktop runtime model: `apps/desktop/src/effect/model.ts`

Backend selection:

1. If Spark wallet lifecycle is `connected`, invoice payer is Spark.
2. Otherwise invoice payer is deterministic LND (via `makeLndDeterministicLayer()`), and `paymentBackend` is recorded as `lnd_deterministic`.

Task control-plane interaction:

1. Desktop authenticates as the same user as `openagents.com` via the magic-code flow.
2. Desktop stores the session token in memory and uses it as `Authorization: Bearer ...` against web Worker APIs:
   - `POST /api/lightning/l402/tasks/:taskId/transition`
   - `GET /api/lightning/l402/tasks?...`
3. Desktop loops every `OA_DESKTOP_EXECUTOR_TICK_MS` (default 2000ms) and:
   - heartbeats executor presence (device id + capabilities)
   - polls for an **approved** task (queued tasks require explicit approval)
   - transitions `approved -> running`
   - executes L402 fetch/payment
   - transitions to `paid` or `cached`, then `completed` (or `blocked`/`failed`)

Current behavior:

1. Desktop persists the L402 credential cache (host/scope) across restarts via encrypted Electron `safeStorage`:
   - Store: `apps/desktop/src/main/l402CredentialCacheStore.ts` (secret key `lightning.l402.credential-cache.v1`)
   - Renderer bridge: `apps/desktop/src/preload.ts` (`window.openAgentsDesktop.l402CredentialCache`)
   - Default TTL: 10 minutes
2. Desktop writes premium response metadata into Khala task transition metadata:
   - `responseBodyTextPreview` (first 8192 bytes)
   - `responseBodySha256` (full-body sha256 hex)
   - plus `responseStatusCode`, `responseContentType`, `responseBytes`
3. Desktop heartbeats executor presence every tick (`/api/lightning/executor/presence`) so the web host can block approval if the executor is offline.

### 4.5 UI panes (Effuse panes)

Renderer is Effuse-based and uses the pane system (shared lineage with `apps/web`):

1. Pane mounting: `apps/desktop/src/renderer.ts` uses `@openagentsinc/effuse-panes`
2. Pane models: `apps/desktop/src/effect/paneModels.ts`
3. Layout/specs: `apps/desktop/src/effect/paneLayout.ts`

Desktop currently surfaces:

1. Node runtime status and logs (LND supervisor)
2. Wallet lifecycle scaffolding state
3. Spark wallet lifecycle/balance/errors
4. Executor queue status and failure classification

### 4.6 Desktop verification commands

From `apps/desktop/package.json`:

1. `cd apps/desktop && npm run typecheck`
2. `cd apps/desktop && npm run lint`
3. `cd apps/desktop && npm test`
4. LND binary prep and smokes:
   - `cd apps/desktop && npm run lnd:prepare`
   - `cd apps/desktop && npm run smoke:lnd-binary -- --json`
   - `cd apps/desktop && npm run smoke:lnd-runtime -- --json`
   - `cd apps/desktop && npm run smoke:lnd-runtime-real -- --json` (opt-in real binary test)

## 5) Web App (`apps/web`) Control Plane + UI

### 5.1 Khala Lightning data model

Khala modules (source-of-truth lifecycle):

1. L402 tasks: `apps/web/khala/lightning/tasks.ts`
2. Hosted paywalls: `apps/web/khala/lightning/paywalls.ts`
3. Settlements: `apps/web/khala/lightning/settlements.ts`
4. Ops/deployments: `apps/web/khala/lightning/ops.ts`
5. Security gates: `apps/web/khala/lightning/security.ts`

Tasks state machine (current statuses):

1. `queued`
2. `approved`
3. `running`
4. `paid`
5. `cached`
6. `blocked`
7. `failed`
8. `completed`

### 5.2 Worker HTTP APIs

Worker handler: `apps/web/src/effuse-host/lightning.ts`

This file implements deterministic JSON APIs under `/api/lightning/*` and normalizes:

1. input shape via Effect `Schema`
2. error taxonomy into stable HTTP status codes
3. request correlation via `x-oa-request-id`

Control-plane endpoints used today (not exhaustive):

1. L402 tasks:
   - `POST /api/lightning/l402/tasks` (create task)
   - `GET /api/lightning/l402/tasks?status=&limit=` (list tasks)
   - `POST /api/lightning/l402/tasks/:taskId/transition` (transition task)
2. Hosted paywalls:
   - `GET /api/lightning/paywalls?status=&limit=`
   - `GET /api/lightning/paywalls/:paywallId`
   - `POST /api/lightning/paywalls` (create)
   - `PATCH /api/lightning/paywalls/:paywallId` (update)
   - `POST /api/lightning/paywalls/:paywallId/pause`
   - `POST /api/lightning/paywalls/:paywallId/resume`
3. Settlements and deployments:
   - `GET /api/lightning/settlements`
   - `GET /api/lightning/paywalls/:paywallId/settlements`
   - `GET /api/lightning/deployments`
   - `GET /api/lightning/deployments/events`

These endpoints are consumed by:

1. Desktop app (Bearer token, user-scoped)
2. Autopilot paywall tool control plane (token-scoped, see Section 6.2)

### 5.3 UI: L402 panes

Pane wiring is in the Effuse controller layer:

1. Pane controller: `apps/web/src/effuse-app/controllers/home/openChatPaneController.ts`
2. L402 payment metadata extraction: `apps/web/src/effuse-app/controllers/autopilotChatParts.ts`

Pane IDs currently used:

1. `l402-wallet` (wallet summary derived from recent L402 attempts)
2. `l402-transactions` (recent L402 attempts)
3. `l402-paywalls` (hosted paywall list)
4. `l402-settlements` (settlement list)
5. `l402-deployments` (deployment + events list)
6. Per-payment detail panes opened dynamically from transaction rows

Important nuance:

1. The "wallet" and "transactions" panes are projections of *tool/task metadata* (attempts, statuses, amounts), not a direct on-chain/node wallet balance.

### 5.4 Autopilot integration in web host

Tool execution wiring (web host side):

1. Autopilot host: `apps/web/src/effuse-host/autopilot.ts`
2. L402 buying tools (contracts imported from `apps/autopilot-worker/src/tools.ts`):
   - `lightning_l402_fetch` (schedule + optionally wait)
   - `lightning_l402_approve` (explicit approval transition)
3. `lightning_l402_fetch` behavior:
   - Resolves endpoint URL from either `endpointPreset` (EP212) or `url` (direct) and sanitizes request headers (when direct).
   - Creates a Lightning task in Khala (`api.lightning.tasks.createTask`) with initial `status: queued`.
   - If `requireApproval` (default **true**), returns an approval intent:
     - `status: queued`, `approvalRequired: true`, `taskId`, `host`, `maxSpendMsats`.
   - If `requireApproval: false`, auto-approves the task after a desktop-online preflight (executor presence), then polls for a terminal status.
4. `lightning_l402_approve` behavior:
   - Performs a desktop-online preflight via `api.lightning.presence.getLatestExecutorPresence`.
   - If the executor is offline/stale, approval is denied with `desktop_executor_offline`.
   - Otherwise transitions the task from `queued -> approved` so the desktop executor can pick it up.
5. Terminal tool outputs (once the desktop finishes) include:
   - status (`completed|cached|blocked|failed`)
   - proof/policy/cache metadata: `proofReference`, `denyReason`, `denyReasonCode`, `quotedAmountMsats`, `cacheHit`, `cacheStatus`, `paid`, `paymentBackend`, etc.
   - response metadata: `responseStatusCode`, `responseContentType`, `responseBytes`
   - bounded payload fields: `responseBodyTextPreview` (<= 8192 bytes) + `responseBodySha256` (sha256 hex of full body)

### 5.5 Storybook coverage (Lightning UI)

Effuse Storybook lives in `apps/web` (see `docs/STORYBOOK.md`).

Lightning-specific stories were added in:

1. `apps/web/src/storybook/stories/lightning.ts`

These stories cover:

1. L402 payment state cards (intent/approve, paid, cached, blocked, failed).
2. Home chat snippets showing approval and cache reuse.
3. L402 wallet summary, transactions list, and payment detail panes.

## 6) Autopilot Worker (`apps/autopilot-worker`)

### 6.1 L402 buying tools (`lightning_l402_*`)

Contracts: `apps/autopilot-worker/src/tools.ts`
Implementation (DO runtime): `apps/autopilot-worker/src/server.ts`

Current status:

1. The `apps/autopilot-worker` DO runtime currently returns deterministic deny responses for:
   - `lightning_l402_fetch`
   - `lightning_l402_approve`
2. Reason: `desktop_executor_not_configured_in_do_runtime`
3. The real production wiring for `openagents.com` is implemented in the web host:
   - `apps/web/src/effuse-host/autopilot.ts` (see Section 5.4)
   - schedules Khala tasks and relies on the desktop executor for payment execution

### 6.2 Hosted paywall tools (`lightning_paywall_*`)

Contracts: `apps/autopilot-worker/src/tools.ts`
HTTP control plane executor: `apps/autopilot-worker/src/lightningPaywallControlPlane.ts`

Behavior:

1. Reads control plane config from Worker env:
   - `OA_LIGHTNING_CONTROL_PLANE_BASE_URL`
   - `OA_LIGHTNING_CONTROL_PLANE_AUTH_TOKEN`
2. Calls the corresponding `apps/web` Worker endpoint (`/api/lightning/paywalls`, etc.).
3. Returns deterministic receipts with:
   - params_hash
   - output_hash
   - latency_ms
   - structured side effects

## 7) Hosted Seller Stack (Current Implementation Status)

Implemented in code (scaffolding + deterministic pieces):

1. Seller/paywall contracts and services in `packages/lightning-effect` (see `packages/lightning-effect/README.md`).
2. Khala control-plane for paywalls/settlements/deployments in `apps/web/khala/lightning/*`.
3. Worker HTTP API routes for paywall CRUD and listings in `apps/web/src/effuse-host/lightning.ts`.
4. `apps/lightning-ops`:
   - Deterministic Aperture config compiler (`aperture.yaml` + stable `configHash`)
   - Reconcile skeletons for staging workflows
   - Smoke programs for observability correlation

Not yet implemented in production:

1. A deployed Aperture gateway runtime that serves real L402-protected routes for OpenAgents-hosted paywalls.
2. Settlement ingestion from a real node into Khala settlement records.
3. Key isolation (remote signer) and macaroon bakery flows for hosted infrastructure.

## 8) `apps/lightning-ops` (Hosted gateway operations)

Entry point:

1. `apps/lightning-ops/src/main.ts`

Core responsibilities today:

1. Compile deterministic gateway config (Aperture yaml) from paywall definitions.
2. Provide reconcile/smoke programs that validate:
   - determinism of compilation
   - control-plane compatibility
   - observability record completeness

Verification:

1. `cd apps/lightning-ops && npm run typecheck`
2. `cd apps/lightning-ops && npm test`
3. `cd apps/lightning-ops && npm run smoke:full-flow`

## 9) Mobile (`apps/mobile`)

Current status:

1. No Lightning wallet, Spark, LND, or L402 execution is implemented in the React Native app yet.
2. Mobile remains an Autopilot product surface and Khala client; Lightning is currently executed via desktop + web control plane.

## 10) Known Gaps (Current)

These are gaps in *current implementation*, not "ideas":

1. Real LND wallet lifecycle and macaroon/TLS readiness are not wired end-to-end (desktop wallet manager is local-state scaffolding).
2. Desktop L402 executor does not use the real local `lnd` process as a payment backend yet.
3. `apps/autopilot-worker` DO runtime does not execute `lightning_l402_*` yet (see Section 6.1); `openagents.com` uses the `apps/web` host implementation.
4. Hosted paywall contracts/control-plane exist, but there is no deployed Aperture gateway runtime yet.
5. Mobile has no Lightning wallet / L402 execution integration yet.

## 11) EP212 Demo Plan Delta (`docs/plans/active/lightning/212-demo-plan.md`)

### 11.1 What’s already implemented (code)

The EP212 external-L402 buying demo is implemented end-to-end in code:

1. Effect-first L402 buyer stack:
   - `packages/lightning-effect` (buyer handshake + spend policy + caching + Spark payer adapter)
2. Web control plane + UI:
   - Khala Lightning tasks + events (`apps/web/khala/lightning/tasks.ts`)
   - Worker APIs (`apps/web/src/effuse-host/lightning.ts`)
   - Autopilot tool wiring (`apps/web/src/effuse-host/autopilot.ts`)
   - L402 panes and payment detail (`apps/web/src/effuse-app/controllers/home/openChatPaneController.ts`)
3. Desktop execution boundary:
   - Spark wallet payer (main process) + L402 executor loop (renderer) in `apps/desktop`
   - persistent credential cache + bounded payload previews + executor presence heartbeat
4. Deterministic verification coverage:
   - Desktop deterministic integration test: `apps/desktop/tests/l402ExternalFlowDeterministic.integration.test.ts`
   - Lightning-effect unit/integration tests: `packages/lightning-effect/test/*`
5. Episode legibility:
   - Storybook coverage for the Lightning UI states: `apps/web/src/storybook/stories/lightning.ts`

EP212 issue tracking:

1. Epic: #1616 (closed)
2. Phases: #1617–#1624 (all closed)

### 11.2 What’s still needed (episode readiness / ops)

The remaining work to complete `docs/plans/active/lightning/212-demo-plan.md` is mostly **operational**, not missing core code:

1. Pick and lock demo endpoints:
   - Endpoint A: priced under the cap and stable.
   - Endpoint B: reliably blocks pre-payment (either over-cap or disallowed host).
2. Configure endpoints in the deployed `apps/web` Worker env:
   - `OA_EP212_ENDPOINT_A_URL`
   - `OA_EP212_ENDPOINT_B_URL`
3. Ensure desktop Spark wallet matches endpoint network and is funded:
   - Set `OA_DESKTOP_SPARK_NETWORK` correctly (mainnet vs testnet).
   - Provide Breez/Spark API key (`OA_DESKTOP_SPARK_API_KEY` / `OA_DESKTOP_BREEZ_API_KEY`).
   - Fund the wallet with enough sats for the demo + retries.
4. Rehearsal checklist (recommended):
   - Start desktop app, sign in, confirm executor presence is fresh (approval preflight passes).
   - Run Endpoint A: approval prompt -> approve -> completes with payload preview + proof ref.
   - Repeat Endpoint A: cache hit, no new payment.
   - Run Endpoint B: blocked pre-payment with a clear, stable reason code.
   - Confirm panes show attempts + payment detail, and chat can summarize the premium payload.
5. Optional (visual): add/update baseline screenshots for new storybook stories under `apps/web/tests/visual/storybook/`.

### 11.3 GitHub issue context (as of 2026-02-12)

1. `gh issue list --state open` currently returns **no open issues** in `OpenAgentsInc/openagents`.
2. If you want to track the remaining EP212 ops work, open a new issue capturing:
   - endpoint selection + env wiring,
   - rehearsal runbook,
   - and funding/network checklist for Spark.

---

## 12) Operator checklist: what you need to do now (single reference)

**This section is the single place for current operator instructions.** Other docs (Aperture runbook, staging runbook, 212-demo-plan) reference or summarize this.

### 12.1 L402 gateway (hosted Aperture)

- **Canonical URL:** `https://l402.openagents.com` (Cloud Run service `l402-aperture`, us-central1). Custom domain is live; DNS: CNAME `l402` → `ghs.googlehosted.com`.
- **Staging route:** `https://l402.openagents.com/staging` returns 402 and supports the full L402 flow. Used by lightning-ops staging reconcile.
- **EP212 demo routes:** `https://l402.openagents.com/ep212/premium-signal` (`price: 70`) and `https://l402.openagents.com/ep212/expensive-signal` (`price: 250`).
- **Fallback URL:** `https://l402-aperture-157437760789.us-central1.run.app` (use only if the custom domain is unavailable).
- **Full runbook:** `docs/lightning/runbooks/L402_APERTURE_DEPLOY_RUNBOOK.md` (architecture, secrets, deploy, troubleshooting).

### 12.2 Run staging reconcile (lightning-ops)

You only need to set two environment variables; gateway URLs default to `https://l402.openagents.com` and `/staging`.

1. From your machine or CI:
   ```bash
   cd apps/lightning-ops
   export OA_LIGHTNING_OPS_KHALA_URL="https://<your-deployment>.khala.cloud"
   export OA_LIGHTNING_OPS_SECRET="<your-ops-secret>"
   ./scripts/staging-reconcile.sh
   ```
2. Optional: copy `apps/lightning-ops/env.staging.example` to `.env.staging`, set the two vars above, then:
   ```bash
   cd apps/lightning-ops && source .env.staging && ./scripts/staging-reconcile.sh
   ```
3. Expected output includes `challengeOk`, `proxyOk`, `configHash`, `deploymentStatus`.

### 12.3 CI

In whatever runs staging reconcile (e.g. GitHub Actions), set only:

- `OA_LIGHTNING_OPS_KHALA_URL`
- `OA_LIGHTNING_OPS_SECRET`

Gateway URLs are defaulted in `staging-reconcile.sh` and in the smoke program (`apps/lightning-ops/src/programs/smokeStaging.ts`).

### 12.4 Product / EP212

- Any app or Khala config that calls the L402 gateway should use **`https://l402.openagents.com`** (and the path you use, e.g. `/staging`). No repo env vars needed for that; configure in your product/Khala deployment.
- EP212 demo: use `l402.openagents.com` for the OpenAgents-hosted L402 endpoint; see §11.2 for endpoint env (`OA_EP212_ENDPOINT_*`), Spark network, and rehearsal checklist.

### 12.4.1 EP212 route smoke verification

Run this after route/config deploy for route-level rehearsal checks:

```bash
cd apps/lightning-ops
OA_LIGHTNING_WALLET_EXECUTOR_BASE_URL="https://<wallet-executor-host>" \
OA_LIGHTNING_WALLET_EXECUTOR_AUTH_TOKEN="<optional-bearer>" \
npm run smoke:ep212-routes -- --json --mode live
```

Expected: route A challenge + paid success, route B challenge + over-cap policy block without payment.

### 12.4.2 EP212 full buyer-flow smoke verification

Deterministic local/CI harness:

```bash
cd apps/lightning-ops
npm run smoke:ep212-full-flow -- --json --mode mock
```

Production dry run (real sats4ai + `l402.openagents.com` routes):

```bash
cd apps/lightning-ops
OA_LIGHTNING_WALLET_EXECUTOR_BASE_URL="https://<wallet-executor-host>" \
OA_LIGHTNING_WALLET_EXECUTOR_AUTH_TOKEN="<optional-bearer>" \
OA_LIGHTNING_OPS_EP212_SATS4AI_URL="https://sats4ai.com/api/l402/text-generation" \
OA_LIGHTNING_OPS_EP212_ROUTE_A_URL="https://l402.openagents.com/ep212/premium-signal" \
OA_LIGHTNING_OPS_EP212_ROUTE_B_URL="https://l402.openagents.com/ep212/expensive-signal" \
npm run smoke:ep212-full-flow -- --json --mode live
```

See `docs/lightning/runbooks/EP212_L402_BUYER_REHEARSAL_RUNBOOK.md` for the full checklist.

### 12.5 Changing Aperture routes or config

1. Edit the template: `docs/lightning/scripts/aperture-voltage-config-postgres.yaml` (add or change entries under `services:`).
2. Build config with live DB password and add a new secret version (see Aperture runbook §6.1):
   ```bash
   APERTURE_DB_PASS=$(gcloud secrets versions access latest --secret=l402-aperture-db-password --project=openagentsgemini)
   { sed -n '1,20p' docs/lightning/scripts/aperture-voltage-config-postgres.yaml; printf '  password: "%s"\n' "$APERTURE_DB_PASS"; sed -n '22,$p' docs/lightning/scripts/aperture-voltage-config-postgres.yaml; } > /tmp/config.yaml
   gcloud secrets versions add l402-aperture-config --data-file=/tmp/config.yaml --project=openagentsgemini
   rm /tmp/config.yaml
   ```
3. Redeploy Cloud Run so the new revision picks up the latest config (see Aperture runbook §7 for the full `gcloud run deploy` command).
