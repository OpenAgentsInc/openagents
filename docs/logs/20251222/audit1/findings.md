# Findings

## High
- H-1 Issue creation for metrics-driven improvements bypasses the issues API, omits the required issues.id column, and also manually increments issue_counter even though a trigger already keeps it in sync; this can fail inserts or skip issue numbers. Evidence: `crates/autopilot/src/auto_issues.rs:412`, `crates/autopilot/src/auto_issues.rs:434`, `crates/autopilot/src/auto_issues.rs:449`, `crates/issues/src/db.rs:110`, `crates/issues/src/db.rs:224`. Recommendation: call `issues::issue::create_issue` (or `db::next_issue_number` + UUID) and remove the manual counter update.
- H-2 Log cleanup protection is ineffective: it expects JSON in sessions.issues_completed, but the schema stores it as an integer, and protection relies on session IDs in filenames while filenames are HHMMSS-slug; this makes protected_sessions empty and can delete logs tied to open issues. Evidence: `crates/autopilot/src/logs.rs:219`, `crates/autopilot/src/logs.rs:242`, `crates/issues/src/db.rs:262`, `crates/issues/src/db.rs:274`, `crates/autopilot/src/timestamp.rs:23`. Recommendation: store session_id in log filenames or add a log index table, and change the query to match the actual schema.
- H-3 Memory cleanup kills any "node" process above a threshold, not just processes spawned by autopilot/claude; this can terminate unrelated user workloads. Evidence: `crates/autopilot/src/main.rs:51`, `crates/autopilot/src/main.rs:99`, `crates/autopilot/src/daemon/memory.rs:95`. Recommendation: track and only kill child PIDs, or gate this behavior behind explicit opt-in and more precise process identification.

## Medium
- M-1 Metrics DB reads unwrap on parsing timestamps, status enums, and anomaly severities; unexpected/corrupt DB contents will panic and crash metrics commands. Evidence: `crates/autopilot/src/metrics/mod.rs:496`, `crates/autopilot/src/metrics/mod.rs:551`, `crates/autopilot/src/metrics/mod.rs:563`, `crates/autopilot/src/metrics/mod.rs:593`, `crates/autopilot/src/metrics/mod.rs:632`, `crates/autopilot/src/metrics/mod.rs:672`. Recommendation: map parse failures into Result with context and surface errors rather than panicking.
- M-2 Baseline calculations sort with partial_cmp().unwrap(); NaN values will panic. Evidence: `crates/autopilot/src/metrics/baseline.rs:157`. Recommendation: filter NaN values or use a total ordering with a safe fallback.
- M-3 Dashboard API loads all sessions into memory and sorts in-process, and uses partial_cmp().unwrap() on floats; this can block Actix workers and panic if values are NaN. Evidence: `crates/autopilot/src/dashboard.rs:1157`, `crates/autopilot/src/dashboard.rs:1169`. Recommendation: push filtering/sorting into SQL and use web::block or a dedicated pool for rusqlite.
- M-4 Trajectory streaming silently ignores JSONL and rlog update errors, risking silent log loss. Evidence: `crates/autopilot/src/lib.rs:121`, `crates/autopilot/src/lib.rs:176`, `crates/autopilot/src/lib.rs:205`. Recommendation: log failures and set session status to reflect I/O errors, or propagate up to callers.
- M-5 Autopilot state tests assume a mock publish flow, but the implementation requires an identity and returns an error when missing, so tests are inconsistent with behavior. Evidence: `crates/autopilot/src/state.rs:128`, `crates/autopilot/src/state.rs:376`. Recommendation: update tests to use `StateManager::with_identity` or adjust implementation if mock behavior is intended.
- M-6 Guardrails for read-before-edit are defined but not enforced in runtime hooks, which weakens safety guarantees. Evidence: `crates/autopilot/src/guardrails.rs:1`. Recommendation: integrate guardrails into tool hooks or remove the module to avoid false assumptions.

## Low
- L-1 Log archiving reads entire files into memory before compression; large logs can spike memory usage. Evidence: `crates/autopilot/src/logs.rs:133`. Recommendation: stream compression with a reader->encoder pipeline.
- L-2 APM CLI output is placeholder data (TODO), which can mislead users who expect real metrics. Evidence: `crates/autopilot/src/main.rs:4862`. Recommendation: wire to metrics DB or explicitly label as placeholder output.
- L-3 Claude CLI transport uses hard-coded "zsh" to fetch PATH, which is not portable to systems without zsh. Evidence: `crates/claude-agent-sdk/src/transport/process.rs:33`. Recommendation: use $SHELL or platform-specific discovery with graceful fallback.
- L-4 Issue timestamp parsing defaults to Utc::now on parse failures, masking data corruption in the issues DB. Evidence: `crates/issues/src/issue.rs:137`, `crates/issues/src/issue.rs:140`. Recommendation: return a parse error and surface it to callers.
- L-5 Blocking sleeps are used in daemon control paths, which can stall async tasks. Evidence: `crates/autopilot/src/daemon/supervisor.rs:340`, `crates/autopilot/src/daemon/supervisor.rs:414`. Recommendation: use tokio::time::sleep or spawn blocking where appropriate.
