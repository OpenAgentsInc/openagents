# GTM Implementation Plan

Complete the Autopilot GTM vision from `/Users/christopherdavid/code/backroom/live/GTM.md`.

## Summary

Three workstreams to enable the viral loop:

1. **Fix Event Schema Mismatches** - HUD won't display data correctly without this
2. **Live Fishbowl Landing** - Homepage showing real autopilot session
3. **Share UX + Start Form** - Enable the viral loop mechanics

---

## Workstream 1: Fix Event Schema Mismatches (BLOCKING)

The verification analysis found critical bugs that will break the HUD display.

### File: `crates/web/client/src/hud.rs`

**Fix 1: Usage cost field name** (line ~297)
```rust
// Current: obj.get("cost_usd")
// Fix: Add fallback for container's field name
cost_usd: obj.get("cost_usd")
    .or_else(|| obj.get("total_cost_usd"))
    .and_then(|v| v.as_f64()),
```

**Fix 2: Tool done success semantics** (line ~262)
```rust
// Current: obj.get("success")
// Fix: Handle container's is_error field (inverted semantics)
success: obj.get("success").and_then(|v| v.as_bool())
    .or_else(|| obj.get("is_error").and_then(|v| v.as_bool()).map(|e| !e)),
```

**Fix 3: Add missing event handlers** (in `parse_hud_event` match)
```rust
"status" => Some(HudEvent::SessionStart {
    session_id: obj.get("task_id").and_then(|v| v.as_str()).map(String::from),
}),
"done" => Some(HudEvent::SessionEnd { success: Some(true) }),
```

### File: `crates/web/worker/src/routes/container.rs`

**Fix 4: Use relative ws_url** (line ~114)
```rust
// Current: format!("wss://openagents.com/api/container/ws/{}", ...)
// Fix: Use relative path like HUD routes do
let ws_url = format!("/api/container/ws/{}", session.session_id);
```

### Workstream 1 Log

- Updated HUD event parsing to handle `total_cost_usd`, `is_error`, plus `status`/`done` container events.
- Switched container websocket URL to a relative `/api/container/ws/{session_id}` path.

---

## Workstream 2: Live Fishbowl Landing

### Step 2.1: Configure env vars

**File: `crates/web/wrangler.toml`**

Set initial values (can be static for launch, dynamic later):
```toml
LIVE_HUD_REPO = "openagents/openagents"
LIVE_HUD_STREAM_URL = ""  # Set to active session's stream
LIVE_HUD_STATUS = "live"
LIVE_HUD_ISSUE_URL = "https://github.com/openagents/openagents/issues/XXX"
LIVE_HUD_ISSUE_TITLE = "Current issue title"
```

### Workstream 2.1 Log

- Set LIVE_HUD_REPO to `openagents/openagents` in `wrangler.toml`.
- Live HUD now ignores empty env vars and stays disabled until a real stream or agent id is configured.

### Step 2.2: Dynamic live session (optional enhancement)

**File: `crates/web/worker/src/routes/hud.rs`**

Modify `live_hud()` to query KV for active OpenAgents session instead of static env vars:
```rust
// Check KV for: live_hud:active -> { stream_url, issue_url, issue_title }
// Fall back to env vars if no active session
```

**File: `crates/autopilot-container/src/main.rs`** (or daemon)

When OpenAgents autopilot starts a new issue:
- Write session info to KV: `live_hud:active`
- Include: stream_url, issue_url, issue_title, started_at

### Workstream 2.2 Log

- Live HUD now reads `live_hud:active` from KV and falls back to env when missing.
- HUD start writes a KV record for the live repo with ws/session info and timestamps.

---

## Workstream 3: Share UX + Start Form

### Step 3.1: Add Share Panel to HUD

**File: `crates/web/client/src/hud.rs`**

Add to `HudUi` struct:
```rust
pub(crate) share_panel_open: bool,
pub(crate) share_url_copied: bool,
pub(crate) embed_code_copied: bool,
```

Add to `HudLayout`:
```rust
pub(crate) share_button_bounds: Bounds,
pub(crate) share_panel_bounds: Bounds,
pub(crate) copy_url_bounds: Bounds,
pub(crate) copy_embed_bounds: Bounds,
```

Add `draw_share_panel()` function:
- Shows HUD URL: `openagents.com/hud/@{username}/{repo}`
- "Copy URL" button
- Embed code: `<iframe src="openagents.com/embed/@{username}/{repo}">`
- "Copy Embed" button
- Feedback: "Copied!" toast

Add share button (icon) to status bar, visible when `is_owner && is_public`.

### Workstream 3.1 Log

- Added share button + panel with HUD URL and embed code, plus copy actions and "Copied!" feedback.
- Wired share actions into HUD input handling and clipboard copy helpers.

### Step 3.2: Add Start Form UI

**File: `crates/web/client/src/hud.rs`**

Add to `HudUi`:
```rust
pub(crate) start_prompt: String,
pub(crate) start_prompt_focused: bool,
pub(crate) start_prompt_cursor: usize,
```

Add `draw_start_form()`:
- Textarea with prompt (pre-filled with DEFAULT_AUTOPILOT_PROMPT)
- "Start Autopilot" button
- Only shown when `is_owner && status == "idle"`

**File: `crates/web/client/src/app.rs`**

Add handlers:
- Click on textarea: focus, set cursor position
- Keyboard input: character insertion, backspace, arrows
- Click "Start Autopilot": POST to `/api/hud/start`, then connect stream

### Workstream 3.2 Log

- Added a HUD start panel with a prompt input + Start Autopilot button gated on owner + idle status.
- Wired HUD input events and start action to call `/api/hud/start` with the prompt and reconnect the stream.

### Step 3.3: Show "Your HUD URL" after repo selection

**File: `crates/web/client/src/lib.rs`** (or `app.rs`)

After successful repo selection + session start:
1. Navigate to HUD view
2. Auto-open share panel
3. Show confirmation: "Your Autopilot is live! Share this URL:"

### Workstream 3.3 Log

- Auto-open share panel after repo selection + session start and show the "Your Autopilot is live!" confirmation banner.

---

## Workstream 4: Funnel Instrumentation (Optional)

**File: `crates/web/worker/src/lib.rs`** or new `routes/analytics.rs`

Track events to D1 or external analytics:
- `landing_view` - Page load on `/`
- `github_connect_click` - CTA button click
- `repo_selected` - Repo chosen
- `hud_share` - Share URL copied
- `hud_embed` - Embed code copied

Simple D1 table:
```sql
CREATE TABLE funnel_events (
  id INTEGER PRIMARY KEY,
  event TEXT,
  user_id TEXT,
  repo TEXT,
  created_at INTEGER
);
```

### Workstream 4 Log

- Added `/api/analytics/event` to persist funnel events into D1 with a new `funnel_events` table.
- Wired client events for landing view, GitHub connect, repo selection, and share/embed copies.

---

## Files to Modify

| File | Changes |
|------|---------|
| `crates/web/client/src/hud.rs` | Fix event parsing, add share panel, add start form |
| `crates/web/client/src/app.rs` | Add click/keyboard handlers for form and share panel |
| `crates/web/worker/src/routes/container.rs` | Fix ws_url to relative path |
| `crates/web/worker/src/routes/hud.rs` | (Optional) Dynamic live session from KV |
| `crates/web/wrangler.toml` | Set LIVE_HUD_* env vars |

---

## Execution Order

1. **Workstream 1** (30 min) - Fix schema mismatches first, otherwise nothing displays
2. **Workstream 3.2** (45 min) - Start form so owners can launch sessions
3. **Workstream 3.1** (30 min) - Share panel for viral loop
4. **Workstream 2.1** (5 min) - Configure live fishbowl env vars
5. **Workstream 3.3** (15 min) - "Your HUD URL" confirmation
6. **Workstream 2.2** (optional) - Dynamic live session
7. **Workstream 4** (optional) - Funnel instrumentation

---

## Success Criteria

Per GTM.md metrics:
- [x] Landing shows live HUD with issue banner (implemented; verify in prod)
- [x] GitHub connect → repo select → HUD live in <30 seconds (implemented; verify in prod)
- [x] Users see their shareable HUD URL (implemented)
- [x] Copy URL / Copy Embed buttons work (implemented)
- [x] Start form accepts custom prompts (implemented)
- [x] Events render correctly in HUD (chunks, tools, usage) (implemented)

### Success Criteria Log

- Marked success criteria as implemented with a note to verify in prod.
