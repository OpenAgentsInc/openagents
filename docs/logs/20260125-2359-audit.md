# Codebase Audit (2026-01-25 23:59)

## Summary

Static scan of the OpenAgents repo for duplication, code smells, and
maintenance risks. The biggest hotspots are duplicated DVM provider
implementations, repeated FileHandle buffering patterns, and several
places where sync code blocks on async work. There are also multiple
production TODOs, unsafe blocks, and large monolithic files that make
review/testing harder.

## Scope and method

- Grep-based scan for duplicated helpers, TODOs, unwrap/expect usage,
  unsafe blocks, and blocking async patterns.
- Spot review of top duplication areas and large files.
- No runtime tests executed; findings are static and may require deeper
  semantic review.

## Findings

### Duplication hotspots

- DVM provider logic is duplicated across compute and container
  providers (similar lifecycle structs, quote handling, bid math, and
  event signing):
  - `crates/runtime/src/compute/providers/dvm.rs`
  - `crates/runtime/src/containers/providers/dvm.rs`
- FileHandle buffering + response streaming pattern repeated in
  compute/container/wallet services:
  - `crates/runtime/src/compute/service.rs`
  - `crates/runtime/src/containers/service.rs`
  - `crates/runtime/src/services/wallet.rs`
- Filename sanitization duplicated with different rules:
  - `crates/onyx/src/vault.rs`
  - `crates/autopilot-desktop-backend/src/agent/adjutant/plan_mode_signatures.rs`
- LM configuration and client setup duplicated in Autopilot desktop:
  - `crates/autopilot-desktop-backend/src/agent/adjutant/planning.rs`
  - `crates/autopilot-desktop-backend/src/agent/adjutant/lm_client.rs`
- Multiple backoff/retry helpers exist with overlapping roles, risking
  configuration drift:
  - `crates/issues/src/retry.rs`
  - `crates/nostr/client/src/recovery.rs`

### Code smells and risk areas

- Blocking inside async contexts:
  - `crates/autopilot-core/src/agent.rs` uses
    `block_in_place` + `Handle::current().block_on(...)`.
  - `crates/runtime/src/services/hud.rs`,
    `crates/runtime/src/services/goals.rs`, and
    `crates/runtime/src/containers/openagents.rs` use
    `futures::executor::block_on(...)`.
  - `crates/runtime/src/compute/providers/dvm.rs` and
    `crates/runtime/src/containers/providers/dvm.rs` use
    executor `block_on(...)` for network operations.
- Panic potential from `unwrap`/`expect` in production paths:
  - `crates/runtime/src/services/wallet.rs`
  - `crates/runtime/src/compute/service.rs`
  - `crates/runtime/src/containers/service.rs`
  - `crates/runtime/src/services/identity.rs`
  - `crates/runtime/src/compute/providers/dvm.rs`
  - `crates/runtime/src/containers/providers/dvm.rs`
- TODOs in production for incomplete or security-relevant work:
  - `crates/autopilot-core/src/pylon_integration.rs` (NIP-89 discovery)
  - `crates/dsrs/src/predictors/refine.rs` (fallback LM execution)
  - `crates/agent/src/spawner.rs` (encrypt mnemonic)
  - `crates/dsrs/src/evaluate/metrics/truth.rs` (AST/LLM comparison)
  - `crates/pylon/src/cli/doctor.rs` and `crates/pylon/src/provider.rs`
    (connectivity tests)
  - `crates/adjutant/src/autopilot_loop.rs` (background optimization)
- Unsafe blocks in core/runtime code:
  - `crates/pylon/src/daemon/process.rs` (fork)
  - `crates/autopilot/src/app_entry/settings.rs` (env manipulation)
  - `crates/dsrs-macros/src/optim.rs` (unsafe pointer access)
  - `crates/wgpui/src/bleeps.rs` (Send/Sync)
- Direct `println!/eprintln!` in library code (no structured logging):
  - `crates/autopilot-desktop-backend/src/agent/adjutant/planning.rs`
  - `crates/dsrs/src/optimizer/mipro.rs`
  - `crates/dsrs/src/optimizer/gepa.rs`
- Large monolithic files that are difficult to test and review:
  - `crates/autopilot/src/app_entry/coder_actions.rs` (~4900 lines)
  - `crates/autopilot-core/src/startup.rs` (~2800 lines)
  - `crates/autopilot/src/app/workspaces.rs` (~2700 lines)
  - `crates/adjutant/src/app_server_executor.rs` (~2100 lines)

### Other observations

- Some modules note that blocking should be removed "in a real async
  runtime," which suggests architectural drift and deferred refactors.
- Divergent LM config paths can lead to mismatched defaults or
  different env var precedence between plan mode and other DSPy paths.

## Recommendations / next steps

- Factor shared DVM provider core (bid calculation, signing, lifecycle,
  quote management) into a common module.
- Add a shared buffered FileHandle helper for compute/container/wallet
  services to remove duplicated read/seek/flush logic.
- Consolidate filename sanitization in a small shared utility crate.
- Centralize Autopilot desktop LM configuration and client creation.
- Reduce blocking in async contexts by refactoring to async APIs or
  dedicated blocking threads with clear boundaries.
- Replace `unwrap/expect` in production paths with error propagation
  and explicit invariants.
- Convert library `println!/eprintln!` to structured logging.
- Split large modules into submodules with focused tests.

## Update

- Implemented shared DVM core helpers and types in `crates/runtime/src/dvm.rs`.
- Updated compute/container DVM providers to use shared lifecycle/quote
  structs plus centralized bid calculation and event signing.
- Added a shared buffered request/response handle helper in `crates/runtime/src/fs.rs`
  and migrated compute/container/wallet request handles to use it.
- Added `crates/openagents-utils` with shared filename sanitization helpers,
  and updated Onyx + Autopilot desktop plan mode to use it.
- Centralized Autopilot desktop AI Gateway LM configuration in
  `crates/autopilot-desktop-backend/src/agent/adjutant/lm_config.rs` and
  reused it in plan mode + local LM client creation.
