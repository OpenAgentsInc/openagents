# Trajectory Persistence Implementation

**Date:** 2025-12-08
**Time:** 16:00 CT
**Task:** Implement SQLite persistence for test generation trajectories

## Overview

Implemented comprehensive SQLite database persistence for all test generation trajectories. Previously, trajectories were only stored in memory during generation and emitted via HUD messages, with no persistent storage. Now every test generation session is automatically saved to SQLite with full metadata, tests, reflections, and environment context.

## Problem Statement

The user discovered that:
1. No `trajectories` table existed in the SQLite database
2. Test generation trajectories were not being persisted anywhere
3. The schema documentation showed a planned `trajectories` table design, but it was never implemented

**User Request:** "We need to be persisting every single trajectory that gets generated by this."

## Solution Architecture

### 1. Database Schema Migration

Created `.openagents/migrations/004_trajectories.sql` with:

**Generic `trajectories` table:**
- Stores all trajectory types (ATIF, testgen, hillclimber, etc.)
- Fields: `session_id`, `schema_version`, `agent_name`, `model_name`, `step_count`, `trajectory` (JSON), `embedding` (BLOB), timestamps
- Full-text search via `trajectories_fts` virtual table
- Indexes for efficient querying by agent, model, date, cost

**Specialized `testgen_trajectories` table:**
- Extends `trajectories` with test-generation-specific fields
- Fields: `task_id`, `task_description`, `total_tests`, `total_rounds`, `category_rounds`, `comprehensiveness_score`, `tests` (JSON), `reflections` (JSON), `environment` (JSON), `uncertainties` (JSON)
- Foreign key to `trajectories` for referential integrity
- Indexes for task-based queries and score-based filtering

### 2. Database Service Updates

**File:** `src/storage/database.ts`

**Changes:**
- Added `insertTestGenTrajectory` method to `DatabaseService` interface
- Implemented dual-table insert:
  1. Insert into `trajectories` with full trajectory JSON
  2. Insert into `testgen_trajectories` with extracted fields for querying
- Updated `migrate()` function to run migrations from `.openagents/migrations/` directory
- Added `BunContext` dependency for file system operations in migrations

**Key Implementation Details:**
```typescript
const insertTestGenTrajectory = (data: {
  sessionId: string;
  taskId: string;
  taskDescription: string;
  totalTests: number;
  totalRounds: number;
  categoryRounds: Record<string, number>;
  comprehensivenessScore: number | null;
  totalTokensUsed: number;
  durationMs: number;
  tests: unknown[];
  reflections: unknown[];
  environment: unknown;
  uncertainties: string[];
  modelName?: string;
}): Effect.Effect<void, DatabaseError>
```

### 3. Test Generation Service Updates

**File:** `src/hillclimber/testgen-service.ts`

**Changes:**
- Added trajectory data collection during generation:
  - Tracks all `TestGenTestMessage` events → `tests` array
  - Tracks all `TestGenReflectionMessage` events → `reflections` array
  - Captures `TestGenStartMessage` for environment context
  - Captures `TestGenCompleteMessage` for final stats
- Added database persistence on completion:
  - Saves trajectory when `onComplete` callback fires
  - Includes all collected data: tests, reflections, environment, uncertainties
  - Calculates duration from start time
  - Includes model name (Claude vs local FM)
- Error handling: Database save failures are logged but don't interrupt the generation flow

**Data Flow:**
1. Generation starts → `startMessage` captured
2. Tests stream in → added to `tests` array
3. Reflections stream in → added to `reflections` array
4. Generation completes → `completeMessage` captured
5. All data saved to SQLite via `DatabaseService.insertTestGenTrajectory()`

## Files Modified

1. **`.openagents/migrations/004_trajectories.sql`** (NEW)
   - Migration script for trajectories and testgen_trajectories tables
   - Includes indexes, FTS virtual table, and sync triggers

2. **`src/storage/database.ts`**
   - Added `insertTestGenTrajectory` method
   - Updated `migrate()` to run migration files
   - Added `BunContext` import for file system operations

3. **`src/hillclimber/testgen-service.ts`**
   - Added trajectory data collection
   - Added database persistence on completion
   - Added `DatabaseService` and `DatabaseLive` imports

## Database Schema

### Trajectories Table
```sql
CREATE TABLE trajectories (
  session_id TEXT PRIMARY KEY,
  schema_version TEXT NOT NULL,
  agent_name TEXT NOT NULL,
  agent_version TEXT,
  model_name TEXT,
  step_count INTEGER NOT NULL DEFAULT 0,
  first_step_at TEXT,
  last_step_at TEXT,
  total_cost_usd REAL DEFAULT 0,
  total_tokens INTEGER DEFAULT 0,
  trajectory JSON NOT NULL,
  embedding BLOB,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  indexed_at TEXT
);
```

### TestGen Trajectories Table
```sql
CREATE TABLE testgen_trajectories (
  session_id TEXT PRIMARY KEY REFERENCES trajectories(session_id),
  task_id TEXT NOT NULL,
  task_description TEXT NOT NULL,
  total_tests INTEGER NOT NULL,
  total_rounds INTEGER NOT NULL,
  category_rounds JSON,
  comprehensiveness_score REAL,
  total_tokens_used INTEGER NOT NULL,
  duration_ms INTEGER NOT NULL,
  tests JSON NOT NULL,
  reflections JSON,
  environment JSON,
  uncertainties JSON,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
);
```

## Persisted Data

Each test generation session now saves:

**Metadata:**
- `sessionId` - Unique session identifier
- `taskId` - Terminal Bench task ID
- `taskDescription` - Full task description
- `modelName` - Model used (Claude or local FM)
- `durationMs` - Total generation time
- `created_at` - Timestamp

**Generation Stats:**
- `totalTests` - Number of tests generated
- `totalRounds` - Total refinement rounds
- `categoryRounds` - Rounds per category (anti_cheat, existence, correctness, etc.)
- `comprehensivenessScore` - LLM-assessed score (1-10)
- `totalTokensUsed` - Token consumption

**Generated Content:**
- `tests` - Full array of all generated tests (with category, input, output, reasoning, confidence)
- `reflections` - All gap analysis/reflection messages
- `environment` - Environment context (platform, prohibited tools, languages, files)
- `uncertainties` - List of identified uncertainties

## Migration System

**Automatic Migration:**
- Migrations run automatically on database startup
- `migrate()` function checks for `_schema_version` table
- If missing, runs `INITIAL_SCHEMA_SQL`
- Then runs all pending migrations from `.openagents/migrations/`
- Uses `runMigrations()` from `src/storage/migrations.ts`

**Migration Files:**
- `001_initial_schema.sql` - Tasks table
- `002_inferences.sql` - Inference tracking
- `003_hillclimber.sql` - HillClimber optimization tables
- `004_trajectories.sql` - Trajectories and testgen_trajectories (NEW)

## Benefits

1. **Complete History:** Every test generation session is now permanently stored
2. **Queryable:** SQL queries can find trajectories by task, date, model, score, etc.
3. **Searchable:** Full-text search on trajectory content
4. **Analyzable:** Can compute statistics, trends, and patterns across sessions
5. **Debuggable:** Can review past generations to understand failures or successes
6. **Extensible:** Schema supports future trajectory types (ATIF, HillClimber, etc.)

## Testing

**Manual Testing:**
- Run test generation via UI
- Verify trajectory appears in database:
  ```sql
  SELECT * FROM trajectories WHERE agent_name = 'testgen';
  SELECT * FROM testgen_trajectories;
  ```
- Verify data integrity (tests, reflections, environment all present)

**Error Handling:**
- Database save failures are caught and logged
- Generation continues even if persistence fails
- No user-facing errors from persistence layer

## Future Enhancements

1. **Query Interface:** Add UI to browse/search past trajectories
2. **Analytics:** Dashboard showing generation trends, success rates, token usage
3. **Comparison:** Compare trajectories across different models/configurations
4. **Export:** Export trajectories to JSON/CSV for external analysis
5. **Vector Search:** Add embedding-based semantic search for similar trajectories
6. **ATIF Integration:** Extend to persist ATIF trajectories from orchestrator

## Related Documentation

- `docs/database/SCHEMA.md` - Database schema documentation (includes trajectories table design)
- `src/storage/migrations.ts` - Migration system implementation
- `src/hillclimber/test-generator-iterative.ts` - Test generation logic
- `src/hud/protocol.ts` - HUD message types for test generation

## Notes

- Migration runs automatically on first database access
- Existing databases will be upgraded when migrations run
- No data loss - migrations are additive only
- Full-text search triggers update automatically on insert/update/delete
- Foreign key constraints ensure referential integrity between tables

---

**Status:** ✅ Complete
**All trajectories are now persisted to SQLite automatically**
