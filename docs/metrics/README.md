# Autopilot Metrics Reports

This directory contains automated weekly metrics reports generated by the autopilot system.

## Directory Structure

```
docs/metrics/
â”œâ”€â”€ README.md           # This file
â””â”€â”€ weekly/             # Weekly automated reports
    â”œâ”€â”€ report-YYYYMMDD-HHMMSS.txt   # Human-readable reports
    â”œâ”€â”€ report-YYYYMMDD-HHMMSS.json  # Machine-readable data
    â””â”€â”€ summary-YYYYMMDD-HHMMSS.txt  # Executive summaries
```

## Report Generation

Reports are automatically generated weekly using the `scripts/weekly-metrics-report.sh` script.

### Manual Report Generation

To generate a report manually:

```bash
# Generate report for current week
./scripts/weekly-metrics-report.sh

# Generate with custom date range
WEEK_START=2025-12-01 WEEK_END=2025-12-08 ./scripts/weekly-metrics-report.sh

# Send notification via webhook
NOTIFY_WEBHOOK=https://hooks.slack.com/... ./scripts/weekly-metrics-report.sh
```

### Automated Cron Setup

To run reports automatically every Monday at 9 AM:

```bash
# Edit crontab
crontab -e

# Add this line
0 9 * * MON cd /home/christopherdavid/code/openagents && ./scripts/weekly-metrics-report.sh
```

Or use systemd timer (preferred for Linux):

```bash
# Copy timer files
sudo cp scripts/systemd/autopilot-metrics.service /etc/systemd/system/
sudo cp scripts/systemd/autopilot-metrics.timer /etc/systemd/system/

# Enable and start timer
sudo systemctl enable autopilot-metrics.timer
sudo systemctl start autopilot-metrics.timer

# Check status
sudo systemctl status autopilot-metrics.timer
```

## Report Contents

Each weekly report includes:

### Summary Metrics

- **Sessions**: Number of autopilot runs during the period
- **Issues Completed**: Total issues resolved
- **Total Cost**: Sum of API costs in USD
- **Average APM**: Mean actions per minute across sessions
- **Tool Error Rate**: Percentage of failed tool calls

### Detailed Analysis

- Performance trends (APM, latency, throughput)
- Cost breakdown (by model, by session)
- Error analysis (by tool, by type)
- Quality metrics (completion rate, success rate)
- Anomaly detection (outliers, regressions)

### Comparisons

- Week-over-week changes
- Month-over-month trends
- Baseline comparisons

## Using Report Data

### View Text Reports

```bash
# Latest report
cat docs/metrics/weekly/report-*.txt | tail -n 500

# Specific week
cat docs/metrics/weekly/report-20251223-*.txt
```

### Query JSON Data

```bash
# Extract specific metrics using jq
jq '.sessions[] | {id, apm, cost_usd}' docs/metrics/weekly/report-*.json

# Calculate averages
jq '[.sessions[].apm] | add / length' docs/metrics/weekly/report-*.json
```

### Export for External Analysis

Reports can be imported into:

- **Spreadsheets**: CSV export via `cargo autopilot metrics export --format csv`
- **Grafana**: JSON data can be ingested via file datasource
- **Jupyter**: Pandas can load JSON directly
- **BI Tools**: Standard JSON format compatible with most tools

## Retention Policy

Reports older than 90 days are automatically deleted to save disk space. The cleanup runs as part of each report generation.

To keep reports longer:

```bash
# Set custom retention (in days)
export METRICS_RETENTION_DAYS=180
./scripts/weekly-metrics-report.sh
```

## Notifications

The script supports sending notifications to:

- **Slack**: Set `NOTIFY_WEBHOOK` to Slack webhook URL
- **Discord**: Compatible with Discord webhook format
- **Custom**: Any webhook accepting JSON POST requests

Notification payload format:

```json
{
  "text": "Weekly Autopilot Metrics Report",
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "ðŸ“Š Weekly Autopilot Report"
      }
    },
    {
      "type": "section",
      "fields": [
        {
          "type": "mrkdwn",
          "text": "*Period:*\n2025-12-16 to 2025-12-23"
        },
        {
          "type": "mrkdwn",
          "text": "*Sessions:*\n42"
        }
        // ... more fields
      ]
    }
  ]
}
```

## Troubleshooting

### No Data in Reports

If reports show zero sessions:

1. Check that `autopilot.db` exists and contains data
2. Verify date range covers period with actual runs
3. Check database path: `AUTOPILOT_DB=/path/to/db ./scripts/weekly-metrics-report.sh`

### Missing Metrics

Some metrics require specific trajectory data:

- **APM**: Requires `apm` field in sessions table (added in v0.2.0)
- **Anomalies**: Requires anomaly detection enabled
- **Tool-specific**: Requires detailed trajectory logs

### Script Errors

Enable debugging:

```bash
bash -x ./scripts/weekly-metrics-report.sh
```

Check logs:

```bash
# If run via cron
grep CRON /var/log/syslog

# If run via systemd
journalctl -u autopilot-metrics.service
```

## Related Documentation

- [d-004: Continual Constant Improvement](.openagents/directives/d-004.md)
- [Autopilot Metrics Guide](../autopilot/METRICS.md)
- [Improvement Dimensions](../autopilot/IMPROVEMENT-DIMENSIONS.md)
- [Learnings Log](../autopilot/LEARNINGS.md)

## Contributing

To improve the weekly report:

1. Modify metrics extraction in `scripts/weekly-metrics-report.sh`
2. Add new charts/visualizations to report template
3. Enhance notification format
4. Add integrations with external tools

Reports should remain:

- **Concise**: Focus on actionable insights
- **Consistent**: Same format week-to-week
- **Comprehensive**: Cover all key dimensions
- **Automated**: No manual intervention required
