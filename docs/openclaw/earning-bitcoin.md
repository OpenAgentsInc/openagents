# OpenClaw: Earn Bitcoin via OpenAgents.com (Breez/Spark)

**Goal:** OpenClaw receives its first real sats on mainnet using the Breez/Spark wallet stack **and** the new OpenAgents.com website as the public payment surface.

**Definition of done (must all be true):**
- A payment lands in the **OpenClaw wallet** (Spark/Breez, self-custodial).
- The payment is visible in **both** the OpenAgents.com wallet UI and the OpenClaw CLI/Tool logs (same mnemonic).
- OpenAgents.com has a **public “Pay OpenClaw” page** that shows a live receive coordinate generated by OpenClaw.

**Stack we will use (single path):**
- **Wallet stack:** Breez SDK (Spark) everywhere.
- **Website:** TanStack Start app in `apps/website/`, deployed on Cloudflare Workers.
- **OpenClaw integration:** a plugin tool that shells out to `openagents spark receive` and posts the invoice to the website.

**Related docs:** [bitcoin-wallets-plan.md](./bitcoin-wallets-plan.md), [codebase-tour.md](./codebase-tour.md), [autopilot-integration.md](./autopilot-integration.md), and the site KB page `apps/website/src/content/kb/openclaw-wallets.mdx`.

---

## Roadmap (step by step, no branching)

### Phase 0 — Prereqs and secrets (today)

1) **Breez API key**
   - Request and store a Breez API key.
   - Use env vars for all runtime contexts:
     - `BREEZ_API_KEY` (CLI + OpenClaw tool)
     - `VITE_BREEZ_API_KEY` (website build/runtime)

2) **OpenAgents CLI available**
   - Build the CLI:
     ```bash
     cargo build -p openagents-cli --release
     ```
   - Ensure `openagents` is on PATH or provide a configured absolute path in the OpenClaw plugin.

3) **Spark storage directory**
   - Create and standardize one storage dir for OpenClaw:
     ```bash
     mkdir -p ~/.openagents/spark-openclaw
     ```

---

### Phase 1 — Create the OpenClaw wallet identity (today)

We will create **one** mnemonic and use it everywhere (website + CLI + OpenClaw tool). This is the OpenClaw wallet identity.

1) **Generate a mnemonic (CLI)**
   ```bash
   openagents spark new --words 12 --json
   ```
2) **Store it safely**
   - Save to `~/.openclaw/spark-mnemonic.txt` (never commit, never share).
   - Export for CLI/tool usage:
     ```bash
     export SPARK_MNEMONIC="word1 word2 ... word12"
     export BREEZ_API_KEY="..."
     ```

3) **Lock the identity**
   - Treat this mnemonic as **OpenClaw’s wallet**. Do not reuse it for other agents.

---

### Phase 2 — Connect the OpenAgents.com wallet to the same identity (today)

The website wallet already uses Breez Spark in the browser (`apps/website/src/lib/wallet/walletService.ts`), so we will connect it to the same mnemonic.

1) **Ensure Breez API key for the website**
   - Set `VITE_BREEZ_API_KEY` in the local `.env` and in Cloudflare deployment secrets.

2) **Ensure cross‑origin isolation on `/wallet`**
   - Dev: headers already in `apps/website/vite.config.ts`.
   - Prod: headers already in `apps/website/public/_headers` (Cloudflare Pages/Workers).

3) **Restore the wallet on the website**
   - Run the site, open `/wallet`, choose **Restore**, and paste the mnemonic from Phase 1.
   - Confirm balance + transaction history load (even if empty).

Result: the website wallet and OpenClaw CLI now control the **same Spark wallet**.

---

### Phase 3 — Add the public “Pay OpenClaw” surface on the website (today)

We will add a dedicated page that **always** shows a live payment coordinate coming from OpenClaw.

1) **New route**
   - Create the route:
     - `apps/website/src/routes/openclaw/earn.tsx`
   - This page should:
     - Render a “Pay OpenClaw” header.
     - Display a live Lightning invoice (Bolt11) from OpenClaw.
     - Provide copy buttons and QR rendering.
     - Link to `/wallet` and `/kb/openclaw-wallets`.

2) **UI source of truth**
   - The page **must not** generate its own invoice.
   - It should fetch the current invoice from a Cloudflare Worker endpoint (see Phase 5).

3) **Documentation link**
   - Add a prominent link from `apps/website/src/content/kb/openclaw-wallets.mdx` to the new “Pay OpenClaw” page.

---

### Phase 4 — OpenClaw tool to generate invoices (today)

Add a plugin to OpenClaw that generates **Bolt11 invoices** and posts them to the website.

1) **Tool name**
   - `spark.receive_invoice`

2) **Implementation (OpenClaw repo)**
   - Shell out to the OpenAgents CLI:
     ```bash
     openagents spark receive --method bolt11 \
       --amount 1000 \
       --description "OpenClaw" \
       --storage-dir ~/.openagents/spark-openclaw \
       --network mainnet \
       --json
     ```
   - Use `SPARK_MNEMONIC` and `BREEZ_API_KEY` envs; do not place secrets in config files.

3) **Tool output**
   - Parse JSON and return:
     - `payment_request` (Bolt11)
     - `expires_at`
     - `amount_sats`
   - Persist the latest invoice locally to `~/.openclaw/receipts/openclaw-invoice.json`.

4) **Post to website**
   - After generating the invoice, call the website endpoint (Phase 5) and update the “current invoice.”

---

### Phase 5 — Website endpoint for OpenClaw invoices (today)

Create a simple Cloudflare Worker endpoint to store and serve the latest invoice.

1) **API design**
   - `POST /api/openclaw/invoice`
     - Auth: bearer token in `Authorization` header.
     - Body: `{ payment_request, amount_sats, description, expires_at, created_at }`
   - `GET /api/openclaw/invoice`
     - Returns the latest invoice payload.

2) **Storage**
   - Use Cloudflare KV (single key: `openclaw:invoice`).
   - Store a timestamp; reject expired invoices.

3) **Website integration**
   - The “Pay OpenClaw” page fetches `GET /api/openclaw/invoice` on load and polls every 30–60s.
   - If the invoice is expired, it prompts OpenClaw to generate a new one (manual trigger for now).

---

### Phase 6 — Execute the first earn (today)

1) **Generate the invoice**
   - Ask OpenClaw to call `spark.receive_invoice`.
   - Verify the invoice appears on `openagents.com/openclaw/earn`.

2) **Pay it**
   - Pay from an external wallet.

3) **Verify receipt**
   - Website wallet `/wallet` shows the incoming payment.
   - CLI confirmation:
     ```bash
     openagents spark payments list \
       --storage-dir ~/.openagents/spark-openclaw \
       --network mainnet \
       --json
     ```

4) **Record the proof**
   - Save the payment hash + timestamp in `~/.openclaw/receipts/` and reference it in a short internal note.

---

### Phase 7 — Update public OpenAgents network docs (after implementation)

These instructions live in `apps/website/public/` and are the canonical onboarding/ops docs for agents on the open network. Once the system above is implemented, we must update them so OpenClaw agents can follow a **fully automatic** flow (invoice generation → website publish → payment verification) without additional human guidance.

Update each document as follows:

1) **`SKILL.md` (entrypoint)**
   - Add a **“Earn sats with OpenClaw”** section that points to `/openclaw/earn` as the public pay page.
   - Include the required env setup for the OpenClaw wallet tool:
     - `SPARK_MNEMONIC`, `BREEZ_API_KEY`, `OPENCLAW_STATE_DIR`, and `~/.openagents/spark-openclaw` storage dir.
   - Provide a short “run once” command list to trigger invoice creation (OpenClaw tool) and verify publish to `/openclaw/earn`.
   - Reinforce **no secrets** (mnemonic/API key) in posts or profiles.

2) **`HEARTBEAT.md` (routine)**
   - Add a heartbeat step: **“Refresh OpenClaw invoice if expiring”**.
   - Define the expected cadence (e.g. every 30–60 minutes) and the check:
     - If `/openclaw/earn` shows no invoice or an expired one, call the OpenClaw invoice tool.
   - Add a second step to **verify incoming payment** (payment hash appears in CLI or tool output) and log a short receipt summary.

3) **`WALLET.md` (payments)**
   - Add a **“OpenClaw auto‑earn flow”** section describing:
     - the OpenClaw tool that generates Bolt11 invoices,
     - the website endpoint that publishes them,
     - the public pay page `/openclaw/earn`,
     - and verification via `openagents spark payments list`.
   - Align CLI examples with the current OpenAgents CLI (`openagents spark …`, not `oa`).
   - Explicitly state that the **website wallet can restore the same mnemonic** to verify receipts in the UI.

4) **`NODE.md` (local node / gateway)**
   - Add a short subsection on installing/enabling the OpenClaw wallet tool plugin.
   - Document the expected state directories and env vars used by the tool.
   - Note that the OpenClaw Gateway is the issuer of invoices; the website only displays them.

5) **`PROJECTS.md` (map)**
   - Add a new line item for **OpenClaw Earn**:
     - “Public pay page for OpenClaw at `/openclaw/earn`”
     - “Automated invoice flow tied to OpenClaw tool + Breez/Spark wallet”

6) **`NOSTR_EDUCATOR.md` (educator)**
   - Add a brief pointer for educators who choose NIP‑57 (zaps) or Lightning topics:
     - “Use the OpenClaw earn flow (`/openclaw/earn`) as the live demo.”
   - Remind educators to **avoid posting invoices or secrets** directly; link to the public pay page instead.

These updates should land **immediately after** Phase 5 is live so that any agent who reads the public docs can complete the entire earn flow without private instructions.

---

## Guardrails (non‑negotiable)

- **No custody:** mnemonic never leaves the operator device.
- **No secrets in content:** never post mnemonics or API keys to any feed.
- **Budget discipline:** invoice amounts should be small until the flow is verified end‑to‑end.
- **Single identity:** the OpenClaw mnemonic is the wallet; do not rotate without an explicit migration.

---

## Why this path

This plan ties OpenClaw’s first earned sats to a **public, stable, and auditable payment surface** (OpenAgents.com) while keeping the wallet fully non‑custodial. The website becomes the primary interface for payers; OpenClaw remains the issuer of invoices and the owner of the wallet.
