{
  "$schema": "https://openagents.com/schemas/upgrade-manifest-v1.json",
  "id": "test-generator-v1",
  "version": "1.0.0",
  "title": "Automated Test Generation",
  "description": "Generate comprehensive unit and integration tests for low-coverage areas. Runs nightly to improve test coverage across the codebase.",

  "author": {
    "name": "OpenAgents",
    "npub": "npub1openagentsexamplekey",
    "url": "https://github.com/OpenAgentsInc/openagents"
  },

  "license": "MIT",
  "categories": ["development", "testing", "quality-assurance"],
  "tags": ["overnight", "tests", "codex", "coverage"],

  "capabilities": {
    "platforms": ["macos"],
    "min_macos_version": "26.0",
    "backends": ["foundation_models"],
    "required_tools": ["git", "gh", "swift", "xcodebuild"]
  },

  "permissions": {
    "filesystem": {
      "read": ["$WORKSPACE/**"],
      "write": ["$WORKSPACE/Tests/**", "$WORKSPACE/**/Tests/**"],
      "exclude": [".env", "*.key", "credentials.json"]
    },
    "network": {
      "allowed_domains": ["github.com", "api.github.com"],
      "ports": []
    },
    "tools": {
      "allowed": ["git", "gh", "xcodebuild", "swift"],
      "denied": ["rm", "curl", "wget"]
    }
  },

  "schedule": {
    "type": "cron",
    "expression": "0 3 * * *",
    "timezone": "America/Los_Angeles",
    "window": {
      "start": "02:00",
      "end": "05:00"
    },
    "constraints": {
      "plugged_in": true,
      "wifi_only": true,
      "cpu_max_percentage": 80,
      "respect_dnd": false,
      "suspend_if_active": true
    },
    "jitter": 600,
    "on_missed": "skip"
  },

  "triggers": [],

  "pipeline": [
    {
      "op": "repo.coverage",
      "params": {
        "working_dir": "$WORKSPACE"
      },
      "output_var": "coverage"
    },
    {
      "op": "session.analyze",
      "params": {
        "providers": ["codex"],
        "topK": 10,
        "since": "30d"
      },
      "output_var": "session_insights"
    },
    {
      "op": "orchestrate.decide",
      "backend": "foundation_models",
      "params": {
        "context": {
          "coverage": "{coverage}",
          "session_insights": "{session_insights}"
        },
        "available_agents": ["codex"],
        "time_budget": 2400,
        "hint": "Generate comprehensive tests for files with less than 70% coverage. Prefer files that are frequently used but lack test coverage."
      },
      "output_var": "decision"
    },
    {
      "op": "agent.execute",
      "params": {
        "agent": "codex",
        "task": "{decision.task}",
        "working_dir": "$WORKSPACE",
        "max_duration": 2400,
        "resume_on_error": false,
        "stream_updates": true
      },
      "output_var": "session_result"
    },
    {
      "op": "test.run",
      "params": {
        "command": "xcodebuild test -workspace OpenAgents.xcworkspace -scheme OpenAgents -sdk macosx",
        "timeout": 600,
        "required": true
      },
      "output_var": "test_results"
    },
    {
      "op": "pr.create",
      "params": {
        "branch_prefix": "agent/test-gen/",
        "base_branch": "main",
        "title": "Add tests for {decision.target_file}",
        "body_template": "## Automated Test Generation\n\n**Target File**: `{decision.target_file}`\n\n**Previous Coverage**: {coverage.before}%\n\n**New Coverage**: {coverage.after}%\n\n**Tests Added**: {session_result.test_count}\n\n**All Tests**: {test_results.status}\n\n---\n\n### Test Summary\n\n{test_results.summary}\n\n---\n\n**Agent**: Codex\n\n**Session**: `{session_result.session_id}`\n\n**Duration**: {session_result.duration}\n\n---\n\n*Generated with [OpenAgents Test Generator](https://github.com/OpenAgentsInc/openagents)*\n\n*Upgrade*: `test-generator-v1`",
        "auto_push": true,
        "draft": false
      },
      "output_var": "pr_number"
    }
  ],

  "pricing": {
    "model": "free",
    "amount_sats": 0,
    "revenue_split": []
  },

  "policy": {
    "aup_compliance": true,
    "data_retention": "30d",
    "telemetry_level": "aggregate"
  },

  "signing": null
}
