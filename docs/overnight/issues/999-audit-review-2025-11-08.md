# Orchiestration Issues — Audit & Recommendations (2025-11-08)

This audit reviews 001–012 in `private/overnight/issues` against the current Swift codebase and docs. It proposes scoped adjustments to land the overnight demo quickly and align with ACP, existing orchestrators, Tinyvex, bridge patterns, and Apple constraints.

## Executive Summary

- Good direction and coverage. Several items over-spec or reference non-existent types. We can ship the overnight demo faster by leveraging existing components and trimming new surface area.
- Reuse what exists: ExploreOrchestrator, SessionTools, SessionUpdateHub, TinyvexDbLayer, DesktopWebSocketServer JSON-RPC, AgentRegistry, CLIAgentProvider implementations for Codex/Claude Code.
- For the demo, avoid building a full generic Upgrade runtime. Implement a thin “runner” that schedules Explore/Decide+Execute loops, persists via Tinyvex, and optionally opens PRs.
- Fix small repo inconsistencies (workspace vs xcodeproj) and tighten acceptance criteria and naming to match ACP, JSON-RPC conventions.

## Cross-Cutting Changes (High ROI)

- Use `SessionUpdateHub` everywhere for outbound updates instead of custom broadcast code.
  - Reference: ios/OpenAgentsCore/Sources/OpenAgentsCore/DesktopBridge/SessionUpdateHub.swift:13
- Piggyback on the orchestration entrypoint that already exists: `orchestrate.explore.start` on the desktop bridge.
  - Reference: ios/OpenAgentsCore/Sources/OpenAgentsCore/DesktopBridge/DesktopWebSocketServer+Orchestration.swift:7
- Prefer current orchestrator primitives over net-new classes:
  - Explore/plan/execute: ExploreOrchestrator, ToolExecutionOrchestrator, PlanningReducer
    - References: ios/OpenAgentsCore/Sources/OpenAgentsCore/Orchestration/ExploreOrchestrator.swift:1, ios/OpenAgentsCore/Sources/OpenAgentsCore/Orchestration/ToolExecutionOrchestrator.swift:1
  - Tools: ContentSpanTool, GrepTool, SessionList/Search/Read/Analyze
    - References: ios/OpenAgentsCore/Sources/OpenAgentsCore/Orchestration/ContentSpanTool.swift:1, ios/OpenAgentsCore/Sources/OpenAgentsCore/Orchestration/SessionTools.swift:1
- Use TinyvexDbLayer for persistence (add a new tasks table in same DB rather than a new store).
  - Reference: ios/OpenAgentsCore/Sources/OpenAgentsCore/Tinyvex/DbLayer.swift:1
- Fix README to recommend opening the workspace (matches AGENTS.md).
  - Reference: README.md:51

## Issue-by-Issue Notes

- 001-scheduler-service
  - Keep it minimal: implement a macOS-only `SchedulerService` that triggers every N minutes with optional window and jitter using `AsyncTimerSequence` or a `DispatchSourceTimer` on a dedicated queue.
  - Constraint checkers: stub battery/Wi‑Fi/CPU with best-effort and fast-return; avoid heavy polling. CPU requires deltas of `host_processor_info` snapshots; current pseudocode returns `true`. Note this explicitly and gate with a feature flag (demo vs full).
  - State persistence: store next wake and last run in the same Tinyvex DB (new table `overnight_scheduler_state`) to survive restarts.
  - Suggestion: land only `cron + window + jitter + plugged_in + wifi_only` for the demo. Defer DND/CPU/user-activity to a follow-up.
  - Remove/adjust references to non-existent types in comments (e.g., `UpgradeExecutor` can be optional for demo path).

- 002-decision-orchestrator
  - Do not create a separate FM orchestrator; reuse ExploreOrchestrator + SessionTools.
    - Use `SessionAnalyzeTool` to build features and pass into a light Decision function. Reference: ios/OpenAgentsCore/Sources/OpenAgentsCore/Orchestration/SessionTools.swift:145
  - Replace `FMOrchestrator`/`NativeFMOrchestrator()` placeholders with `ExploreOrchestrator` and its FM-backed analysis method `fmAnalysis()` where available.
    - Reference: ios/OpenAgentsCore/Sources/OpenAgentsCore/Orchestration/ExploreOrchestrator.swift:290
  - Drop `repo.status` for the demo (not implemented). If needed later, add a tiny git status helper in DesktopWebSocketServer (Terminal run) and parse.
  - Output shape `TaskDecision` is fine, but ensure `agent` maps to `ACPSessionModeId` (enum exists), not a custom `AgentType`.

- 003-task-queue
  - Use `TinyvexDbLayer` with a new `overnight_tasks` table in the same SQLite file. Keep schema as drafted.
    - Reference creation: ios/OpenAgents/TinyvexManager.swift:28 (path); ios/OpenAgentsCore/Sources/OpenAgentsCore/DesktopBridge/DesktopWebSocketServer.swift:245 (attach DB)
  - Expose a small actor `TaskQueue` that encloses SQL and emits `AsyncStream` updates (consistent with SessionUpdateHub style).
  - For the demo, don’t overbuild: enqueue decisions and mark completed/failed; skip rich filters.

- 004-agent-coordinator
  - Adjust to actual provider API. `AgentProvider.start` signature is `(sessionId, prompt, context, updateHub) -> AgentHandle`.
    - Reference: ios/OpenAgentsCore/Sources/OpenAgentsCore/Agents/AgentProvider.swift:23
  - Build `AgentContext(workingDirectory:mcpServers:client:metadata:)` and pass the bridge’s `SessionUpdateHub` instance so stream stays canonical.
  - `AgentRegistry` is an actor instance, not a `.shared`. Keep an instance (DesktopWebSocketServer has one; reuse it).
    - Reference: ios/OpenAgentsCore/Sources/OpenAgentsCore/DesktopBridge/DesktopWebSocketServer.swift:69
  - Time budgets: use a `Task` deadline and call `provider.cancel` via the stored `AgentHandle` on timeout.
  - Concurrency: a simple semaphore (count 2) around starts is enough for the demo.

- 005-pr-automation-service
  - Locating `gh`: reuse CLIAgentProvider’s `findBinary()` strategy rather than hardcoding `/opt/homebrew/bin/gh`.
    - Reference: ios/OpenAgentsCore/Sources/OpenAgentsCore/Agents/CLIAgentProvider.swift:246
  - Deriving file changes from ACP tool calls is brittle with current provider outputs. For demo: commit current working tree and construct the PR body from `SessionAnalyzeResult`/decision text.
  - Add an opt-in “demo mode” that creates a PR with a templated body even if no changes are detected (clear labeling).

- 006-upgrade-executor
- Recommend deferring a full declarative pipeline runner. Instead, create a minimal `OrchiestrationRunner` that:
    - Runs `SessionAnalyzeTool` → calls a `decide()` helper → delegates to `AgentCoordinator` → optionally calls `PRAutomationService`.
    - Reads a simple JSON config with schedule + toggles (not full schema yet).
  - If you keep the file, rename to “OvernightRunner” for now and scope operations to what we have: `session.analyze`, `grep`, `readSpan`, `agent.execute`, `pr.create`.

- 007-policy-enforcer
  - The AUP list is okay for a first pass but document it as a heuristic, not a blocker. Add a manual-approval hook on iOS when a task is flagged.
  - File permission checks: use the same path normalization strategy as `PathUtils.normalizeToWorkspaceRelative()`.
    - Reference: ios/OpenAgentsCore/Sources/OpenAgentsCore/Orchestration/PathUtils.swift:6

- 008-ios-bridge-integration
  - Good shapes. Register `orchestration/*` JSON-RPC in `DesktopWebSocketServer` using current router.
    - Reference method registration pattern: ios/OpenAgentsCore/Sources/OpenAgentsCore/DesktopBridge/DesktopWebSocketServer+Orchestration.swift:9
  - Keep snake_case for payload fields to align with ADR‑0002.
  - On iOS, wire via existing `MobileWebSocketClient` delegate and expose a lightweight `OvernightMonitoringView`.

- 009-example-upgrades
  - Great for narrative. For demo, provide one manifest (`nightly-refactor.json`) and wire the runner to read only the fields we actually implement (cron, window, basic pipeline steps).
  - Prefer `"jitter_ms"` not `"jitter"` for clarity, matching `docs/compute/issues/upgrades.md`.

- 010-e2e-testing
  - Place integration tests under `ios/OpenAgentsCore/Tests/OpenAgentsCoreTests/Integration/` as proposed.
  - Mark `gh`-dependent tests with skip guards.
  - For “compressed overnight,” consider running the runner directly instead of the full scheduler loop to keep tests fast and stable.

- 011-demo-preparation
  - Solid. Add a “demo mode” env var to annotate streamed messages and PR body as demo content.
  - Include a contingency: if FM unavailable, fall back to PlanningReducer.parse operations and a deterministic refactor/test decision.

- 012-documentation-adr
  - Yes—create ADR-0007, but mark status “Proposed” until the demo ships; then flip to “Accepted”. Follow docs/adr/AGENTS.md tone and structure.

## Missing/Conflicting References To Fix

- README workspace vs project mismatch: change “open OpenAgents.xcodeproj” to “open OpenAgents.xcworkspace”.
  - Reference: README.md:51
- Non-existent types in issues: `FMOrchestrator`, `SessionHistoryAnalyzer`, `OperationsRegistry`, `UpgradeExecutor` (as a full engine). Replace with ExploreOrchestrator/SessionTools/OvernightRunner for demo.
- `AgentRegistry.shared` usage in 004 is incorrect; use an instance and pass through.
- `repo.status`, `repo.coverage`, `repo.complexity` not implemented. Defer.
- `architecture.md` and `testing-plan.md` are referenced but don’t exist; either create stubs in `docs/` or remove references.

## Suggested Minimal Demo Path (2–3 days)

- Add a thin `OvernightRunner` (macOS only) that:
  - Schedules via `SchedulerService` (cron + window + jitter minimal constraints).
  - Each cycle: run `SessionAnalyzeTool` → simple `decide()` → `AgentCoordinator` → optionally `PRAutomationService`.
  - Streams everything through `SessionUpdateHub` so iOS can render live.
- Add iOS `OrchiestrationMonitoringView` with counts and last decisions.
- Provide one working manifest (`nightly-refactor.json`) parsed into a small config struct.
- Record the video: show 2–3 cycles → 2 PRs.

## Follow-Ups (Post-Demo)

- Expand constraints (CPU/DND/user activity) with real implementations.
- Generalize to full Upgrade manifests and operations registry.
- Add bridge `orchestration/*` notifications and approval flows end-to-end.
- Flesh out PR generation from ACP deltas rather than working-tree heuristics.
- Add Nostr marketplace events once Phase‑1 MVP issues under docs/compute land.

## File-Level Pointers (for implementers)

- Agent providers and registry
  - ios/OpenAgentsCore/Sources/OpenAgentsCore/Agents/AgentProvider.swift:1
  - ios/OpenAgentsCore/Sources/OpenAgentsCore/Agents/CLIAgentProvider.swift:1
  - ios/OpenAgentsCore/Sources/OpenAgentsCore/Agents/CodexAgentProvider.swift:1
  - ios/OpenAgentsCore/Sources/OpenAgentsCore/Agents/ClaudeCodeAgentProvider.swift:1
  - ios/OpenAgentsCore/Sources/OpenAgentsCore/Agents/AgentRegistry.swift:1
- Orchestration + tools
  - ios/OpenAgentsCore/Sources/OpenAgentsCore/Orchestration/ExploreOrchestrator.swift:1
  - ios/OpenAgentsCore/Sources/OpenAgentsCore/Orchestration/ToolExecutionOrchestrator.swift:1
  - ios/OpenAgentsCore/Sources/OpenAgentsCore/Orchestration/SessionTools.swift:1
  - ios/OpenAgentsCore/Sources/OpenAgentsCore/Orchestration/ContentSpanTool.swift:1
  - ios/OpenAgentsCore/Sources/OpenAgentsCore/Orchestration/GrepTool.swift:1
- Bridge and persistence
  - ios/OpenAgentsCore/Sources/OpenAgentsCore/DesktopBridge/DesktopWebSocketServer+Orchestration.swift:1
  - ios/OpenAgentsCore/Sources/OpenAgentsCore/DesktopBridge/SessionUpdateHub.swift:1
  - ios/OpenAgentsCore/Sources/OpenAgentsCore/Tinyvex/DbLayer.swift:1

## Small Requested Edits To Issues (quick fixes)

- Normalize field names to snake_case in JSON examples to align with ADR‑0002.
- Change hardcoded `gh` path to “discover via PATH/which”.
- Mark unimplemented features as “Post‑demo” in acceptance criteria to avoid blocking.
- Replace references to non‑existent docs with either stubs under `docs/` or remove for now.

---

If you want, I can apply the README fix, add the `999-` label to this audit file, and scaffold a minimal `OvernightRunner` + `SchedulerService` shell to start wiring the demo.
