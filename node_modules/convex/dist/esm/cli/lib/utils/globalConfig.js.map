{
  "version": 3,
  "sources": ["../../../../../src/cli/lib/utils/globalConfig.ts"],
  "sourcesContent": ["import chalk from \"chalk\";\nimport os from \"os\";\nimport path from \"path\";\nimport { rootDirectory } from \"./utils.js\";\nimport { Context } from \"../../../bundler/context.js\";\nimport { logError, logVerbose } from \"../../../bundler/log.js\";\nimport { z } from \"zod\";\n\nexport function globalConfigPath(): string {\n  return path.join(rootDirectory(), \"config.json\");\n}\n\n// GlobalConfig is stored in a file that very old versions of Convex also need to access.\n// Everything besides accessToken must be optional forever.\n// GlobalConfig is deleted on logout. It is primarily used for the accessToken.\nexport type GlobalConfig = {\n  accessToken: string;\n  // Means \"Don't use local dev unless CLI version is at least 1.19\" (actual version TBD)\n  optOutOfLocalDevDeploymentsUntilBetaOver?: boolean | undefined;\n};\n\nconst schema = z.object({\n  accessToken: z.string().min(1),\n  optOutOfLocalDevDeploymentsUntilBetaOver: z.boolean().optional(),\n});\n\nexport function readGlobalConfig(ctx: Context): GlobalConfig | null {\n  const configPath = globalConfigPath();\n  let configFile;\n  try {\n    configFile = ctx.fs.readUtf8File(configPath);\n  } catch {\n    return null;\n  }\n  try {\n    const storedConfig = JSON.parse(configFile);\n    const config: GlobalConfig = schema.parse(storedConfig);\n    return config;\n  } catch (err) {\n    // Print an error and act as if the file does not exist.\n    logError(\n      chalk.red(\n        `Failed to parse global config in ${configPath} with error ${\n          err as any\n        }.`,\n      ),\n    );\n    return null;\n  }\n}\n\n/** Write the global config, preserving existing properties we don't understand. */\nexport async function modifyGlobalConfig(ctx: Context, config: GlobalConfig) {\n  const configPath = globalConfigPath();\n  let configFile;\n  try {\n    configFile = ctx.fs.readUtf8File(configPath);\n    // totally fine for it not to exist\n    // eslint-disable-next-line no-empty\n  } catch {}\n  // storedConfig may contain properties this version of the CLI doesn't understand.\n  let storedConfig = {};\n  if (configFile) {\n    try {\n      storedConfig = JSON.parse(configFile);\n      schema.parse(storedConfig);\n    } catch (err) {\n      logError(\n        chalk.red(\n          `Failed to parse global config in ${configPath} with error ${\n            err as any\n          }.`,\n        ),\n      );\n      storedConfig = {};\n    }\n  }\n  const newConfig: GlobalConfig = { ...storedConfig, ...config };\n  await overrwriteGlobalConfig(ctx, newConfig);\n}\n\n/** Write global config, overwriting any existing settings. */\nasync function overrwriteGlobalConfig(ctx: Context, config: GlobalConfig) {\n  const dirName = rootDirectory();\n  ctx.fs.mkdir(dirName, { allowExisting: true });\n  const path = globalConfigPath();\n  try {\n    ctx.fs.writeUtf8File(path, JSON.stringify(config, null, 2));\n  } catch (err) {\n    return await ctx.crash({\n      exitCode: 1,\n      errorType: \"invalid filesystem data\",\n      errForSentry: err,\n      printedMessage: chalk.red(\n        `Failed to write auth config to ${path} with error: ${err as any}`,\n      ),\n    });\n  }\n  logVerbose(`Saved credentials to ${formatPathForPrinting(path)}`);\n}\n\nexport function formatPathForPrinting(path: string) {\n  const homedir = os.homedir();\n  if (process.platform === \"darwin\" && path.startsWith(homedir)) {\n    return path.replace(homedir, \"~\");\n  }\n  return path;\n}\n"],
  "mappings": ";AAAA,OAAO,WAAW;AAClB,OAAO,QAAQ;AACf,OAAO,UAAU;AACjB,SAAS,qBAAqB;AAE9B,SAAS,UAAU,kBAAkB;AACrC,SAAS,SAAS;AAEX,gBAAS,mBAA2B;AACzC,SAAO,KAAK,KAAK,cAAc,GAAG,aAAa;AACjD;AAWA,MAAM,SAAS,EAAE,OAAO;AAAA,EACtB,aAAa,EAAE,OAAO,EAAE,IAAI,CAAC;AAAA,EAC7B,0CAA0C,EAAE,QAAQ,EAAE,SAAS;AACjE,CAAC;AAEM,gBAAS,iBAAiB,KAAmC;AAClE,QAAM,aAAa,iBAAiB;AACpC,MAAI;AACJ,MAAI;AACF,iBAAa,IAAI,GAAG,aAAa,UAAU;AAAA,EAC7C,QAAQ;AACN,WAAO;AAAA,EACT;AACA,MAAI;AACF,UAAM,eAAe,KAAK,MAAM,UAAU;AAC1C,UAAM,SAAuB,OAAO,MAAM,YAAY;AACtD,WAAO;AAAA,EACT,SAAS,KAAK;AAEZ;AAAA,MACE,MAAM;AAAA,QACJ,oCAAoC,UAAU,eAC5C,GACF;AAAA,MACF;AAAA,IACF;AACA,WAAO;AAAA,EACT;AACF;AAGA,sBAAsB,mBAAmB,KAAc,QAAsB;AAC3E,QAAM,aAAa,iBAAiB;AACpC,MAAI;AACJ,MAAI;AACF,iBAAa,IAAI,GAAG,aAAa,UAAU;AAAA,EAG7C,QAAQ;AAAA,EAAC;AAET,MAAI,eAAe,CAAC;AACpB,MAAI,YAAY;AACd,QAAI;AACF,qBAAe,KAAK,MAAM,UAAU;AACpC,aAAO,MAAM,YAAY;AAAA,IAC3B,SAAS,KAAK;AACZ;AAAA,QACE,MAAM;AAAA,UACJ,oCAAoC,UAAU,eAC5C,GACF;AAAA,QACF;AAAA,MACF;AACA,qBAAe,CAAC;AAAA,IAClB;AAAA,EACF;AACA,QAAM,YAA0B,EAAE,GAAG,cAAc,GAAG,OAAO;AAC7D,QAAM,uBAAuB,KAAK,SAAS;AAC7C;AAGA,eAAe,uBAAuB,KAAc,QAAsB;AACxE,QAAM,UAAU,cAAc;AAC9B,MAAI,GAAG,MAAM,SAAS,EAAE,eAAe,KAAK,CAAC;AAC7C,QAAMA,QAAO,iBAAiB;AAC9B,MAAI;AACF,QAAI,GAAG,cAAcA,OAAM,KAAK,UAAU,QAAQ,MAAM,CAAC,CAAC;AAAA,EAC5D,SAAS,KAAK;AACZ,WAAO,MAAM,IAAI,MAAM;AAAA,MACrB,UAAU;AAAA,MACV,WAAW;AAAA,MACX,cAAc;AAAA,MACd,gBAAgB,MAAM;AAAA,QACpB,kCAAkCA,KAAI,gBAAgB,GAAU;AAAA,MAClE;AAAA,IACF,CAAC;AAAA,EACH;AACA,aAAW,wBAAwB,sBAAsBA,KAAI,CAAC,EAAE;AAClE;AAEO,gBAAS,sBAAsBA,OAAc;AAClD,QAAM,UAAU,GAAG,QAAQ;AAC3B,MAAI,QAAQ,aAAa,YAAYA,MAAK,WAAW,OAAO,GAAG;AAC7D,WAAOA,MAAK,QAAQ,SAAS,GAAG;AAAA,EAClC;AACA,SAAOA;AACT;",
  "names": ["path"]
}
