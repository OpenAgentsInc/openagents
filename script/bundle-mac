#!/bin/bash
set -euo pipefail

# Onyx macOS Bundle Script
# Creates a signed, notarized .app bundle and DMG for distribution

APP_NAME="Onyx"
BUNDLE_ID="com.openagents.onyx"

# Code signing identity (must match your Apple Developer certificate)
# Set via environment or use default
IDENTITY="${MACOS_SIGNING_IDENTITY:-OpenAgents Inc}"

# Parse arguments
BUILD_TYPE="release"
SIGN_APP=false
INSTALL_APP=false
CREATE_DMG=false
NOTARIZE=false
OPEN_RESULT=false

help_info() {
    echo "
Usage: ${0##*/} [OPTIONS]

Build and optionally sign/notarize the Onyx macOS application.

Options:
  -d, --debug      Build debug version (skips DMG/notarization)
  -s, --sign       Sign the app with Developer ID certificate
  -i, --install    Install to /Applications after building
  -m, --dmg        Create DMG disk image
  -n, --notarize   Notarize with Apple (requires --sign and --dmg)
  -o, --open       Open result after building
  -h, --help       Show this help

Environment variables for code signing:
  MACOS_SIGNING_IDENTITY    Signing identity name (default: 'OpenAgents Inc')
  MACOS_CERTIFICATE         Base64-encoded .p12 certificate
  MACOS_CERTIFICATE_PASSWORD Certificate password

Environment variables for notarization:
  APPLE_NOTARIZATION_KEY        App Store Connect API key (.p8 content)
  APPLE_NOTARIZATION_KEY_ID     API key ID
  APPLE_NOTARIZATION_ISSUER_ID  App Store Connect issuer UUID

Examples:
  # Local development (ad-hoc signed)
  ./script/bundle-mac --sign --install

  # Release build with DMG
  ./script/bundle-mac --sign --dmg

  # Full release with notarization
  ./script/bundle-mac --sign --dmg --notarize
"
}

while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--debug) BUILD_TYPE="debug"; shift ;;
        -s|--sign) SIGN_APP=true; shift ;;
        -i|--install) INSTALL_APP=true; shift ;;
        -m|--dmg) CREATE_DMG=true; shift ;;
        -n|--notarize) NOTARIZE=true; shift ;;
        -o|--open) OPEN_RESULT=true; shift ;;
        -h|--help) help_info; exit 0 ;;
        *) echo "Unknown option: $1"; help_info; exit 1 ;;
    esac
done

# Notarization requires signing and DMG
if [ "$NOTARIZE" = true ]; then
    if [ "$SIGN_APP" = false ] || [ "$CREATE_DMG" = false ]; then
        echo "Error: --notarize requires both --sign and --dmg"
        exit 1
    fi
fi

echo "=== Building ${APP_NAME} (${BUILD_TYPE}) ==="

# Get the repo root
REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$REPO_ROOT"

# Determine architecture
arch=$(uname -m)
if [[ "$arch" == "arm64" ]]; then
    target_triple="aarch64-apple-darwin"
    arch_suffix="aarch64"
elif [[ "$arch" == "x86_64" ]]; then
    target_triple="x86_64-apple-darwin"
    arch_suffix="x86_64"
else
    echo "Unsupported architecture: $arch"
    exit 1
fi

# Check for cargo-bundle
cargo_bundle_version=$(cargo -q bundle --help 2>&1 | head -n 1 || echo "")
if [ "$cargo_bundle_version" != "cargo-bundle v0.6.1-zed" ]; then
    echo "Installing cargo-bundle..."
    cargo install cargo-bundle --git https://github.com/zed-industries/cargo-bundle.git --branch zed-deploy
fi

# Check for app icons
ICON_PATH="crates/onyx/resources/app-icon.png"
if [ ! -f "$ICON_PATH" ]; then
    echo ""
    echo "Warning: App icon not found at $ICON_PATH"
    echo "Creating placeholder icon..."

    mkdir -p crates/onyx/resources

    cat > /tmp/onyx-icon.svg << 'SVGEOF'
<svg width="1024" height="1024" xmlns="http://www.w3.org/2000/svg">
  <rect width="1024" height="1024" fill="#1a1a1a"/>
  <text x="512" y="680" font-family="Helvetica" font-size="600" fill="#00ff88" text-anchor="middle">O</text>
</svg>
SVGEOF

    if command -v rsvg-convert &>/dev/null; then
        rsvg-convert -w 1024 -h 1024 /tmp/onyx-icon.svg > crates/onyx/resources/app-icon@2x.png
        rsvg-convert -w 512 -h 512 /tmp/onyx-icon.svg > crates/onyx/resources/app-icon.png
    elif command -v convert &>/dev/null; then
        convert /tmp/onyx-icon.svg -resize 1024x1024 crates/onyx/resources/app-icon@2x.png
        convert /tmp/onyx-icon.svg -resize 512x512 crates/onyx/resources/app-icon.png
    else
        echo "Warning: No SVG converter found. Continuing without icons..."
    fi
    rm -f /tmp/onyx-icon.svg
fi

# Setup keychain for code signing (if certificate provided)
can_code_sign=false
cleanup_keychain=false

if [ "$SIGN_APP" = true ]; then
    if [[ -n "${MACOS_CERTIFICATE:-}" && -n "${MACOS_CERTIFICATE_PASSWORD:-}" ]]; then
        echo "Setting up keychain for code signing..."

        # Create temporary keychain
        security create-keychain -p "$MACOS_CERTIFICATE_PASSWORD" onyx.keychain 2>/dev/null || true
        security default-keychain -s onyx.keychain
        security unlock-keychain -p "$MACOS_CERTIFICATE_PASSWORD" onyx.keychain
        security set-keychain-settings onyx.keychain

        # Import certificate
        echo "$MACOS_CERTIFICATE" | base64 --decode > /tmp/onyx-certificate.p12
        security import /tmp/onyx-certificate.p12 -k onyx.keychain -P "$MACOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
        rm /tmp/onyx-certificate.p12
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$MACOS_CERTIFICATE_PASSWORD" onyx.keychain

        can_code_sign=true
        cleanup_keychain=true

        function cleanup() {
            if [ "$cleanup_keychain" = true ]; then
                echo "Cleaning up keychain..."
                security default-keychain -s login.keychain
                security delete-keychain onyx.keychain 2>/dev/null || true
            fi
        }
        trap cleanup EXIT
    else
        echo "No certificate provided. Will use ad-hoc signing."
    fi
fi

# Build
echo ""
echo "Building Onyx..."
if [ "$BUILD_TYPE" = "release" ]; then
    cargo build --release -p onyx --target "$target_triple"
else
    cargo build -p onyx --target "$target_triple"
fi

# Bundle (cargo-bundle must run from the crate directory)
echo ""
echo "Creating app bundle..."
pushd "${REPO_ROOT}/crates/onyx" > /dev/null
if [ "$BUILD_TYPE" = "release" ]; then
    app_path=$(cargo bundle --release --target "$target_triple" | tail -1 | xargs)
else
    app_path=$(cargo bundle --target "$target_triple" | tail -1 | xargs)
fi
popd > /dev/null

# Locate the bundle (cargo bundle outputs full path)
if [[ ! "$app_path" == /* ]]; then
    # If not absolute, construct it
    if [ "$BUILD_TYPE" = "release" ]; then
        app_path="${REPO_ROOT}/target/${target_triple}/release/bundle/osx/${APP_NAME}.app"
    else
        app_path="${REPO_ROOT}/target/${target_triple}/debug/bundle/osx/${APP_NAME}.app"
    fi
fi

if [ ! -d "$app_path" ]; then
    echo "Error: Bundle not found at $app_path"
    exit 1
fi

echo "Bundle created at: $app_path"

# Code sign
if [ "$SIGN_APP" = true ]; then
    echo ""
    echo "Code signing..."

    ENTITLEMENTS="${REPO_ROOT}/crates/onyx/resources/onyx.entitlements"

    if [ "$can_code_sign" = true ]; then
        echo "Signing with Developer ID: $IDENTITY"

        # Sign the main binary with entitlements
        /usr/bin/codesign --force --timestamp --options runtime \
            --entitlements "$ENTITLEMENTS" \
            --sign "$IDENTITY" \
            "${app_path}/Contents/MacOS/onyx" -v

        # Sign the entire app bundle
        /usr/bin/codesign --force --timestamp --options runtime \
            --entitlements "$ENTITLEMENTS" \
            --sign "$IDENTITY" \
            "${app_path}" -v

        echo "Signed with Developer ID"
    else
        echo "Signing with ad-hoc signature..."

        # Ad-hoc signing (for local testing)
        /usr/bin/codesign --force --deep --timestamp --options runtime \
            --entitlements "$ENTITLEMENTS" \
            --sign - "${app_path}" -v

        echo "Signed with ad-hoc signature"
    fi

    # Verify signature
    echo "Verifying signature..."
    codesign --verify --verbose=2 "${app_path}"
fi

# Create DMG
dmg_file_path=""
if [ "$CREATE_DMG" = true ] && [ "$BUILD_TYPE" = "release" ]; then
    echo ""
    echo "Creating DMG..."

    dmg_target_directory="${REPO_ROOT}/target/${target_triple}/release"
    dmg_source_directory="${dmg_target_directory}/dmg"
    dmg_file_path="${dmg_target_directory}/${APP_NAME}-${arch_suffix}.dmg"

    # Clean and create DMG source directory
    rm -rf "${dmg_source_directory}"
    mkdir -p "${dmg_source_directory}"

    # Copy app to DMG source
    cp -r "${app_path}" "${dmg_source_directory}/"

    # Add symlink to /Applications
    ln -s /Applications "${dmg_source_directory}/Applications"

    # Create DMG
    rm -f "${dmg_file_path}"
    hdiutil create -volname "${APP_NAME}" \
        -srcfolder "${dmg_source_directory}" \
        -ov -format UDZO \
        "${dmg_file_path}"

    # Clean up symlink (can cause issues if codebase is opened in Onyx)
    rm "${dmg_source_directory}/Applications"

    echo "DMG created at: ${dmg_file_path}"

    # Sign DMG
    if [ "$SIGN_APP" = true ] && [ "$can_code_sign" = true ]; then
        echo "Signing DMG..."
        /usr/bin/codesign --force --timestamp --options runtime \
            --sign "$IDENTITY" \
            "${dmg_file_path}" -v
    fi
fi

# Notarize
if [ "$NOTARIZE" = true ] && [ -n "$dmg_file_path" ]; then
    if [[ -n "${APPLE_NOTARIZATION_KEY:-}" && -n "${APPLE_NOTARIZATION_KEY_ID:-}" && -n "${APPLE_NOTARIZATION_ISSUER_ID:-}" ]]; then
        echo ""
        echo "Notarizing with Apple..."

        xcode_bin_dir="$(xcode-select -p)/usr/bin"
        notarization_key_file=$(mktemp)

        # Write API key to temp file
        echo "$APPLE_NOTARIZATION_KEY" > "$notarization_key_file"

        # Submit for notarization
        "${xcode_bin_dir}/notarytool" submit --wait \
            --key "$notarization_key_file" \
            --key-id "$APPLE_NOTARIZATION_KEY_ID" \
            --issuer "$APPLE_NOTARIZATION_ISSUER_ID" \
            "${dmg_file_path}"

        rm "$notarization_key_file"

        # Staple the ticket
        echo "Stapling notarization ticket..."
        "${xcode_bin_dir}/stapler" staple "${dmg_file_path}"

        echo "Notarization complete!"
    else
        echo ""
        echo "Warning: Notarization requested but missing environment variables:"
        echo "  APPLE_NOTARIZATION_KEY"
        echo "  APPLE_NOTARIZATION_KEY_ID"
        echo "  APPLE_NOTARIZATION_ISSUER_ID"
        echo "Skipping notarization."
    fi
fi

# Install
if [ "$INSTALL_APP" = true ]; then
    echo ""
    echo "Installing to /Applications..."
    rm -rf "/Applications/${APP_NAME}.app"
    cp -r "$app_path" /Applications/
    # Clear quarantine flag
    xattr -cr "/Applications/${APP_NAME}.app" 2>/dev/null || true
    echo "Installed to /Applications/${APP_NAME}.app"
fi

# Open result
if [ "$OPEN_RESULT" = true ]; then
    if [ "$INSTALL_APP" = true ]; then
        open "/Applications/${APP_NAME}.app"
    elif [ -n "$dmg_file_path" ] && [ -f "$dmg_file_path" ]; then
        open "$(dirname "$dmg_file_path")"
    else
        open "$app_path"
    fi
fi

echo ""
echo "=== Done ==="
echo ""
echo "Bundle: $app_path"
if [ -n "$dmg_file_path" ] && [ -f "$dmg_file_path" ]; then
    echo "DMG: $dmg_file_path"
fi
if [ "$INSTALL_APP" = false ]; then
    echo ""
    echo "To install manually:"
    echo "  cp -r \"$app_path\" /Applications/"
    echo "  xattr -cr /Applications/${APP_NAME}.app"
fi
