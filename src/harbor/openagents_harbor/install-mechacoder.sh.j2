#!/bin/bash
# Install MechaCoder for Harbor/Terminal-Bench evaluation
set -e

echo "=== Installing MechaCoder ==="

# Update package lists
apt-get update
apt-get install -y curl git unzip npm

# Install Bun runtime
echo "Installing Bun..."
curl -fsSL https://bun.sh/install | bash
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"

# Verify Bun installation
bun --version

# Install Claude Code CLI (required by Claude Agent SDK)
echo "Installing Claude Code CLI..."
npm install -g @anthropic-ai/claude-code
# Add npm global bin to PATH
export PATH="$(npm bin -g):$PATH"
echo "PATH=$PATH" >> /etc/environment
echo 'export PATH="$(npm bin -g):$PATH"' >> /root/.bashrc
claude --version || echo "Claude Code installed"

# Configure API key helper for non-interactive mode
# This is a workaround for Claude Code's authentication in headless mode
# See: https://github.com/anthropics/claude-code/issues/551
echo "Configuring Claude Code API key helper..."
mkdir -p /root/.claude
cat > /root/.claude/api_key_helper.sh << 'KEYHELPER'
#!/bin/bash
echo "${ANTHROPIC_API_KEY}"
KEYHELPER
chmod +x /root/.claude/api_key_helper.sh
claude config set --global apiKeyHelper /root/.claude/api_key_helper.sh || echo "API key helper configured"

# Clone MechaCoder (OpenAgents)
echo "Cloning MechaCoder..."
{% if version %}
git clone --branch {{ version }} --depth 1 https://github.com/OpenAgentsInc/openagents.git /opt/mechacoder
{% else %}
git clone --depth 1 https://github.com/OpenAgentsInc/openagents.git /opt/mechacoder
{% endif %}

# Install dependencies
echo "Installing dependencies..."
cd /opt/mechacoder
bun install

# Verify installation
echo "Verifying installation..."
bun src/cli/tbench.ts --help

echo "=== MechaCoder installation complete ==="
